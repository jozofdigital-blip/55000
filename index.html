<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>500 –∑–ª–æ–±–Ω—ã—Ö –∫–∞—Ä—Ç ‚Äî –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä (–æ–¥–∏–Ω HTML)</title>
  <style>
    :root {
      --bg:#0f1115;
      --panel:#151823;
      --panel-soft:rgba(21,24,35,0.75);
      --muted:#8b93a7;
      --text:#e6e9f2;
      --accent:#7c5cff;
      --accent-2:#25d0a2;
      --danger:#ff5c7c;
      --card:#1b2030;
      --chip:#20263a;
      --border:#2a3248;
      --shadow:0 14px 34px rgba(0,0,0,.35);
      --focus:ring:0 0 0 3px rgba(124,92,255,.35);
      --safe-bottom:env(safe-area-inset-bottom);
    }
    *{box-sizing:border-box}

    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,"Noto Sans","Helvetica Neue",Arial;
      background:radial-gradient(circle at 20% -10%,rgba(124,92,255,.25),transparent 55%),
                 radial-gradient(circle at 80% -10%,rgba(37,208,162,.18),transparent 60%),
                 #0c0f16;
      color:var(--text);
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{max-width:1080px;margin:0 auto;padding:20px 20px 120px;position:relative}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:10px 0 8px;flex-wrap:wrap}
    .logo{font-weight:800;letter-spacing:.3px;font-size:20px;display:flex;align-items:center;gap:10px}
    .logo b{display:inline-block;background:linear-gradient(135deg,var(--accent),#b28dff);-webkit-background-clip:text;background-clip:text;color:transparent}
    .bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    button,.btn{
      background:var(--accent);
      color:#fff;
      border:none;
      padding:11px 16px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      box-shadow:var(--shadow);
      transition:transform .15s ease,filter .2s ease,box-shadow .2s ease;
      position:relative;
    }
    button:disabled{opacity:.55;cursor:not-allowed;box-shadow:none;transform:none;filter:none}
    button.ghost,.btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text);box-shadow:none}
    button.linky{background:transparent;border:none;color:#b7c1ff;padding:8px 4px;box-shadow:none}
    button:hover:not(:disabled){transform:translateY(-1px);filter:saturate(1.1)}
    button:focus-visible{outline:none;box-shadow:var(--focus:ring)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:18px}
    .panel{grid-column:span 12;background:var(--panel);border:1px solid var(--border);border-radius:22px;padding:18px;box-shadow:var(--shadow);backdrop-filter:blur(6px)}
    @media(min-width:900px){.panel.split{grid-column:span 8}.panel.side{grid-column:span 4;position:sticky;top:12px;align-self:start}}
    h1,h2,h3{margin:8px 0 10px;font-size:18px}
    h1{font-size:24px;margin-bottom:16px}
    h3{font-size:16px;color:var(--muted);font-weight:700}
    p{margin:0 0 12px}
    .muted{color:var(--muted)}
    .small{font-size:12px;opacity:.8}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--border);padding:8px 11px;border-radius:999px;color:#cfd5e6;font-weight:700;display:inline-flex;align-items:center;gap:6px;transition:background .2s ease,color .2s ease}
    .chip.alert{border-color:rgba(255,92,124,.45);color:#ffc0d0}
    .card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:16px;line-height:1.5;box-shadow:0 10px 24px rgba(0,0,0,.25);transition:transform .2s ease,box-shadow .2s ease,outline .2s ease}
    .card.black-card{background:#050608;border-color:#1f2536;color:#fff}
    .card.black-card .muted{color:rgba(255,255,255,.65)}
    .card.selectable{cursor:pointer}
    .card.selectable:hover:not(.disabled){transform:translateY(-2px);box-shadow:0 16px 30px rgba(0,0,0,.35)}
    .card.selected{outline:2px solid var(--accent);box-shadow:0 0 0 3px rgba(124,92,255,.35),0 16px 30px rgba(0,0,0,.4);transform:translateY(-3px)}
    .card.disabled{opacity:.55;pointer-events:none}
    .card.readonly{pointer-events:none}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:14px}
    .winner{background:linear-gradient(135deg,rgba(37,208,162,.2),rgba(124,92,255,.2));border-color:#39456b}
    .scroll{max-height:280px;overflow:auto;padding-right:6px}
    .scroll::-webkit-scrollbar{width:6px}
    .scroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:999px}
    .hr{height:1px;background:var(--border);margin:14px 0}
    input[type="text"],textarea{
      width:100%;
      background:rgba(32,38,58,.65);      border:1px solid var(--border);
      color:var(--text);
      padding:11px 14px;
      border-radius:14px;
      outline:none;
      transition:border .2s ease,box-shadow .2s ease;
    }
    input[type="text"]:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,92,255,.25)}
    label{display:flex;align-items:center;gap:8px}
    dialog{border:none;border-radius:22px;padding:0;background:rgba(15,17,21,.92);color:var(--text);box-shadow:0 24px 60px rgba(0,0,0,.45)}
    dialog::backdrop{background:rgba(6,8,12,.7)}
    dialog form{padding:22px;max-height:80vh;overflow:auto}
    menu{margin:0;padding:0}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(16px + var(--safe-bottom));background:var(--panel-soft);border:1px solid var(--border);padding:12px 16px;border-radius:16px;box-shadow:var(--shadow);min-width:220px;text-align:center;font-weight:600;opacity:0;pointer-events:none;transition:opacity .2s ease,transform .25s ease}
    .toast.show{opacity:1;pointer-events:auto;transform:translate(-50%, -6px)}
    .pill{display:inline-flex;align-items:center;gap:6px}
    #actionBar{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:calc(12px + var(--safe-bottom));
      width:min(560px,calc(100vw - 24px));
      background:rgba(18,20,30,.95);
      border:1px solid rgba(76,85,115,.5);
      border-radius:18px;
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      box-shadow:0 24px 60px rgba(0,0,0,.45);
      z-index:20;
      transition:transform .25s ease,opacity .2s ease;
    }
    #actionBar.hidden{opacity:0;pointer-events:none;transform:translate(-50%, 40px)}
    #actionHint{font-size:14px;color:rgba(226,231,240,.9);line-height:1.35}
    #btnConfirm{flex-shrink:0}
    .action-icon{font-size:18px}
    .floating-cta{display:flex;align-items:center;gap:8px}
    .status-live{min-height:22px}
    .fade-in{animation:fade .25s ease both}
    .list-enter{animation:listEnter .3s ease both}
    @keyframes fade{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:none;}}
    @keyframes listEnter{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:none;}}
    @media(max-width:600px){
      .wrap{padding:14px 12px 140px}
      header{gap:8px}
      .logo{font-size:18px}
      .bar{gap:6px;width:100%;justify-content:flex-start}
      button,.btn{padding:12px 16px;border-radius:16px;font-size:16px}
      .panel{padding:14px;border-radius:18px}
      .cards{grid-template-columns:1fr}
      .card{padding:16px;font-size:18px}
      .big{font-size:18px}
      .chips{gap:6px}
      .chip{padding:7px 10px;font-size:13px}
      #playersList .kicker{padding:10px 0}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">üÉè <b>500 –∑–ª. –∫–∞—Ä—Ç</b> ‚Äî –æ–Ω–ª–∞–π–Ω</div>
      <div class="bar">
        <span id="connStatus" class="chip" title="–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è">–°—Ç–∞—Ç—É—Å: –Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ</span>
        <span id="timerChip" class="chip hidden" aria-live="polite">‚è± 60s</span>
        <button class="ghost" id="btnCheck">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
        <button class="ghost" id="btnDeck">–ö–æ–ª–æ–¥–∞</button>
        <button class="ghost" id="btnHow">–ü—Ä–∞–≤–∏–ª–∞</button>
        <button class="ghost" id="btnTests">üß™ –¢–µ—Å—Ç—ã</button>
        <button id="btnNew">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
      </div>
    </header>

    <div class="grid" id="screenLobby">
      <section class="panel">
        <h1>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ</h1>
        <p class="muted">1) –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä —Å–æ–∑–¥–∞—ë—Ç –∫–æ–º–Ω–∞—Ç—É –∏ –¥–µ–ª–∏—Ç—Å—è —Å—Å—ã–ª–∫–æ–π. 2) –ò–≥—Ä–æ–∫–∏ –≤–≤–æ–¥—è—Ç –∏–º—è, –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è –∏ –∂–¥—É—Ç —Å—Ç–∞—Ä—Ç–∞. 3) –í –∫–∞–∂–¥–æ–º —Ä–∞—É–Ω–¥–µ –Ω–æ–≤—ã–π –≤–µ–¥—É—â–∏–π –≤—ã–±–∏—Ä–∞–µ—Ç –ø–æ–±–µ–¥–∏—Ç–µ–ª—è.</p>
        <div class="row">
          <button id="btnCreate">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
          <input type="text" id="roomInput" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, ABC123)" style="max-width:220px" autocomplete="off">
          <button class="ghost" id="btnJoin">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </div>
        <div class="hr"></div>
        <div class="row">
          <input type="text" id="playerName" placeholder="–í–∞—à–µ –∏–º—è" style="max-width:240px" maxlength="24" autocomplete="name" aria-label="–ò–º—è –∏–≥—Ä–æ–∫–∞">
          <label><input type="checkbox" id="sfwOnly" checked> –¢–æ–ª—å–∫–æ SFW</label>
        </div>
        <div id="lobbyError" class="muted" style="color:#ff9cae;margin-top:6px;min-height:20px" aria-live="assertive"></div>
        <p class="small muted">–°—Å—ã–ª–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã. –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –∏ –¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π —Å –¥—Ä—É–∑—å—è–º–∏.</p>
        <div class="row" id="shareRow" style="margin-top:10px; display:none;">
          <input type="text" id="shareLink" readonly aria-label="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–º–Ω–∞—Ç—É">
          <button class="ghost" id="btnCopy">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
        </div>
        <div class="row" id="lobbyActions" style="margin-top:14px;display:none;">
          <button id="btnStartGame">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä—É</button>
          <span class="muted small" id="startHint"></span>
        </div>
        <div id="lobbyInfo" class="muted" style="margin-top:12px;" aria-live="polite"></div>
      </section>
    </div>

    <div class="grid hidden" id="screenGame">
      <section class="panel split">
        <div class="kicker">
          <div>
            <div class="muted small">–ö–æ–º–Ω–∞—Ç–∞: <span id="roomIdLabel">‚Äî</span></div>
            <div class="muted small">–†–∞—É–Ω–¥ <span id="roundN">0</span>/<span id="roundTotal">10</span></div>
            <div class="status-live" aria-live="polite">–í–µ–¥—É—â–∏–π: <b id="hostName">‚Äî</b></div>
          </div>
          <div class="chips">
            <span class="chip" id="statusHint">–§–∞–∑–∞: ‚Äî</span>
            <span class="chip hidden" id="progressChip">0/0 –æ—Ç–ø—Ä–∞–≤–∏–ª–∏</span>
            <span class="chip hidden" id="roleChip">‚Äî</span>
          </div>
        </div>

        <div class="card black-card" style="margin-top:14px;">
          <div class="muted small">–ß—ë—Ä–Ω–∞—è –∫–∞—Ä—Ç–∞</div>
          <div id="blackText" class="big" style="margin-top:6px;" aria-live="polite">‚Äî</div>
        </div>

        <div id="handSection" style="margin-top:16px;">
          <h3>–í–∞—à–∏ –∫–∞—Ä—Ç—ã</h3>
          <div class="muted small" id="selectionHint">–û–∂–∏–¥–∞–µ–º —Å—Ç–∞—Ä—Ç —Ä–∞—É–Ω–¥–∞.</div>
          <div class="cards" id="handCards" style="margin-top:12px;"></div>
          <div class="card hidden fade-in" id="submittedCard" style="margin-top:14px;">
            <div class="muted small">–í—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏</div>
            <div class="big" id="submittedCardText" style="margin-top:8px;">‚Äî</div>
          </div>
        </div>

        <div id="submissionsPanel" style="margin-top:18px;">
          <h3>–û—Ç–≤–µ—Ç—ã –Ω–∞ —Å—Ç–æ–ª–µ</h3>
          <div class="muted small" id="hostHint" aria-live="polite">–ñ–¥—ë–º –Ω–∞—á–∞–ª–∞ —Ä–∞—É–Ω–¥–∞.</div>
          <div class="cards" id="submissions" style="margin-top:12px;"></div>
        </div>

        <div id="resultPanel" class="hidden" style="margin-top:18px;">
          <div class="card winner">
            <div class="muted small">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å —Ä–∞—É–Ω–¥–∞</div>
            <div class="big" id="winnerLine" style="margin-top:8px;">‚Äî</div>
            <div class="row" style="margin-top:12px;">
              <button id="nextRound">–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥</button>
              <span class="muted small" id="resultHint"></span>
            </div>
          </div>
        </div>
      </section>

      <aside class="panel side">
        <h2>–ò–≥—Ä–æ–∫–∏</h2>
        <div id="playersList" class="scroll" aria-live="polite"></div>
        <div class="hr"></div>
        <div class="row">
          <span class="small muted">–ö–∞–∂–¥—ã–π —Ä–∞—É–Ω–¥ –Ω–æ–≤—ã–º –≤–µ–¥—É—â–∏–º —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–π –∏–≥—Ä–æ–∫ –ø–æ –æ—á–µ—Ä–µ–¥–∏.</span>
        </div>
      </aside>
    </div>
  </div>

  <div id="actionBar" class="hidden" role="status" aria-live="polite">
    <div id="actionHint">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É, –∑–∞—Ç–µ–º –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ.</div>
    <button id="btnConfirm" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <dialog id="dlgRules">
    <form method="dialog">
      <h2>–ü—Ä–∞–≤–∏–ª–∞ (–∫–æ—Ä–æ—Ç–∫–æ)</h2>
      <ol class="muted" style="line-height:1.6;">
        <li>–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä —Å–æ–∑–¥–∞—ë—Ç –∫–æ–º–Ω–∞—Ç—É –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É.</li>
        <li>–ò–≥—Ä–æ–∫–∏ –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è, —É –∫–∞–∂–¥–æ–≥–æ 7 –±–µ–ª—ã—Ö –∫–∞—Ä—Ç.</li>
        <li>–í –∫–∞–∂–¥–æ–º —Ä–∞—É–Ω–¥–µ –æ–¥–∏–Ω –∏–≥—Ä–æ–∫ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤–µ–¥—É—â–∏–º ‚Äî –∫–∞—Ä—Ç—ã –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –∏ –≤—ã–±–∏—Ä–∞–µ—Ç –ø–æ–±–µ–¥–∏—Ç–µ–ª—è.</li>
        <li>–û—Ç–≤–µ—Ç—ã –≤–∏–¥—è—Ç –≤—Å–µ, –∏–º–µ–Ω–∞ –∞–≤—Ç–æ—Ä–æ–≤ —Å–∫—Ä—ã—Ç—ã –¥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è.</li>
        <li>–ü–æ–±–µ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç 1 –æ—á–∫–æ, —Ä–∞—É–Ω–¥ –¥–ª–∏—Ç—Å—è 60 —Å–µ–∫—É–Ω–¥.</li>
      </ol>
      <menu class="row" style="justify-content:flex-end; margin-top:12px;">
        <button class="ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
      </menu>
    </form>
  </dialog>

  <dialog id="dlgDeck">
    <form method="dialog">
      <h2>–ö–æ–ª–æ–¥–∞</h2>
      <p class="muted">–†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ JSON –≤ —Ñ–æ—Ä–º–∞—Ç–µ <span class="mono">{"black":[],"white":[],"nsfwBlack":[],"nsfwWhite":[]}</span>. –ú–∏–Ω–∏–º—É–º 120 —á—ë—Ä–Ω—ã—Ö –∏ 500 –±–µ–ª—ã—Ö –∫–∞—Ä—Ç.</p>
      <textarea id="deckJson" rows="12"></textarea>
      <div class="row" style="justify-content:space-between;margin-top:14px;">
        <div class="row">
          <button type="button" class="ghost" id="btnImport">–ò–º–ø–æ—Ä—Ç JSON‚Ä¶</button>
          <button type="button" class="ghost" id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
          <button type="button" class="ghost" id="btnResetDeck">–°–±—Ä–æ—Å–∏—Ç—å –∫ –¥–µ–º–æ</button>
        </div>
        <menu class="row">
          <button class="ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
          <button type="button" id="btnSaveDeck">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </menu>
      </div>
    </form>
  </dialog>

  <dialog id="dlgTests">
    <form method="dialog">
      <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</h2>
      <div id="testsOutput" class="mono small" style="white-space:pre-wrap"></div>
      <menu class="row" style="justify-content:flex-end; margin-top:12px;">
        <button class="ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
      </menu>
    </form>
  </dialog>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
  // ===== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã =====
  const STATUS = { LOBBY:'lobby', COLLECT:'collect', RESULT:'result' };
  const ROUND_SECONDS = 60;
  const STORAGE_KEY = 'zlobnye_karty_deck_v1';
  const EVENTS_PATH = 'events';

  // ===== –£—Ç–∏–ª–∏—Ç—ã =====
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));
  const uid = ()=>Math.random().toString(36).slice(2,10);
  const shuffle = (arr)=>{ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; };
  const now = ()=>Date.now();
  const escapeHtml = (str)=>{ const map={ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }; return String(str||'').replace(/[&<>"']/g,ch=>map[ch]); };
  const fillBlack = (black, white)=>{
    const cleanWhite = escapeHtml(white||'‚Äî');
    if ((black||'').includes('____')){ return (black||'‚Äî').replace('____', `<b>${cleanWhite}</b>`); }
    return `${escapeHtml(black||'‚Äî')} ‚Äî <b>${cleanWhite}</b>`;
  };
  const copyToClipboard = async (text)=>{ try{ await navigator.clipboard.writeText(text); toast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'); }catch(e){ showError(e); } };

  // ===== Toast & –æ—à–∏–±–∫–∏ =====
  let toastTimer=null;
  function toast(msg){ const el=$('#toast'); if(!el) return; el.textContent=msg; el.classList.add('show'); clearTimeout(toastTimer); toastTimer=setTimeout(()=>el.classList.remove('show'),2400); }
  function normalizeError(err){ if(!err) return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'; if(typeof err==='string') return err; const code=err.code||''; if(code.includes('permission')) return '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–∏.'; if(code.includes('network')) return '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Firebase.'; if(code.includes('timeout')) return '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è Firebase.'; if(code.includes('auth')) return '–ü—Ä–æ–±–ª–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Firebase.'; return err.message||'–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫.'; }
  function showError(err){ console.error(err); toast('–û—à–∏–±–∫–∞: ' + normalizeError(err)); }

  // ===== –ö–æ–ª–æ–¥–∞ =====
  const DEMO_DECK = { black:[
    "–õ—É—á—à–µ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ –æ—Ç –ø–ª–æ—Ö–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è ‚Äî ____.",
    "–í –æ—Ñ–∏—Å–µ –∑–∞–ø—Ä–µ—Ç–∏–ª–∏ ____ –ø–æ—Å–ª–µ –ø—Ä–æ—à–ª–æ–π –≤–µ—á–µ—Ä–∏–Ω–∫–∏.",
    "–ú–æ–π —Ç–∞–π–Ω—ã–π —Ç–∞–ª–∞–Ω—Ç ‚Äî ____.",
    "–ö–æ–º–±–æ –¥–Ω—è: ____ —Å —Å–æ—É—Å–æ–º –∏–∑ ____.",
    "–ù–∞ –ø–µ—Ä–≤–æ–º —Å–≤–∏–¥–∞–Ω–∏–∏ –Ω–µ —Å–æ–≤–µ—Ç—É—é –æ–±—Å—É–∂–¥–∞—Ç—å ____.",
    "–£—á–µ–Ω—ã–µ –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ –ø—Ä–∏–¥—É–º–∞–ª–∏ ____.",
    "–°–∞–º–æ–µ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ –≤ –ø–æ–¥–∞—Ä–æ–∫ ‚Äî ____.",
    "–ù–æ–≤–æ–µ —Ö–æ–±–±–∏, –æ –∫–æ—Ç–æ—Ä–æ–º —Å—Ç—ã–¥–Ω–æ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è–º: ____.",
    "–ó–∞–≤—Ç—Ä–∞–∫ —á–µ–º–ø–∏–æ–Ω–∞ ‚Äî ____.",
    "–ü—É—Ç—å –∫ —É—Å–ø–µ—Ö—É –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å ____.",
  ], white:[
    "–π–æ–≥–∞ –ø—Ä–∏ —Å–≤–µ—Ç–µ –ª–∞–º–ø—ã","–±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ –º–µ–º—ã","–∫–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å—É–¥–∏—Ç —Ç–µ–±—è","–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ 200 —Å–ª–∞–π–¥–æ–≤","–∑–≤—É–∫–∏ –ª–µ—Å–∞ –≤ 3 —á–∞—Å–∞ –Ω–æ—á–∏","–º–∏–∫—Ä–æ–¥–æ–∑—ã —ç–Ω—Ç—É–∑–∏–∞–∑–º–∞","–µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫ –Ω–∞ 2035 –≥–æ–¥","–∫–æ—Ñ–µ —É—Ä–æ–≤–Ω—è –±–æ—Å—Å","—Ç–∞–Ω–µ—Ü —Å –ø—ã–ª–µ—Å–æ—Å–æ–º","—Å—Ä–æ—á–Ω—ã–π —Å–æ–∑–≤–æ–Ω –Ω–∏ –æ —á–µ–º","–ø–µ—Ä–µ–ø–∏—Å–∫–∞ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π","–∑–∞—Ä—è–¥–∫–∞ –¥–ª—è –ª–∏—Ü–∞ –∏ —Å–æ–≤–µ—Å—Ç–∏","–ø–æ–¥–∫–∞—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–∏–∫—Ç–æ –Ω–µ —Å–ª—É—à–∞–µ—Ç","–∫–æ–ª–ª–µ–∫—Ü–∏—è –Ω–µ—Å–±—ã–≤—à–∏—Ö—Å—è —Ü–µ–ª–µ–π","–ø–ª–µ–¥ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏","—É–¥–∞–ª–µ–Ω–Ω–∞—è –ø—è—Ç–Ω–∏—Ü–∞","–∑–∞–≥–∞–¥–æ—á–Ω—ã–π –¥–µ–¥–ª–∞–π–Ω","–Ω–æ—á–Ω–æ–π –ø–æ—Ö–æ–¥ –≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫","—Ç–∏–∫-—Ç–æ–∫ –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö ‚Äî —á—Ç–µ–Ω–∏–µ","—Å–ª—É—á–∞–π–Ω—ã–π –∞–∫—Ç –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"
  ], nsfwBlack:[], nsfwWhite:[] };

  function ensureMinimumDeck(base){
    const MIN_BLACK = 120; const MIN_WHITE = 500;
    const adj=["–±–µ—Å–∫–æ–º–ø—Ä–æ–º–∏—Å—Å–Ω—ã–π","–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π","—Å–∫—Ä–æ–º–Ω—ã–π","—Ö—Ä—É–ø–∫–∏–π","—Å—Ç–∞–ª—å–Ω–æ–π","–º—è–≥–∫–∏–π","–Ω–µ—É–¥–æ–±–Ω—ã–π","—É–¥–∏–≤–∏—Ç–µ–ª—å–Ω—ã–π","–∫–æ—Å–º–∏—á–µ—Å–∫–∏–π","—Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–π","–Ω—É–ª–µ–≤–æ–π","—Å–ª—É—á–∞–π–Ω—ã–π","–¥–æ–º–∞—à–Ω–∏–π","—Ç—É—Ä–±–æ","–∞–Ω—Ç–∏—Å—Ç—Ä–µ—Å—Å","—á–∏—Å—Ç–æ—Å–µ—Ä–¥–µ—á–Ω—ã–π","–±–æ—Ç–∞–Ω—Å–∫–∏–π","–∫–∞—Ä–º–∞–Ω–Ω—ã–π","–ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π","–≥—Ä—É—Å—Ç–Ω—ã–π","–≥–µ—Ä–æ–∏—á–µ—Å–∫–∏–π","–≤–∏–Ω–æ–≤–∞—Ç—ã–π","—Å—Ç—Ä–∞–Ω–Ω—ã–π","–ø–∞–Ω–∏—á–µ—Å–∫–∏–π","–æ—Å–æ–∑–Ω–∞–Ω–Ω—ã–π","–≤–∞—Ñ–µ–ª—å–Ω—ã–π","—ç–∫–æ–ª–æ–≥–∏—á–Ω—ã–π","—É–º–Ω—ã–π","—Å–≤–µ—Ä—Ö–≤–∞–∂–Ω—ã–π","–Ω–µ–æ–±—ä—è—Å–Ω–∏–º—ã–π"];
    const noun=["–∫–∞–∫—Ç—É—Å","–µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫","–∫–µ–∫—Å","–ø–ª–µ–¥","—Ä–∏–º–µ–π–∫ –¥–µ—Ç—Å—Ç–≤–∞","–∫–æ—Ç –≤ –∫–æ—Ä–æ–±–∫–µ","—Ç–∞–Ω–µ—Ü –ø–æ–±–µ–¥–∏—Ç–µ–ª—è","—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–∏—Ç—É–∞–ª","–ø–ª–∞–Ω –ë","–∑—É–º-—Å–æ–∑–≤–æ–Ω","–º–∞—Ä–∞—Ñ–æ–Ω —Å–µ—Ä–∏–∞–ª–æ–≤","–ø–∞–∫–µ—Ç –±–∞–≥–æ–≤","–¥–∏–≤–∞–Ω–Ω—ã–π —Å—Ç–∞—Ä—Ç–∞–ø","–∞–ø–¥–µ–π—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è","—á–∞–π –±–µ–∑ —Å–∞—Ö–∞—Ä–∞","—Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã","–Ω–µ–ª–æ–≤–∫–∞—è –ø–∞—É–∑–∞","—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å","–ø–µ—Ä–µ—Ä—ã–≤ –Ω–∞ —Å–µ–±—è","–ø–æ—Ö–≤–∞–ª–∞ —Å–∞–º–æ–º—É —Å–µ–±–µ","–∫–∞—Ä—Ç–∞ –∂–µ–ª–∞–Ω–∏–π","—Ñ–∞–Ω—Ç–∞–∑–∏—è","—á–∏—Å—Ç—ã–π —Å—Ç–æ–ª","–Ω–æ–≤—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫","—Ç–∞–π–º–µ—Ä –Ω–∞ 5 –º–∏–Ω—É—Ç","–ø–∏—â–∞ –¥–ª—è —É–º–∞","—Å–æ–Ω –¥–Ω—ë–º","—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–∞ —Ä–∞—Å—Ç—è–∂–∫—É","–≤–¥–æ—Ö —á–µ—Ä–µ–∑ –Ω–æ—Å","–º–æ–ª—á–∞–ª–∏–≤–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ"];
    const tails=["–≤ –ø–æ–¥–∞—Ä–æ–∫","–≤ 3 —á–∞—Å–∞ –Ω–æ—á–∏","–ø–æ –ø–æ–¥–ø–∏—Å–∫–µ","–Ω–∞ —Å–∫–æ—Ä—É—é —Ä—É–∫—É","–≤ —Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ","–±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π","—Å –¥–æ—Å—Ç–∞–≤–∫–æ–π –∑–∞–≤—Ç—Ä–∞","–ø–æ –ª—é–±–≤–∏","–Ω–∞ —É–¥–∞–ª—ë–Ω–∫–µ","—Å –∑–∞–∫—Ä—ã—Ç—ã–º–∏ –≥–ª–∞–∑–∞–º–∏","—Å –æ–¥–æ–±—Ä–µ–Ω–∏—è –∫–æ—Ç–∞","–≤–º–µ—Å—Ç–æ —Å–ø–æ—Ä—Ç–∞","–≤ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ–π —Ñ–æ—Ä–º–µ","–±–µ–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏","—Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ —É—Å–∏–ª–∏—è–º–∏","–≤ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–µ–∫—É–Ω–¥—É","—Å –≤–∏–¥–æ–º –Ω–∞ –∫—É—Ö–Ω—é","–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ä–∞–∑—É–º–Ω–æ–≥–æ","–Ω–∞ –ø–æ–ª–Ω–æ–º —Å–µ—Ä—å—ë–∑–µ","–¥–ª—è –≥–∞–ª–æ—á–∫–∏","—Å –æ–≥–æ–Ω—å–∫–æ–º","–ø–æ –≤—ã—Ö–æ–¥–Ω—ã–º","–¥–ª—è –¥—É—à–∏","–ø–æ–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ","–∫–∞–∫-–Ω–∏–±—É–¥—å –ø–æ—Ç–æ–º","–≤ —Ö–æ—Ä–æ—à–µ–º —Å–º—ã—Å–ª–µ","–Ω–µ –¥–ª—è –æ—Ç—á—ë—Ç–∞","–ø–æ –ø—Ä–∏–∫–æ–ª—É","–ø–æ —Å—Ç–∞—Ä–æ–π –ø–∞–º—è—Ç–∏","–±–µ–∑ –ø—Ä–∏—á–∏–Ω"];

    const blackSeed=["–ú–æ–π –¥–µ–Ω—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å ____.","–ù–∞ —Å–æ–≤–µ—â–∞–Ω–∏–∏ –ª—É—á—à–µ –Ω–µ –æ–±—Å—É–∂–¥–∞—Ç—å ____.","–°–µ–∫—Ä–µ—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî ____.","–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –ø–ª–∞–Ω: –∫–æ—Ñ–µ, –¥–µ–ª–∞ –∏ ____.","–°–∞–º—ã–π —Å—Ç—Ä–∞–Ω–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ ‚Äî ____.","–Ø –±—ã —Å —Ä–∞–¥–æ—Å—Ç—å—é –∑–∞–º–µ–Ω–∏–ª(–∞) –≥–∏–º–Ω –Ω–∞ ____.","–ö–æ–≥–¥–∞ –Ω–∏–∫—Ç–æ –Ω–µ –≤–∏–¥–∏—Ç, —è –ø—Ä–∞–∫—Ç–∏–∫—É—é ____.","–õ—É—á—à–µ–µ, —á—Ç–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ —Ä–µ–∑—é–º–µ ‚Äî ____.","–ò–¥–µ–∞–ª—å–Ω–æ–µ –∞–ª–∏–±–∏: ____.","–ì–ª–∞–≤–Ω—ã–π –∞–Ω—Ç–∏—Å—Ç—Ä–µ—Å—Å ‚Äî ____.","–°–ø–æ—Ä–∏–º, –≤ 2035 –º—ã –±—É–¥–µ–º –ø–ª–∞—Ç–∏—Ç—å –∑–∞ ____.","–í –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–º —á–∞—Ç–µ –∑–∞–±–∞–Ω–∏–ª–∏ —Ç–µ–º—É ____.","–ì–ª–∞–≤–Ω–∞—è —Ñ–∏—á–∞ –Ω–æ–≤–æ–≥–æ –∞–π—Ñ–æ–Ω–∞ ‚Äî ____.","–ï—Å–ª–∏ –±—ã —É –º–µ–Ω—è –±—ã–ª —Å–ª–æ–≥–∞–Ω, –æ–Ω –±—ã –±—ã–ª –ø—Ä–æ ____.","–ù–∞ TED —è –≤—ã—Å—Ç—É–ø–ª—é –ø—Ä–æ ____.","–ú–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫—Ä–∏—Ç–∏–∫ –æ–±–æ–∂–∞–µ—Ç ____.","–®–µ—Ñ –º–µ—á—Ç–∞–µ—Ç –≤–Ω–µ–¥—Ä–∏—Ç—å ____.","User story –Ω–∞ —Å–µ–≥–æ–¥–Ω—è ‚Äî ____.","–Ø –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –æ—Ç–∫–∞–∑—ã–≤–∞—é—Å—å –æ—Ç ____.","–°–µ–≥–æ–¥–Ω—è –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è –≤—Å—ë, –∫—Ä–æ–º–µ ____."];

    function genWhite(i){ return `${adj[i%adj.length]} ${noun[(i*7)%noun.length]} ${tails[(i*13)%tails.length]}`; }
    const needW=Math.max(0,MIN_WHITE-(base.white?.length||0));
    for(let i=0;i<needW;i++) base.white.push(genWhite(i));
    const needB=Math.max(0,MIN_BLACK-(base.black?.length||0));
    for(let i=0;i<needB;i++) base.black.push(blackSeed[i%blackSeed.length]);
  }

  function loadDeckLocal(){
    let base;
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){ try{ base=JSON.parse(raw); }catch(e){ console.warn('Bad deck JSON'); base=JSON.parse(JSON.stringify(DEMO_DECK)); } }
    else base=JSON.parse(JSON.stringify(DEMO_DECK));
    ensureMinimumDeck(base);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(base));
    game.deck.black = shuffle([...base.black]);
    game.deck.white = shuffle([...base.white]);
    game.deck.discardBlack = [];
    game.deck.discardWhite = [];
    if($('#deckJson')) $('#deckJson').value = JSON.stringify(base,null,2);
  }
  function drawBlack(){ if(!game.deck.black.length){ game.deck.black = shuffle([...game.deck.discardBlack]); game.deck.discardBlack=[]; }
    return game.deck.black.pop() || '‚Äî –ø—É—Å—Ç–æ ‚Äî'; }
  function drawWhite(){ if(!game.deck.white.length){ game.deck.white = shuffle([...game.deck.discardWhite]); game.deck.discardWhite=[]; }
    return game.deck.white.pop() || '‚Äî –ø—É—Å—Ç–æ ‚Äî'; }

  function topUpHand(hand, drawFn, target=7){ const arr=[...(hand||[])]; while(arr.length<target){ arr.push(drawFn()); } return arr; }

  // ===== Firebase init =====
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyDRtpegXwTsSf77dPIOGDIyBFvib_GgUcM",
    authDomain: "z-e86ee.firebaseapp.com",
    databaseURL: "https://z-e86ee-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "z-e86ee",
    storageBucket: "z-e86ee.appspot.com",
    messagingSenderId: "268263276853",
    appId: "1:268263276853:web:0195c839f5dd38e7214c7c",
    measurementId: "G-6ZBVR66GZE"
  };

  function isConfigFilled(cfg){
    return Object.values(cfg).every(v=>typeof v==='string' && v && !v.startsWith('PASTE_')) && /https:\/\/.+/.test(cfg.databaseURL||'');
  }

  let db=null; let firebaseInitError=null; let connectivityOk=false; let lastConnMsg='';
  try{
    if(!isConfigFilled(FIREBASE_CONFIG)) throw new Error('–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω FIREBASE_CONFIG');
    firebase.initializeApp(FIREBASE_CONFIG);
    db = firebase.database();
  }catch(e){ firebaseInitError=e; console.error('Firebase init error', e); }

  async function testDbConnection(){
    if(!db){ lastConnMsg='Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'; updateConnStatus(false,lastConnMsg); return false; }
    try{
      const pingRef = db.ref('_ping').push();
      await pingRef.set({ t: now(), ua: navigator.userAgent.substring(0,80) });
      await pingRef.remove();
      lastConnMsg='OK: –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ Realtime DB';
      updateConnStatus(true,lastConnMsg);
      return true;
    }catch(e){
      console.error('DB write test failed', e);
      lastConnMsg = normalizeError(e);
      updateConnStatus(false,lastConnMsg);
      return false;
    }
  }


  // ===== –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ =====
  const local = {
    playerId: localStorage.getItem('playerId') || uid(),
    name:'',
    roomId:null,
    isCreator:false,
    hasSubmitted:false,
    selectedCardIndex:null,
    selectedCardText:'',
    submittedText:'',
    autoPickTriggered:false,
    timerTick:null,
    playerData:{hand:[],submitted:false,lastText:''}
  };
  localStorage.setItem('playerId', local.playerId);

  const game = {
    state:{ status:STATUS.LOBBY, round:0, roundsTotal:10, blackCard:'', lastWinnerName:'', lastAnswer:'', currentHostPid:null, timerEndsAt:null, sfwOnly:true },
    players:{},
    playersOrder:[],
    deck:{ black:[], white:[], discardBlack:[], discardWhite:[] },
    submissions:{},
    submissionsOrder:[],
    timers:{},
  };


  function orderedPlayerIds(players){
    return Object.keys(players||{}).sort((a,b)=>{
      const pa=players[a]||{}; const pb=players[b]||{};
      const ja=pa.joinedAt||0; const jb=pb.joinedAt||0;
      if(ja!==jb) return ja-jb;
      return a.localeCompare(b);
    });
  }


  function isCurrentHost(){ return local.playerId && game.state.currentHostPid === local.playerId; }
  function isStatusCollect(){ return (game.state.status||STATUS.LOBBY) === STATUS.COLLECT; }


  // ===== Firebase —Å—Å—ã–ª–∫–∏ =====
  const roomRef = ()=> db.ref(`rooms/${local.roomId}`);
  const stateRef = ()=> roomRef().child('state');
  const playersRef = ()=> roomRef().child('players');
  const perPlayerRef = (pid)=> roomRef().child(`perPlayer/${pid}`);
  const submissionsRef = ()=> roomRef().child('submissions');
  const deckRef = ()=> roomRef().child('deck');
  const playersOrderRef = ()=> roomRef().child('playersOrder');
  const eventsRef = ()=> roomRef().child(EVENTS_PATH);


  function updateConnStatus(ok,msg){ const el=$('#connStatus'); if(!el) return; el.textContent='–°—Ç–∞—Ç—É—Å: ' + (ok?'–ø–æ–¥–∫–ª—é—á–µ–Ω–æ':'–æ—à–∏–±–∫–∞'); el.title=msg||''; el.style.background= ok ? 'var(--accent-2)' : 'var(--chip)'; }

  // ===== –ò–º—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è =====
  function validateName(){
    const raw=($('#playerName').value||'').trim();
    if(raw.length<2) throw new Error('–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ 1 —Å–∏–º–≤–æ–ª–∞.');
    if(/^[0-9]+$/.test(raw)) throw new Error('–ò–º—è –Ω–µ –º–æ–∂–µ—Ç —Å–æ—Å—Ç–æ—è—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ —Ü–∏—Ñ—Ä.');
    return raw.slice(0,24);

  }

  function setLobbyError(msg){ const box=$('#lobbyError'); if(box){ box.textContent=msg||''; } }

  // ===== –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–≥—Ä–æ–∫–∞ =====
  async function registerPlayer(){
    if(!local.roomId) return;
    try{ local.name = validateName(); localStorage.setItem('playerName', local.name); }
    catch(e){ if(!local.name){ local.name = localStorage.getItem('playerName') || `–ò–≥—Ä–æ–∫ ${local.playerId.slice(-4)}`; } setLobbyError(normalizeError(e)); }

    const playerData = { name: local.name || `–ò–≥—Ä–æ–∫ ${local.playerId.slice(-4)}`, score:0, joinedAt: now(), isCreator: local.isCreator };
    const pRef = playersRef().child(local.playerId);
    await pRef.set(playerData);
    await pRef.onDisconnect().remove();

    if(!local.isCreator){
      await perPlayerRef(local.playerId).set({ hand:[], submitted:false, lastText:'' });
      await perPlayerRef(local.playerId).onDisconnect().remove();
      await playersOrderRef().transaction(order=>{
        const next = Array.isArray(order)?order.filter(id=>id!==local.playerId):[];
        if(!next.includes(local.playerId)) next.push(local.playerId);
        return next;
      });
      await eventsRef().push({ type:'needHand', playerId: local.playerId, t: now() });
    }
  }

  // ===== –ü–æ–¥–ø–∏—Å–∫–∏ =====
  let stateOff=null, playersOff=null, submissionsOff=null, perPlayerOff=null, orderOff=null, hostEventsOff=null; // Firebase: –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å–∫–∏
  function unsubscribeAll(){ try{ stateRef().off(); }catch(e){}
    try{ playersRef().off(); }catch(e){}
    try{ submissionsRef().off(); }catch(e){}
    try{ perPlayerRef(local.playerId).off(); }catch(e){}
    try{ playersOrderRef().off(); }catch(e){}
    try{ eventsRef().off(); }catch(e){}
    try{ deckRef().off(); }catch(e){}
  }

  function subscribeRoom(){
    if(!db || !local.roomId) return;
    unsubscribeAll();
    stateRef().on('value', snap=>{ const s=snap.val(); if(!s) return; game.state=s; renderState(); startTimerTick(); });
    playersRef().on('value', snap=>{ const players=snap.val()||{}; game.players=players; renderPlayers(); if(local.isCreator) reconcilePlayersOrder(players); updateHostChip(); });
    submissionsRef().on('value', snap=>{ const map=snap.val()||{}; renderSubmissions(map); });
    perPlayerRef(local.playerId).on('value', snap=>{ const data=snap.val()||{hand:[],submitted:false,lastText:''}; local.playerData=data; local.hasSubmitted=!!data.submitted; if(local.hasSubmitted){ local.submittedText=data.lastText||local.submittedText||''; } else { local.submittedText=''; $('#submittedCard').classList.add('hidden'); } renderHand(data.hand||[]); updateSelectionUI(); updateActionBar(); });
    playersOrderRef().on('value', snap=>{ const arr=snap.val(); if(Array.isArray(arr)){ game.playersOrder=arr; updateProgressChip(); if(local.isCreator) ensureActiveHost(); } });
    if(local.isCreator){ eventsRef().on('child_added', handleHostEvent); deckRef().on('value', snap=>{ const d=snap.val(); if(d){ game.deck.black=d.black||[]; game.deck.white=d.white||[]; game.deck.discardBlack=d.discardBlack||[]; game.deck.discardWhite=d.discardWhite||[]; } }); }
  }

  // ===== –ö–æ–º–Ω–∞—Ç–∞: —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –≤—Ö–æ–¥ =====
  async function createRoom(){
    if(!db){ showError(firebaseInitError||'Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'); return; }
    if(!(connectivityOk || await testDbConnection())) return;
    const id = (Math.random().toString(36).slice(2,8)).toUpperCase();
    local.roomId = id;
    local.isCreator = true;
    loadDeckLocal();
    try{

      await roomRef().set({ hostId: local.playerId, createdAt: now() });
      await stateRef().set({ status:STATUS.LOBBY, round:0, roundsTotal:10, blackCard:'', lastWinnerName:'', lastAnswer:'', sfwOnly: $('#sfwOnly').checked, currentHostPid:null, currentHostName:'', timerEndsAt:null });
      await deckRef().set({ black:game.deck.black, white:game.deck.white, discardBlack:game.deck.discardBlack, discardWhite:game.deck.discardWhite });

      await registerPlayer();
      subscribeRoom();
      updateShareLink();
      renderState();
      toast('–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞');
    }catch(e){ showError(e); }
  }

  async function joinRoom(id){
    if(!db){ showError(firebaseInitError||'Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'); return; }
    const ok = connectivityOk || await testDbConnection(); if(!ok) return;
    local.roomId = id.toUpperCase();
    local.isCreator = false;
    subscribeRoom();
    try{ await registerPlayer(); toast('–ü–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ'); }
    catch(e){ showError(e); }
  }

  function updateShareLink(){
    const url=new URL(location.href); url.searchParams.set('room', local.roomId); $('#shareLink').value=url.toString(); $('#shareRow').style.display='flex'; history.replaceState(null,'',url);
  }


  // ===== –†–µ–Ω–¥–µ—Ä =====
  function renderState(){
    const status=game.state.status||STATUS.LOBBY;
    $('#screenLobby').classList.toggle('hidden', status!==STATUS.LOBBY);
    $('#screenGame').classList.toggle('hidden', status===STATUS.LOBBY);
    $('#roomIdLabel').textContent = local.roomId || '‚Äî';
    $('#roundN').textContent = game.state.round || 0;
    $('#roundTotal').textContent = game.state.roundsTotal || 10;
    $('#hostName').textContent = game.state.currentHostName || '‚Äî';
    $('#blackText').innerHTML = escapeHtml(game.state.blackCard || '‚Äî');
    const statusMap={ [STATUS.LOBBY]:'–æ–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤', [STATUS.COLLECT]:'—Å–±–æ—Ä –æ—Ç–≤–µ—Ç–æ–≤', [STATUS.RESULT]:'—Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—É–Ω–¥–∞' };
    $('#statusHint').textContent = '–§–∞–∑–∞: ' + (statusMap[status]||'‚Äî');
    $('#handSection').classList.toggle('hidden', status===STATUS.LOBBY || isCurrentHost());
    $('#roleChip').classList.toggle('hidden', status===STATUS.LOBBY);
    $('#roleChip').textContent = isCurrentHost() ? '–í—ã –≤–µ–¥—É—â–∏–π' : '–í—ã –∏–≥—Ä–æ–∫';
    $('#resultPanel').classList.toggle('hidden', status!==STATUS.RESULT);
    $('#submissionsPanel').classList.toggle('hidden', status===STATUS.LOBBY);
    $('#timerChip').classList.toggle('hidden', status!==STATUS.COLLECT);
    updateProgressChip();
    if(status===STATUS.RESULT){
      $('#winnerLine').innerHTML = game.state.lastWinnerName ? `${escapeHtml(game.state.lastWinnerName)} –ø–æ–ª—É—á–∞–µ—Ç –æ—á–∫–æ –∑–∞ ${fillBlack(game.state.blackCard||'', game.state.lastAnswer||'')}` : '–í —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ –Ω–µ –±—ã–ª–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è.';
      $('#resultHint').textContent = isCurrentHost() || local.isCreator ? '–í–µ–¥—É—â–∏–π –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥.' : '–ñ–¥—ë–º –≤–µ–¥—É—â–µ–≥–æ.';

    }
    updateSelectionUI();
    updateHostHint();
    updateActionBar();
  }

  function renderPlayers(){
    const box=$('#playersList'); if(!box) return;
    box.innerHTML='';
    const players=game.players||{};
    const arr=Object.entries(players).map(([id,data])=>({ id, ...data })).sort((a,b)=>{
      if((b.score||0)!==(a.score||0)) return (b.score||0)-(a.score||0);
      return (a.joinedAt||0)-(b.joinedAt||0);
    });
    arr.forEach((p)=>{
      const row=document.createElement('div'); row.className='kicker list-enter'; row.style.padding='8px 0';
      const isHost = p.id === game.state.currentHostPid;
      const creatorTag = p.isCreator ? ' ‚Ä¢ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä' : '';
      row.innerHTML = `<div>${escapeHtml(p.name||'–ë–µ–∑—ã–º—è–Ω–Ω—ã–π')}${creatorTag ? `<span class="small muted">${creatorTag}</span>`:''}${isHost?'<span class="small muted"> ‚Ä¢ –≤–µ–¥—É—â–∏–π</span>':''}</div><div class="chip">${p.score||0}</div>`;
      box.appendChild(row);
    });
    if(!arr.length){
      const empty=document.createElement('div'); empty.className='muted small'; empty.textContent='–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç.'; box.appendChild(empty);
    }
    updateStartControls();
  }


  function renderHand(hand){
    const box=$('#handCards'); if(!box) return;
    box.innerHTML='';
    const disabled = isCurrentHost() || !isStatusCollect();
    (hand||[]).forEach((txt,i)=>{
      const btn=document.createElement('button');
      btn.className='card';
      btn.dataset.index=i;
      btn.innerHTML=`<div class="big">${escapeHtml(txt)}</div>`;
      if(disabled){ btn.disabled=true; btn.classList.add('disabled'); }
      else {
        btn.classList.add('selectable');
        btn.onclick=()=> selectCard(i, txt);
      }
      box.appendChild(btn);

    });
    if(disabled){
      local.selectedCardIndex=null;
      local.selectedCardText='';
    }
    refreshHandSelectionStyles();
  }

  function renderSubmissions(map){
    game.submissions = map||{};
    const entries=Object.entries(game.submissions);
    const keys=entries.map(([id])=>id);
    const prevOrder=Array.isArray(game.submissionsOrder)?game.submissionsOrder.filter(id=>keys.includes(id)):[];
    if(prevOrder.length!==keys.length){
      const shuffled=shuffle([...keys]);
      game.submissionsOrder=shuffled;
    }
    const order=game.submissionsOrder||keys;
    const box=$('#submissions'); if(!box) return; box.innerHTML='';
    if(!keys.length){
      const empty=document.createElement('div'); empty.className='muted small'; empty.textContent=isStatusCollect()?'–ü–æ–∫–∞ –Ω–µ—Ç —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç.':'–ö–∞—Ä—Ç –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å.'; box.appendChild(empty);
      updateProgressChip();
      updateHostHint();
      return;
    }
    const reveal = isStatusCollect() || game.state.status===STATUS.RESULT;
    order.forEach((id)=>{
      const item=game.submissions[id]; if(!item) return;
      const btn=document.createElement('button');
      btn.className='card list-enter';
      btn.style.textAlign='left';
      btn.innerHTML = `<div class="muted small">–û—Ç–≤–µ—Ç</div><div class="big">${fillBlack(game.state.blackCard||'', item.text)}</div>`;
      if(isCurrentHost() && isStatusCollect()){
        btn.onclick=()=> pickWinnerRequest(id, item.playerId);
      } else {
        btn.classList.add('readonly');
        btn.disabled=true;
      }
      box.appendChild(btn);
    });
    updateProgressChip();
    updateHostHint();
  }


  // ===== –í—ã–±–æ—Ä –∫–∞—Ä—Ç—ã =====
  function selectCard(idx, text){
    if(isCurrentHost()) return;
    if(local.hasSubmitted) return;
    local.selectedCardIndex=idx;
    local.selectedCardText=text;
    refreshHandSelectionStyles();
    updateSelectionUI();
    updateActionBar();
  }

  function refreshHandSelectionStyles(){
    const canPick = !isCurrentHost() && isStatusCollect() && !local.hasSubmitted;
    $$('#handCards .card').forEach(el=>{
      const idx = Number(el.dataset.index);
      const isSelected = canPick && idx===local.selectedCardIndex;
      el.classList.toggle('selected', isSelected);
      el.classList.toggle('disabled', !canPick);
      if(el instanceof HTMLButtonElement){ el.disabled = !canPick; }

    });
    if (disabled){
      local.selectedCardIndex = null;
      local.selectedCardText = '';
    } else if (local.selectedCardIndex !== null && local.selectedCardIndex >= hand.length){
      local.selectedCardIndex = null;
      local.selectedCardText = '';
    }
    refreshHandSelectionStyles();
    updateSelectionUI();
  }

  function selectCard(idx, text){
    if (local.hasSubmitted) return;
    if ((game.state.status||'')!=='collect') return;
    local.selectedCardIndex = idx;
    local.selectedCardText = text;
    refreshHandSelectionStyles();
    updateSelectionUI();
  }

  function refreshHandSelectionStyles(){
    const status = game.state.status || 'lobby';
    const canPick = status==='collect' && !local.hasSubmitted;
    $$('#handCards .card').forEach(el=>{
      const idx = Number(el.dataset.index);
      const isSelected = idx === local.selectedCardIndex && canPick;
      el.classList.toggle('selected', isSelected);
      el.classList.toggle('disabled', !canPick);
      if (canPick){
        el.classList.add('selectable');
        if (el instanceof HTMLButtonElement) el.disabled = false;
      } else {
        el.classList.remove('selectable');
        if (el instanceof HTMLButtonElement) el.disabled = true;
      }
    });
  }

  function updateSelectionUI(){

    const hint=$('#selectionHint'); if(!hint) return;
    if(isCurrentHost()){
      hint.textContent = '–í—ã –≤–µ–¥—É—â–∏–π ‚Äî –Ω–∞–±–ª—é–¥–∞–π—Ç–µ –∑–∞ –æ—Ç–≤–µ—Ç–∞–º–∏ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è.';
    } else if(game.state.status===STATUS.LOBBY){
      hint.textContent='–û–∂–∏–¥–∞–µ–º —Å—Ç–∞—Ä—Ç —Ä–∞—É–Ω–¥–∞.';
    } else if(!isStatusCollect()){
      hint.textContent = '–†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à—ë–Ω, –∂–¥—ë–º —Å–ª–µ–¥—É—é—â—É—é —Ä–∞–∑–¥–∞—á—É.';
    } else if(local.hasSubmitted){
      hint.textContent='–í—ã–±–æ—Ä —Å–¥–µ–ª–∞–Ω, –∂–¥—ë–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö.';
    } else if(local.selectedCardIndex==null){
      hint.textContent='–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –±–µ–ª—É—é –∫–∞—Ä—Ç—É (–≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–∞–º).';
    } else {
      hint.textContent='–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å¬ª, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É.';
    }
    const submittedBox=$('#submittedCard');
    if(submittedBox){
      const visible = local.hasSubmitted && !!local.submittedText;
      submittedBox.classList.toggle('hidden', !visible);
      if(visible){ $('#submittedCardText').textContent = local.submittedText; }
    }
  }

  function updateActionBar(){
    const bar=$('#actionBar'); if(!bar) return;
    const hint=$('#actionHint');
    const btn=$('#btnConfirm');
    const canShow = !isCurrentHost() && game.state.status===STATUS.COLLECT;
    bar.classList.toggle('hidden', !canShow);
    if(!canShow) return;
    if(local.hasSubmitted){ hint.textContent='–í—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∫–∞—Ä—Ç—É. –ñ–¥—ë–º –≤–µ–¥—É—â–µ–≥–æ.'; btn.disabled=true; }
    else if(local.selectedCardIndex==null){ hint.textContent='–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É.'; btn.disabled=true; }
    else { hint.textContent='–ì–æ—Ç–æ–≤–æ! –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤—ã–±–æ—Ä, –∫–∞—Ä—Ç–∞ –∏—Å—á–µ–∑–Ω–µ—Ç –∏–∑ —Ä—É–∫–∏.'; btn.disabled=false; }

  }

  function updateHostHint(){
    const hint=$('#hostHint'); if(!hint) return;
    if(game.state.status===STATUS.LOBBY){ hint.textContent='–ñ–¥—ë–º, –ø–æ–∫–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç –∏–≥—Ä—É.'; return; }
    if(game.state.status===STATUS.COLLECT){
      if(isCurrentHost()){
        const totalExpected=Math.max(0,(game.playersOrder||[]).length-1);
        const count=Object.keys(game.submissions||{}).length;
        hint.textContent = totalExpected ? `–ü–æ–ª—É—á–µ–Ω–æ ${count}/${totalExpected} –æ—Ç–≤–µ—Ç–æ–≤. –í—ã–±–µ—Ä–∏—Ç–µ –ª—É—á—à–∏–π.` : '–û–∂–∏–¥–∞–µ–º –∏–≥—Ä–æ–∫–æ–≤.';
      } else {
        hint.textContent = local.hasSubmitted ? '–ñ–¥—ë–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏ —Ä–µ—à–µ–Ω–∏–µ –≤–µ–¥—É—â–µ–≥–æ.' : '–°—ã–≥—Ä–∞–π—Ç–µ –∫–∞—Ä—Ç—É, –ø–æ–∫–∞ –∏–¥—ë—Ç —Ç–∞–π–º–µ—Ä.';
      }
      return;
    }
    if(game.state.status===STATUS.RESULT){
      hint.textContent = isCurrentHost() ? '–û–±—ä—è–≤–∏—Ç–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ä–∞—É–Ω–¥—É.' : '–†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à—ë–Ω, –∂–¥—ë–º –Ω–æ–≤—É—é —á—ë—Ä–Ω—É—é –∫–∞—Ä—Ç—É.';
      return;
    }
    hint.textContent='';
  }

  function updateProgressChip(){
    const chip=$('#progressChip'); if(!chip) return;
    if(game.state.status!==STATUS.COLLECT){ chip.classList.add('hidden'); return; }
    const expected=Math.max(0,(game.playersOrder||[]).length-1);
    const received=Object.keys(game.submissions||{}).length;
    chip.textContent=`${received}/${expected} –æ—Ç–ø—Ä–∞–≤–∏–ª–∏`;
    chip.classList.toggle('hidden', expected===0);
    chip.classList.toggle('alert', expected>0 && received<expected && (game.state.timerEndsAt||0) - now() < 15000);
  }

  function updateStartControls(){
    const actions=$('#lobbyActions'); const hint=$('#startHint');
    if(!actions) return;
    const playersCount=(game.playersOrder||[]).length;
    const ready = local.isCreator && game.state.status===STATUS.LOBBY;
    actions.style.display = ready ? 'flex' : 'none';
    if(ready){
      const missing=Math.max(0,2-playersCount);
      if(missing>0) hint.textContent=`–ù—É–∂–Ω–æ –µ—â—ë ${missing} –∏–≥—Ä–æ–∫${missing===1?'':'–∞'}.`;
      else hint.textContent='–ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –∏–≥—Ä—É.';
      $('#btnStartGame').disabled = playersCount<2;
    }
  }

  function updateHostChip(){
    const chip=$('#roleChip'); if(!chip) return;
    if(game.state.status===STATUS.LOBBY){ chip.classList.add('hidden'); return; }
    chip.classList.remove('hidden');
    chip.textContent = isCurrentHost() ? '–í—ã –≤–µ–¥—É—â–∏–π' : '–í—ã –∏–≥—Ä–æ–∫';
  }

  function startTimerTick(){
    clearInterval(local.timerTick);
    if(game.state.status!==STATUS.COLLECT || !game.state.timerEndsAt){ $('#timerChip').classList.add('hidden'); return; }
    $('#timerChip').classList.remove('hidden');
    const update=()=>{
      const left=Math.max(0, Math.ceil((game.state.timerEndsAt - now())/1000));
      $('#timerChip').textContent = `‚è± ${left}s`;
      if(left<=0){ clearInterval(local.timerTick); if(!local.autoPickTriggered){ local.autoPickTriggered=true; attemptAutoPick(); } }
    };
    update();
    local.timerTick=setInterval(update, 1000);
    local.autoPickTriggered=false;
  }

  // ===== –§—É–Ω–∫—Ü–∏–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Firebase =====
  function reconcilePlayersOrder(players){
    const ids = orderedPlayerIds(players).filter(id=>!players[id]?.isCreator);
    const current = Array.isArray(game.playersOrder)?game.playersOrder:[];
    const filtered=current.filter(id=>ids.includes(id));
    let changed=filtered.length!==current.length;
    ids.forEach(id=>{ if(!filtered.includes(id)){ filtered.push(id); changed=true; } });
    if(changed){ playersOrderRef().set(filtered); }
  }

  function ensureActiveHost(){
    const order=Array.isArray(game.playersOrder)?game.playersOrder:[];
    if(!order.length){ stateRef().update({ currentHostPid:null, currentHostName:'' }); return; }
    const current=game.state.currentHostPid;
    if(current && order.includes(current)) return;
    const next=order[0];
    const name=(game.players[next]?.name)||'‚Äî';
    stateRef().update({ currentHostPid: next, currentHostName: name });
  }

  function nextHostId(order,current){
    if(!Array.isArray(order) || !order.length) return null;
    const idx=order.indexOf(current);
    if(idx===-1) return order[0];
    return order[(idx+1)%order.length];
  }

  async function handleHostEvent(snap){
    const ev=snap.val(); const key=snap.key;
    if(!ev) return;
    try{

      switch(ev.type){
        case 'needHand': await handleNeedHand(ev); break;
        case 'pickWinner': await handlePickWinner(ev); break;
        case 'autoPick': await handleAutoPick(ev); break;
        case 'nextRound': await handleNextRoundEvent(ev); break;
      }
    }catch(e){ showError(e); }
    finally{ eventsRef().child(key).remove(); }
  }

  async function handleNeedHand(ev){
    if(!local.isCreator) return;
    if(!ev.playerId) return;
    const data=(await perPlayerRef(ev.playerId).get()).val()||{};
    if(data.hand && data.hand.length>=7) return;
    const hand=topUpHand(data.hand||[], drawWhite, 7);
    await perPlayerRef(ev.playerId).set({ hand, submitted:false, lastText:'' });
    await deckRef().set({ black:game.deck.black, white:game.deck.white, discardBlack:game.deck.discardBlack, discardWhite:game.deck.discardWhite });
  }

  async function handlePickWinner(ev){
    if(!local.isCreator) return;
    const stateSnap=await stateRef().get();
    const state=stateSnap.val();
    if(!state || state.status!==STATUS.COLLECT) return;
    const submissions=(await submissionsRef().get()).val()||{};
    const item=submissions[ev.submissionId];
    if(!item) return;
    const players=(await playersRef().get()).val()||{};
    const winnerName=players[item.playerId]?.name||'‚Äî';
    await playersRef().child(item.playerId).transaction(data=>{ if(!data) return data; return { ...data, score:(data.score||0)+1 }; });
    await collectDiscardWhite(submissions);
    await stateRef().update({ status:STATUS.RESULT, lastWinnerName:winnerName, lastAnswer:item.text, timerEndsAt:null });
    toast(`–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${winnerName}`);
  }

  async function handleAutoPick(ev){
    if(!local.isCreator) return;
    const stateSnap=await stateRef().get();
    const state=stateSnap.val();
    if(!state || state.status!==STATUS.COLLECT) return;
    const submissions=(await submissionsRef().get()).val()||{};
    if(ev.submissionId && submissions[ev.submissionId]){
      await handlePickWinner(ev);
      return;
    }
    await collectDiscardWhite(submissions);
    await stateRef().update({ status:STATUS.RESULT, lastWinnerName:'', lastAnswer:'', timerEndsAt:null });
  }

  async function handleNextRoundEvent(ev){
    if(!local.isCreator) return;
    await advanceRound();
  }

  async function collectDiscardWhite(submissions){
    const values=Object.values(submissions||{});
    values.forEach(s=>{ if(s && s.text) game.deck.discardWhite.push(s.text); });
    await deckRef().set({ black:game.deck.black, white:game.deck.white, discardBlack:game.deck.discardBlack, discardWhite:game.deck.discardWhite });
  }

  // ===== –î–µ–π—Å—Ç–≤–∏—è –∏–≥—Ä–æ–∫–∞ =====
  async function submitCard(){
    if(isCurrentHost()){ showError('–í–µ–¥—É—â–∏–π –Ω–µ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∫–∞—Ä—Ç—ã.'); return; }
    if(!isStatusCollect()){ showError('–°–µ–π—á–∞—Å –Ω–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É.'); return; }
    if(local.hasSubmitted){ showError('–ö–∞—Ä—Ç–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.'); return; }
    const hand=[...(local.playerData.hand||[])];
    let idx=local.selectedCardIndex;
    if(idx==null || hand[idx]!==local.selectedCardText) idx=hand.indexOf(local.selectedCardText);
    if(idx<0){ showError('–ö–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ä—É–∫–µ.'); return; }
    markSubmitted(local.playerData); // –≤—ã–±—Ä–æ—Å–∏—Ç, –µ—Å–ª–∏ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
    const text=hand.splice(idx,1)[0];
    await perPlayerRef(local.playerId).set({ hand, submitted:true, lastText:text });
    const id=uid();
    await submissionsRef().child(id).set({ playerId: local.playerId, text, createdAt: now() });
    local.selectedCardIndex=null; local.selectedCardText='';
    local.hasSubmitted=true;
    local.submittedText=text;
    $('#submittedCard').classList.remove('hidden');
    $('#submittedCardText').textContent=text;
    refreshHandSelectionStyles();
    updateSelectionUI();
    updateActionBar();
    toast('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
  }

  function markSubmitted(playerState){ if(playerState.submitted) throw new Error('–í—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∫–∞—Ä—Ç—É.'); playerState.submitted=true; return playerState; }

  async function pickWinnerRequest(submissionId){
    if(!(isCurrentHost() || local.isCreator)) return;
    await eventsRef().push({ type:'pickWinner', submissionId, t: now() });
  }

  async function attemptAutoPick(){
    if(local.isCreator){
      const submissions=(await submissionsRef().get()).val()||{};
      const choice = autoPickWinner(submissions, Math.random);
      await eventsRef().push({ type:'autoPick', submissionId: choice?.id||null, t: now() });
    } else {
      const choice = autoPickWinner(game.submissions, Math.random);
      await eventsRef().push({ type:'autoPick', submissionId: choice?.id||null, t: now() });
    }
  }

  function autoPickWinner(submissions, rng=Math.random){
    const entries=Object.entries(submissions||{});
    if(!entries.length) return null;
    const idx=Math.floor((rng||Math.random)()*entries.length);
    const [id, val]=entries[idx];
    return { id, ...val };
  }
  function autoPickStateTransition(state, submissions, rng=Math.random){
    const pick = autoPickWinner(submissions, rng);
    return { ...state, status: STATUS.RESULT, lastWinnerName: pick?.playerName||'', lastAnswer: pick?.text||'' };
  }

  async function nextRound(){
    if(!(isCurrentHost() || local.isCreator)){ showError('–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥ –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤–µ–¥—É—â–∏–π.'); return; }
    await eventsRef().push({ type:'nextRound', t: now() });
  }

  async function advanceRound(){
    if(!local.isCreator) return;
    const stateSnap = await stateRef().get();
    const state = stateSnap.val()||{};
    const players = (await playersRef().get()).val()||{};
    const order = Array.isArray(game.playersOrder)?game.playersOrder:[];
    if(order.length<2){ showError('–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –∏–≥—Ä–æ–∫–∞ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è.'); return; }
    const currentHost = state.status===STATUS.LOBBY ? order[0] : nextHostId(order, state.currentHostPid);
    const hostName = players[currentHost]?.name || '‚Äî';
    if(state.blackCard){ game.deck.discardBlack.push(state.blackCard); }
    await submissionsRef().remove();
    const promises=[];
    for(const pid of order){
      if(pid===currentHost){
        promises.push(perPlayerRef(pid).set({ hand:[], submitted:false, lastText:'' }));
      } else {
        const handSnap = await perPlayerRef(pid).get();
        const data=handSnap.val()||{};
        const newHand=topUpHand(data.hand||[], drawWhite, 7);
        promises.push(perPlayerRef(pid).set({ hand:newHand, submitted:false, lastText:'' }));
      }
    }
    await Promise.all(promises);
    const black = drawBlack();
    const round = state.status===STATUS.LOBBY ? 1 : (state.round||0)+1;
    const timerEndsAt = now() + ROUND_SECONDS*1000;
    await stateRef().set({ status:STATUS.COLLECT, round, roundsTotal: state.roundsTotal||10, blackCard:black, lastWinnerName:'', lastAnswer:'', sfwOnly: state.sfwOnly, currentHostPid: currentHost, currentHostName: hostName, timerEndsAt });
    await deckRef().set({ black:game.deck.black, white:game.deck.white, discardBlack:game.deck.discardBlack, discardWhite:game.deck.discardWhite });
    game.submissionsOrder=[];

  }

  // ===== –¢–∞–π–º–µ—Ä –∏ –∫–Ω–æ–ø–∫–∏ =====
  $('#btnConfirm').onclick=()=>{ if(local.selectedCardText) submitCard(); else toast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É'); };
  $('#nextRound').onclick=nextRound;
  $('#btnCreate').onclick=async()=>{
    try{ setLobbyError(''); await createRoom(); }
    catch(e){ showError(e); }
  };
  $('#btnJoin').onclick=async()=>{
    const id=($('#roomInput').value||'').trim();
    if(!id){ setLobbyError('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã.'); return; }
    try{ setLobbyError(''); await joinRoom(id); }
    catch(e){ showError(e); }
  };
  $('#btnCopy').onclick=()=>copyToClipboard($('#shareLink').value||'');
  $('#btnStartGame').onclick=async()=>{ await eventsRef().push({ type:'nextRound', t: now() }); };
  $('#btnNew').onclick=()=>location.href=location.origin+location.pathname;
  $('#btnHow').onclick=()=>$('#dlgRules').showModal();
  $('#btnDeck').onclick=()=>$('#dlgDeck').showModal();
  $('#btnTests').onclick=runTests;
  $('#btnSaveDeck').onclick=()=>{
    try{ const json=JSON.parse($('#deckJson').value||'{}'); ensureMinimumDeck(json); localStorage.setItem(STORAGE_KEY, JSON.stringify(json)); if(local.isCreator) loadDeckLocal(); toast('–ö–æ–ª–æ–¥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞'); }
    catch(e){ showError('–û—à–∏–±–∫–∞ JSON: '+e.message); }
  };
  $('#btnResetDeck').onclick=()=>{ localStorage.removeItem(STORAGE_KEY); loadDeckLocal(); toast('–ö–æ–ª–æ–¥–∞ —Å–±—Ä–æ—à–µ–Ω–∞'); };
  $('#btnExport').onclick=()=>{
    const blob=new Blob([$('#deckJson').value||''],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='deck.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 500);
  };
  $('#btnImport').onclick=()=>{ const input=document.createElement('input'); input.type='file'; input.accept='application/json'; input.onchange=async()=>{ const file=input.files?.[0]; if(!file) return; const text=await file.text(); $('#deckJson').value=text; }; input.click(); };
  $('#btnCheck').onclick=async()=>{ await testDbConnection(); toast('–ü—Ä–æ–≤–µ—Ä–∫–∞: '+lastConnMsg); };

  // ===== –¢–µ—Å—Ç—ã =====
  const tests=[]; function test(name,fn){ tests.push({name,fn}); }
  function expect(cond,msg){ if(!cond) throw new Error(msg||'assert failed'); }
  async function runTests(){
    const out=[];
    for(const t of tests){
      try{ await t.fn(); out.push({name:t.name, ok:true}); }
      catch(e){ out.push({name:t.name, ok:false, err:e.message}); }
    }
    const text=out.map(r=> `${r.ok?'‚úÖ':'‚ùå'} ${r.name}${r.ok?'':` ‚Äî ${r.err}`}`).join('\n');
    $('#testsOutput').textContent=text||'–ù–µ—Ç —Ç–µ—Å—Ç–æ–≤';
    $('#dlgTests').showModal();
    console.table(out);
  }

  test('ensureMinimumDeck(): >=120/500',()=>{ const base={black:[],white:[]}; ensureMinimumDeck(base); expect(base.black.length>=120,'black<120'); expect(base.white.length>=500,'white<500'); });
  test('fillBlack() placeholder',()=>{ const s=fillBlack('A ____ B','X'); expect(/<b>X<\/b>/.test(s),'no replace'); });
  test('fillBlack() no placeholder path',()=>{ const s=fillBlack('–ü—Ä–∏–≤–µ—Ç','–º–∏—Ä'); expect(/–ü—Ä–∏–≤–µ—Ç\s‚Äî\s<b>–º–∏—Ä<\/b>/.test(s),'no dash concat'); });
  test('escapeHtml() double quote',()=>{ const s=escapeHtml('"'); expect(s==='&quot;','not &quot;'); });

  test('orderedPlayerIds() —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ joinedAt',()=>{
    const players={ a:{joinedAt:3}, b:{joinedAt:1}, c:{joinedAt:2} };
    expect(JSON.stringify(orderedPlayerIds(players))===JSON.stringify(['b','c','a']),'order mismatch');
  });
  test('markSubmitted() –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É',()=>{
    const state={submitted:false};
    markSubmitted(state);
    let failed=false;
    try{ markSubmitted(state); }catch(e){ failed=true; }
    expect(failed,'–ø–æ–≤—Ç–æ—Ä–Ω—ã–π submit –ø—Ä–æ—à—ë–ª');
  });
  test('topUpHand() –Ω–∞–ø–æ–ª–Ω—è–µ—Ç –¥–æ 7 (–≤–µ–¥—É—â–∏–π –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç)',()=>{
    let draws=0;
    const hand=topUpHand(['a'], ()=>{ draws++; return 'x'+draws; }, 7);
    expect(hand.length===7,'hand size');
  });
  test('nextHostId() –∫—Ä—É–≥–æ–≤–∞—è —Ä–æ—Ç–∞—Ü–∏—è',()=>{
    const order=['p1','p2','p3'];
    expect(nextHostId(order,'p1')==='p2','p1->p2');
    expect(nextHostId(order,'p2')==='p3','p2->p3');
    expect(nextHostId(order,'p3')==='p1','p3->p1');
  });
  test('autoPickWinner() –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é –∑–∞–ø–∏—Å—å',()=>{
    const submissions={ a:{text:'1'}, b:{text:'2'} };
    const choice=autoPickWinner(submissions, ()=>0.6);
    expect(choice.id==='b','expected b');
  });
  test('—Ç–∞–π–º–µ—Ä: autoPick –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –≤ result',()=>{
    const submissions={ a:{playerId:'p1',text:'X'} };
    const state={ status:STATUS.COLLECT, lastWinnerName:'', lastAnswer:'' };
    const next=autoPickStateTransition(state, submissions, ()=>0);
    expect(next.status===STATUS.RESULT,'status not result');
    expect(next.lastAnswer==='X','winner answer mismatch');
  });


  // ===== –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ =====
  async function autoJoinFromURL(){
    const url=new URL(location.href); const room=url.searchParams.get('room');
    if(room){ $('#roomInput').value=room; await joinRoom(room); }
  }

  function init(){
    $('#playerName').value = localStorage.getItem('playerName') || '';
    if($('#deckJson')) $('#deckJson').value = JSON.stringify(DEMO_DECK,null,2);
    if(firebaseInitError){ updateConnStatus(false,'–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: '+firebaseInitError.message); }
    const room=new URL(location.href).searchParams.get('room');
    if(room){ $('#roomInput').value=room; $('#shareRow').style.display='flex'; $('#shareLink').value=location.href; }
  }

  init();
  setTimeout(()=>testDbConnection(), 400);
  autoJoinFromURL();
  </script>
  <!-- –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ -->
<!-- - –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω UI —Å —Ç–∞–π–º–µ—Ä–æ–º —Ä–∞—É–Ω–¥–∞, –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–π –ø–∞–Ω–µ–ª—å—é –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏ –¥–ª—è –≤–µ–¥—É—â–µ–≥–æ. -->
<!-- - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ä–æ—Ç–∞—Ü–∏—è –≤–µ–¥—É—â–µ–≥–æ, –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–µ—Ä–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è Firebase. -->
<!-- - –î–æ–±–∞–≤–ª–µ–Ω—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ª–æ–±–±–∏, –Ω–æ–≤–∞—è —Å—Ö–µ–º–∞ –æ—á–µ—Ä–µ–¥–∏ –∏–≥—Ä–æ–∫–æ–≤ –∏ —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –¥–ª—è –∫–ª—é—á–µ–≤–æ–π –ª–æ–≥–∏–∫–∏. -->
  <!-- TODO -->
<!-- - –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –ª–æ–≥–∏–∫—É —Ç–∞–π–º–µ—Ä–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–ª–Ω–æ–π –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏. -->
<!-- - –î–æ–±–∞–≤–∏—Ç—å –∞–Ω—Ç–∏-—Å–ø–∞–º –∑–∞—â–∏—Ç—É –∏ –∞–Ω–∏–º–∞—Ü–∏–∏ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è. -->
</body>
</html>
