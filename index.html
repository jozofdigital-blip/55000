<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>500 –∑–ª–æ–±–Ω—ã—Ö –∫–∞—Ä—Ç ‚Äî –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</title>
  <style>
    :root {
      --bg:#0d1016;
      --panel:#171b27;
      --panel-soft:rgba(23,27,39,0.86);
      --muted:#8b93a7;
      --text:#f1f3fb;
      --accent:#7c5cff;
      --accent-2:#25d0a2;
      --danger:#ff5c7c;
      --chip:#20263a;
      --border:#2a3248;
      --card:#1b2030;
      --shadow:0 16px 44px rgba(0,0,0,.45);
      --focus-ring:0 0 0 3px rgba(124,92,255,.35);
      --safe-bottom:env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,"Noto Sans","Helvetica Neue",Arial;
      min-height:100vh;
      background:radial-gradient(circle at 20% -10%,rgba(124,92,255,.25),transparent 55%),
                 radial-gradient(circle at 80% -10%,rgba(37,208,162,.18),transparent 60%),
                 var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    button{
      border:none;
      font:inherit;
      cursor:pointer;
      transition:transform .16s ease, filter .18s ease, box-shadow .2s ease;
    }
    button:disabled{opacity:.55;cursor:not-allowed;box-shadow:none;transform:none;filter:none}
    button:focus-visible{outline:none;box-shadow:var(--focus-ring);}
    .ghost{background:transparent;border:1px solid var(--border);color:var(--text);box-shadow:none}
    .primary{
      background:var(--accent);
      color:#fff;
      padding:13px 18px;
      border-radius:16px;
      font-weight:700;
      box-shadow:var(--shadow);
    }
    .ghost-rounded{padding:12px 16px;border-radius:16px;font-weight:600;}
    .icon-btn{
      background:var(--panel-soft);
      color:var(--text);
      border:1px solid rgba(255,255,255,.08);
      width:44px;height:44px;
      border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      font-size:21px;
      box-shadow:var(--shadow);
    }
    .icon-btn:hover:not(:disabled), .primary:hover:not(:disabled), .ghost-rounded:hover:not(:disabled){transform:translateY(-1px);filter:saturate(1.05);}
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:18px 20px 12px;
      position:sticky;
      top:0;
      z-index:30;
      background:linear-gradient(180deg,rgba(13,16,22,.95),rgba(13,16,22,.65) 60%,transparent);
      backdrop-filter:blur(12px);
    }
    .logo{display:flex;align-items:center;gap:12px;font-weight:800;font-size:20px;letter-spacing:.2px;}
    .logo b{background:linear-gradient(135deg,var(--accent),#b28dff);-webkit-background-clip:text;background-clip:text;color:transparent;}
    .wrap{max-width:900px;margin:0 auto;padding:0 16px 140px;}
    main{display:none;margin-top:24px;}
    main.active{display:block;}
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:22px;
      padding:22px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
    }
    h1{margin:0 0 16px;font-size:26px;}
    h2{margin:0 0 14px;font-size:20px;}
    p{margin:0 0 14px;line-height:1.6;}
    .muted{color:var(--muted);}
    .small{font-size:13px;opacity:.85;}
    label{display:flex;flex-direction:column;gap:8px;font-weight:600;}
    input[type="text"], textarea{
      width:100%;
      padding:13px 16px;
      border-radius:16px;
      border:1px solid var(--border);
      background:rgba(32,38,58,.65);
      color:var(--text);
      font-size:16px;
      transition:border .2s ease, box-shadow .2s ease;
    }
    input[type="text"]:focus, textarea:focus{border-color:var(--accent);box-shadow:var(--focus-ring);outline:none;}
    .field-gap{display:flex;flex-direction:column;gap:16px;margin-bottom:18px;}
    .actions-row{display:flex;flex-direction:column;gap:12px;margin-top:10px;}
    .chip{
      display:inline-flex;align-items:center;gap:6px;
      background:var(--chip);
      border:1px solid var(--border);
      color:#d2d9ef;
      padding:8px 12px;
      border-radius:999px;
      font-size:13px;
      font-weight:600;
    }
    .chip.danger{color:#ffc0d6;border-color:rgba(255,92,124,.45);}
    .status-board{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:18px;}
    .black-card{
      background:#050608;
      border:1px solid #1f2536;
      color:#fff;
      border-radius:22px;
      padding:22px;
      margin-bottom:20px;
      box-shadow:0 18px 48px rgba(0,0,0,.45);
    }
    .black-card .muted{color:rgba(255,255,255,.7);font-size:13px;}
    .cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:14px;}
    .answer-card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:20px;
      padding:18px;
      text-align:left;
      line-height:1.5;
      transition:transform .2s ease, box-shadow .2s ease;
    }
    .answer-card.selectable{cursor:pointer;}
    .answer-card.selectable:hover{transform:translateY(-2px);box-shadow:0 18px 40px rgba(0,0,0,.4);}
    .answer-card.selected{outline:2px solid var(--accent);box-shadow:0 0 0 3px rgba(124,92,255,.35),0 18px 40px rgba(0,0,0,.45);transform:translateY(-3px);}
    .answer-card.disabled{opacity:.55;pointer-events:none;}
    .scroll{max-height:320px;overflow:auto;padding-right:6px;}
    .scroll::-webkit-scrollbar{width:6px;}
    .scroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px;}
    table.scoreboard{width:100%;border-collapse:separate;border-spacing:0 8px;}
    table.scoreboard td{padding:8px 0;}
    .toast{
      position:fixed;
      left:50%;
      bottom:calc(20px + var(--safe-bottom));
      transform:translate(-50%, 60px);
      padding:14px 18px;
      background:var(--panel-soft);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      box-shadow:var(--shadow);
      font-weight:600;
      opacity:0;
      pointer-events:none;
      transition:transform .25s ease, opacity .22s ease;
      z-index:120;
    }
    .toast.show{opacity:1;pointer-events:auto;transform:translate(-50%, -4px);}
    #actionBar{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:calc(16px + var(--safe-bottom));
      width:min(560px,calc(100vw - 28px));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:16px 18px;
      background:rgba(20,23,34,.96);
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(14px);
      z-index:50;
      transition:opacity .2s ease, transform .24s ease;
    }
    #actionBar.hidden{opacity:0;pointer-events:none;transform:translate(-50%, 40px);}
    #actionHint{font-size:14px;line-height:1.4;}
    #shareRow{display:none;align-items:center;gap:12px;margin-bottom:18px;}
    #shareRow input{flex:1;}
    .section-title{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:28px 0 14px;}
    .winner-card{background:linear-gradient(135deg,rgba(37,208,162,.22),rgba(124,92,255,.22));border:1px solid rgba(124,92,255,.3);border-radius:22px;padding:20px;}
    .placeholder{color:var(--muted);font-size:14px;padding:12px 0;}
    dialog{border:none;border-radius:24px;padding:0;background:rgba(11,13,19,.94);color:var(--text);box-shadow:0 28px 64px rgba(0,0,0,.6);}
    dialog::backdrop{background:rgba(5,7,11,.72);}
    dialog form{padding:24px;max-height:80vh;overflow:auto;}
    menu{margin:0;padding:0;display:flex;gap:12px;justify-content:flex-end;}
    #menuSheet{
      position:fixed;
      right:16px;
      top:74px;
      background:rgba(16,19,29,.96);
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:200px;
      box-shadow:var(--shadow);
      z-index:60;
    }
    #menuSheet.hidden{display:none;}
    .menu-btn{width:100%;text-align:left;}
    @media (max-width:640px){
      header{padding:16px 14px 10px;}
      .wrap{padding:0 14px 160px;}
      .card, .black-card{padding:20px;}
      .cards-grid{grid-template-columns:1fr;}
      .primary, .ghost-rounded{font-size:16px;}
      #shareRow{flex-direction:column;align-items:stretch;}
      table.scoreboard td{font-size:15px;}
    }
  </style>
</head>
<body>
  <header>
    <div class="logo" aria-live="polite">üÉè <b>500 –∑–ª. –∫–∞—Ä—Ç</b></div>
    <button id="menuBtn" class="icon-btn" aria-label="–ú–µ–Ω—é">‚ò∞</button>
    <div id="menuSheet" class="hidden" role="menu">
      <button class="ghost-rounded menu-btn" id="menuRules" role="menuitem">–ü—Ä–∞–≤–∏–ª–∞</button>
      <button class="ghost-rounded menu-btn" id="menuDeck" role="menuitem">–ö–æ–ª–æ–¥–∞</button>
      <button class="ghost-rounded menu-btn" id="menuTests" role="menuitem">üß™ –¢–µ—Å—Ç—ã</button>
      <button class="ghost-rounded menu-btn" id="menuCheck" role="menuitem">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</button>
      <button class="ghost-rounded menu-btn" id="menuNew" role="menuitem">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
    </div>
  </header>
  <div class="wrap">

    <!-- –≠–∫—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã (–¥–ª—è –≤–µ–¥—É—â–µ–≥–æ) -->
    <main id="screenCreate" class="active" aria-live="polite">
      <section class="card">
        <h1>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</h1>
        <p class="muted">–ò–≥—Ä–∞ —Å—Ç–∞—Ä—Ç—É–µ—Ç –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è ¬´–ù–∞—á–∞—Ç—å –∏–≥—Ä—É¬ª –≤–µ–¥—É—â–∏–º.</p>
        <div class="field-gap">
          <label>–í–∞—à–µ –∏–º—è
            <input type="text" id="createName" maxlength="24" autocomplete="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ö–∞—Ç—è" aria-required="true" />
          </label>
          <label>ID –∫–æ–º–Ω–∞—Ç—ã
            <input type="text" id="createRoomId" maxlength="8" autocomplete="off" aria-required="true" />
          </label>
        </div>
        <div class="actions-row">
          <button id="btnCreateRoom" class="primary">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
          <span id="createError" class="muted" style="color:#ffb1c5;min-height:20px;" aria-live="assertive"></span>
        </div>
      </section>
    </main>

    <!-- –ù–û–í–´–ô –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω: —Ç–æ–ª—å–∫–æ –∏–º—è –∏ "–î–∞–ª–µ–µ" –ø—Ä–∏ –≤—Ö–æ–¥–µ –ø–æ —Å—Å—ã–ª–∫–µ -->
    <main id="screenNameOnly" aria-live="polite">
      <section class="card">
        <h1>–í–≤–µ–¥–∏—Ç–µ –∏–º—è</h1>
        <p class="muted">–ß—Ç–æ–±—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ, —É–∫–∞–∂–∏—Ç–µ —Å–≤–æ—ë –∏–º—è.</p>
        <div class="field-gap">
          <label>–í–∞—à–µ –∏–º—è
            <input type="text" id="nameOnly" maxlength="24" autocomplete="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –õ—ë—à–∞" aria-required="true" />
          </label>
        </div>
        <div class="actions-row">
          <button id="btnNameOnly" class="primary">–î–∞–ª–µ–µ</button>
          <span id="nameOnlyError" class="muted" style="color:#ffb1c5;min-height:20px;" aria-live="assertive"></span>
        </div>
      </section>
    </main>

    <!-- –≠–∫—Ä–∞–Ω –∏–≥—Ä—ã -->
    <main id="screenGame" aria-live="polite">
      <section class="card" id="shareSection">
        <div id="shareRow">
          <input type="text" id="shareLink" readonly aria-label="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–º–Ω–∞—Ç—É" />
          <button id="btnCopyLink" class="ghost-rounded">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
        </div>

        <div class="status-board">
          <span class="chip" id="connStatus">–°—Ç–∞—Ç—É—Å: –Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ</span>
          <span class="chip" id="timerChip" aria-live="polite" hidden>‚è± 60s</span>
          <span class="chip" id="progressChip" hidden>0/0</span>
          <span class="chip" id="roleChip" hidden>‚Äî</span>
        </div>

        <!-- –î–µ–π—Å—Ç–≤–∏—è –≤ –ª–æ–±–±–∏ –¥–ª—è –≤–µ–¥—É—â–µ–≥–æ -->
        <div id="lobbyActions" class="actions-row" style="display:none;margin-top:8px;">
          <button id="btnStartGame" class="primary">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
          <span id="lobbyHint" class="muted small"></span>
        </div>

        <div class="black-card" aria-live="polite">
          <div class="muted">–ß—ë—Ä–Ω–∞—è –∫–∞—Ä—Ç–∞</div>
          <div id="blackText" style="margin-top:10px;font-size:20px;line-height:1.5;">‚Äî</div>
        </div>
        <div class="muted small" id="hostSummary" aria-live="polite">–°—Ç–∞—Ç—É—Å: –æ–∂–∏–¥–∞–Ω–∏–µ.</div>

        <div class="section-title">
          <h2>–í–∞—à–∏ –∫–∞—Ä—Ç—ã</h2>
        </div>
        <div class="muted small" id="handHint" aria-live="polite">–û–∂–∏–¥–∞–µ–º —Ä–∞–∑–¥–∞—á—É.</div>
        <div class="cards-grid" id="handCards" style="margin-top:14px;"></div>

        <div id="submittedCard" class="winner-card" style="margin-top:16px;display:none;">
          <div class="muted small">–í—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏</div>
          <div id="submittedText" style="margin-top:8px;font-size:18px;line-height:1.45;">‚Äî</div>
        </div>

        <div class="section-title" style="margin-top:28px;">
          <h2>–û—Ç–≤–µ—Ç—ã –Ω–∞ —Å—Ç–æ–ª–µ</h2>
        </div>
        <div id="submissionsHint" class="muted small" aria-live="polite">–ñ–¥—ë–º –∏–≥—Ä–æ–∫–æ–≤.</div>
        <div id="submissionsList" class="cards-grid" style="margin-top:14px;"></div>

        <div id="resultBlock" class="winner-card" style="margin-top:28px;display:none;">
          <div class="muted small">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å —Ä–∞—É–Ω–¥–∞</div>
          <div id="winnerLine" style="margin-top:10px;font-size:18px;line-height:1.5;">‚Äî</div>
          <div class="actions-row" style="margin-top:16px;">
            <button id="btnNextRound" class="primary">–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥</button>
            <span id="resultHint" class="muted small"></span>
          </div>
        </div>
      </section>

      <section class="card" style="margin-top:18px;">
        <div class="section-title" style="margin:0 0 14px;">
          <h2>–ò–≥—Ä–æ–∫–∏</h2>
        </div>
        <div class="scroll" id="playersList" aria-live="polite"></div>
      </section>
    </main>
  </div>

  <div id="actionBar" class="hidden" role="status" aria-live="polite">
    <div id="actionHint">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ.</div>
    <button id="btnConfirm" class="primary" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <dialog id="dlgRules">
    <form method="dialog">
      <h2>–ü—Ä–∞–≤–∏–ª–∞</h2>
      <ol class="muted" style="line-height:1.6;">
        <li>–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä —Å–æ–∑–¥–∞—ë—Ç –∫–æ–º–Ω–∞—Ç—É, –¥–µ–ª–∏—Ç—Å—è —Å—Å—ã–ª–∫–æ–π –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –∏–≥—Ä–æ–π.</li>
        <li>–ö–∞–∂–¥—ã–π —Ä–∞—É–Ω–¥ –æ–¥–∏–Ω –∏–∑ –∏–≥—Ä–æ–∫–æ–≤ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤–µ–¥—É—â–∏–º –∏ –≤—ã–±–∏—Ä–∞–µ—Ç –ª—É—á—à—É—é –∫–∞—Ä—Ç—É.</li>
        <li>–í–µ–¥—É—â–∏–π –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –±–µ–ª—ã—Ö –∫–∞—Ä—Ç, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—É—á–∞—é—Ç –ø–æ 7 –∫–∞—Ä—Ç.</li>
        <li>–û—Ç–≤–µ—Ç—ã –∞–Ω–æ–Ω–∏–º–Ω—ã –¥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è. –¢–∞–π–º–µ—Ä —Ä–∞—É–Ω–¥–∞ ‚Äî 60 —Å–µ–∫—É–Ω–¥.</li>
        <li>–ü–æ–±–µ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç 1 –æ—á–∫–æ, —Ä–æ–ª–∏ –≤–µ–¥—É—â–µ–≥–æ —Ä–æ—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ –æ—á–µ—Ä–µ–¥–∏ –∏–≥—Ä–æ–∫–æ–≤.</li>
      </ol>
      <menu>
        <button class="ghost-rounded">–ó–∞–∫—Ä—ã—Ç—å</button>
      </menu>
    </form>
  </dialog>

  <dialog id="dlgDeck">
    <form method="dialog">
      <h2>–ö–æ–ª–æ–¥–∞</h2>
      <p class="muted">JSON-—Ñ–æ—Ä–º–∞—Ç: <span style="font-family:ui-monospace;">{"black":[],"white":[],"nsfwBlack":[],"nsfwWhite":[]}</span>. –ú–∏–Ω–∏–º—É–º 120 —á—ë—Ä–Ω—ã—Ö –∏ 500 –±–µ–ª—ã—Ö.</p>
      <textarea id="deckJson" rows="12"></textarea>
      <menu style="margin-top:16px;justify-content:space-between;align-items:center;">
        <div style="display:flex;gap:10px;">
          <button type="button" class="ghost-rounded" id="btnImportDeck">–ò–º–ø–æ—Ä—Ç‚Ä¶</button>
          <button type="button" class="ghost-rounded" id="btnExportDeck">–≠–∫—Å–ø–æ—Ä—Ç</button>
          <button type="button" class="ghost-rounded" id="btnResetDeck">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
        <div style="display:flex;gap:10px;">
          <button class="ghost-rounded">–ó–∞–∫—Ä—ã—Ç—å</button>
          <button type="button" class="primary" id="btnSaveDeck">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </menu>
    </form>
  </dialog>

  <dialog id="dlgTests">
    <form method="dialog">
      <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</h2>
      <pre id="testsOutput" style="font-family:ui-monospace;white-space:pre-wrap;font-size:13px;line-height:1.5;">‚Äî</pre>
      <menu style="margin-top:16px;">
        <button class="ghost-rounded">–ó–∞–∫—Ä—ã—Ç—å</button>
      </menu>
    </form>
  </dialog>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
  const STATUS = { LOBBY:'lobby', COLLECT:'collect', RESULT:'result' };
  const MIN_PLAYERS = 2;
  const ROUNDS_TOTAL = 10;
  const ROUND_TIMER_SECONDS = 60;
  const STORAGE_KEY = 'zlobnye_karty_deck_v2';
  const EVENTS_PATH = 'events';
  const AUTO_START = false;

  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));
  const uid = ()=>Math.random().toString(36).slice(2,10);
  const now = ()=>Date.now();
  const shuffle = arr=>{ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; };
  const escapeHtml = str=>{ const map={ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }; return String(str||'').replace(/[&<>"']/g,ch=>map[ch]); };
  const fillBlack = (black,white)=>{ const safe=escapeHtml(white||'‚Äî'); return (black||'').includes('____') ? (black||'‚Äî').replace('____',`<b>${safe}</b>`) : `${escapeHtml(black||'‚Äî')} ‚Äî <b>${safe}</b>`; };
  const copyToClipboard = async(text)=>{ try{ await navigator.clipboard.writeText(text); toast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'); }catch(e){ showError(e); } };

  let toastTimer=null;
  function toast(msg){ const el=$('#toast'); if(!el) return; el.textContent=msg; el.classList.add('show'); clearTimeout(toastTimer); toastTimer=setTimeout(()=>el.classList.remove('show'),2400); }
  function normalizeError(err){ if(!err) return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'; if(typeof err==='string') return err; const code=err.code||''; if(code.includes('network')) return '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Firebase.'; if(code.includes('permission')) return '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ Firebase.'; if(code.includes('timeout')) return '–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ.'; return err.message||'–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫.'; }
  function showError(err){ console.error(err); toast('–û—à–∏–±–∫–∞: '+normalizeError(err)); }

  const DEMO_DECK={ black:[
    '–õ—É—á—à–µ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ –æ—Ç –ø–ª–æ—Ö–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è ‚Äî ____.',
    '–í –æ—Ñ–∏—Å–µ –∑–∞–ø—Ä–µ—Ç–∏–ª–∏ ____ –ø–æ—Å–ª–µ –ø—Ä–æ—à–ª–æ–π –≤–µ—á–µ—Ä–∏–Ω–∫–∏.',
    '–ú–æ–π —Ç–∞–π–Ω—ã–π —Ç–∞–ª–∞–Ω—Ç ‚Äî ____.',
    '–ö–æ–º–±–æ –¥–Ω—è: ____ —Å —Å–æ—É—Å–æ–º –∏–∑ ____.',
    '–ù–∞ –ø–µ—Ä–≤–æ–º —Å–≤–∏–¥–∞–Ω–∏–∏ –Ω–µ —Å–æ–≤–µ—Ç—É—é –æ–±—Å—É–∂–¥–∞—Ç—å ____.',
    '–£—á—ë–Ω—ã–µ –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ –ø—Ä–∏–¥—É–º–∞–ª–∏ ____.',
    '–°–∞–º–æ–µ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ –≤ –ø–æ–¥–∞—Ä–æ–∫ ‚Äî ____.',
    '–ù–æ–≤–æ–µ —Ö–æ–±–±–∏, –æ –∫–æ—Ç–æ—Ä–æ–º —Å—Ç—ã–¥–Ω–æ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è–º: ____.',
    '–ó–∞–≤—Ç—Ä–∞–∫ —á–µ–º–ø–∏–æ–Ω–∞ ‚Äî ____.',
    '–ü—É—Ç—å –∫ —É—Å–ø–µ—Ö—É –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å ____.',
  ], white:[
    '–π–æ–≥–∞ –ø—Ä–∏ —Å–≤–µ—Ç–µ –ª–∞–º–ø—ã','–±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ –º–µ–º—ã','–∫–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å—É–¥–∏—Ç —Ç–µ–±—è','–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ 200 —Å–ª–∞–π–¥–æ–≤','–∑–≤—É–∫–∏ –ª–µ—Å–∞ –≤ 3 —á–∞—Å–∞ –Ω–æ—á–∏','–º–∏–∫—Ä–æ–¥–æ–∑—ã —ç–Ω—Ç—É–∑–∏–∞–∑–º–∞','–µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫ –Ω–∞ 2035 –≥–æ–¥','–∫–æ—Ñ–µ —É—Ä–æ–≤–Ω—è –±–æ—Å—Å','—Ç–∞–Ω–µ—Ü —Å –ø—ã–ª–µ—Å–æ—Å–æ–º','—Å—Ä–æ—á–Ω—ã–π —Å–æ–∑–≤–æ–Ω –Ω–∏ –æ —á—ë–º','–ø–µ—Ä–µ–ø–∏—Å–∫–∞ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π','–∑–∞—Ä—è–¥–∫–∞ –¥–ª—è –ª–∏—Ü–∞ –∏ —Å–æ–≤–µ—Å—Ç–∏','–ø–æ–¥–∫–∞—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–∏–∫—Ç–æ –Ω–µ —Å–ª—É—à–∞–µ—Ç','–∫–æ–ª–ª–µ–∫—Ü–∏—è –Ω–µ—Å–±—ã–≤—à–∏—Ö—Å—è —Ü–µ–ª–µ–π','–ø–ª–µ–¥ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏','—É–¥–∞–ª—ë–Ω–Ω–∞—è –ø—è—Ç–Ω–∏—Ü–∞','–∑–∞–≥–∞–¥–æ—á–Ω—ã–π –¥–µ–¥–ª–∞–π–Ω','–Ω–æ—á–Ω–æ–π –ø–æ—Ö–æ–¥ –≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫','—Ç–∏–∫-—Ç–æ–∫ –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö ‚Äî —á—Ç–µ–Ω–∏–µ','—Å–ª—É—á–∞–π–Ω—ã–π –∞–∫—Ç –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏'
  ], nsfwBlack:[], nsfwWhite:[] };

  function ensureMinimumDeck(base){
    const MIN_BLACK=120, MIN_WHITE=500;
    const adj=['–±–µ—Å–∫–æ–º–ø—Ä–æ–º–∏—Å—Å–Ω—ã–π','–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π','—Å–∫—Ä–æ–º–Ω—ã–π','—Ö—Ä—É–ø–∫–∏–π','—Å—Ç–∞–ª—å–Ω–æ–π','–º—è–≥–∫–∏–π','–Ω–µ—É–¥–æ–±–Ω—ã–π','—É–¥–∏–≤–∏—Ç–µ–ª—å–Ω—ã–π','–∫–æ—Å–º–∏—á–µ—Å–∫–∏–π','—Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–π','–Ω—É–ª–µ–≤–æ–π','—Å–ª—É—á–∞–π–Ω—ã–π','–¥–æ–º–∞—à–Ω–∏–π','—Ç—É—Ä–±–æ','–∞–Ω—Ç–∏—Å—Ç—Ä–µ—Å—Å','—á–∏—Å—Ç–æ—Å–µ—Ä–¥–µ—á–Ω—ã–π','–±–æ—Ç–∞–Ω—Å–∫–∏–π','–∫–∞—Ä–º–∞–Ω–Ω—ã–π','–ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π','–≥—Ä—É—Å—Ç–Ω—ã–π','–≥–µ—Ä–æ–∏—á–µ—Å–∫–∏–π','–≤–∏–Ω–æ–≤–∞—Ç—ã–π','—Å—Ç—Ä–∞–Ω–Ω—ã–π','–ø–∞–Ω–∏—á–µ—Å–∫–∏–π','–æ—Å–æ–∑–Ω–∞–Ω–Ω—ã–π','–≤–∞—Ñ–µ–ª—å–Ω—ã–π','—ç–∫–æ–ª–æ–≥–∏—á–Ω—ã–π','—É–º–Ω—ã–π','—Å–≤–µ—Ä—Ö–≤–∞–∂–Ω—ã–π','–Ω–µ–æ–±—ä—è—Å–Ω–∏–º—ã–π'];
    const noun=['–∫–∞–∫—Ç—É—Å','–µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫','–∫–µ–∫—Å','–ø–ª–µ–¥','—Ä–∏–º–µ–π–∫ –¥–µ—Ç—Å—Ç–≤–∞','–∫–æ—Ç –≤ –∫–æ—Ä–æ–±–∫–µ','—Ç–∞–Ω–µ—Ü –ø–æ–±–µ–¥–∏—Ç–µ–ª—è','—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–∏—Ç—É–∞–ª','–ø–ª–∞–Ω –ë','–∑—É–º-—Å–æ–∑–≤–æ–Ω','–º–∞—Ä–∞—Ñ–æ–Ω —Å–µ—Ä–∏–∞–ª–æ–≤','–ø–∞–∫–µ—Ç –±–∞–≥–æ–≤','–¥–∏–≤–∞–Ω–Ω—ã–π —Å—Ç–∞—Ä—Ç–∞–ø','–∞–ø–¥–µ–π—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è','—á–∞–π –±–µ–∑ —Å–∞—Ö–∞—Ä–∞','—Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã','–Ω–µ–ª–æ–≤–∫–∞—è –ø–∞—É–∑–∞','—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å','–ø–µ—Ä–µ—Ä—ã–≤ –Ω–∞ —Å–µ–±—è','–ø–æ—Ö–≤–∞–ª–∞ —Å–∞–º–æ–º—É —Å–µ–±–µ','–∫–∞—Ä—Ç–∞ –∂–µ–ª–∞–Ω–∏–π','—Ñ–∞–Ω—Ç–∞–∑–∏—è','—á–∏—Å—Ç—ã–π —Å—Ç–æ–ª','–Ω–æ–≤—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','—Ç–∞–π–º–µ—Ä –Ω–∞ 5 –º–∏–Ω—É—Ç','–ø–∏—â–∞ –¥–ª—è —É–º–∞','—Å–æ–Ω –¥–Ω—ë–º','—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–∞ —Ä–∞—Å—Ç—è–∂–∫—É','–≤–¥–æ—Ö —á–µ—Ä–µ–∑ –Ω–æ—Å','–º–æ–ª—á–∞–ª–∏–≤–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ'];
    const tails=['–≤ –ø–æ–¥–∞—Ä–æ–∫','–≤ 3 —á–∞—Å–∞ –Ω–æ—á–∏','–ø–æ –ø–æ–¥–ø–∏—Å–∫–µ','–Ω–∞ —Å–∫–æ—Ä—É—é —Ä—É–∫—É','–≤ —Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ','–±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π','—Å –¥–æ—Å—Ç–∞–≤–∫–æ–π –∑–∞–≤—Ç—Ä–∞','–ø–æ –ª—é–±–≤–∏','–Ω–∞ —É–¥–∞–ª—ë–Ω–∫–µ','—Å –∑–∞–∫—Ä—ã—Ç—ã–º–∏ –≥–ª–∞–∑–∞–º–∏','—Å –æ–¥–æ–±—Ä–µ–Ω–∏—è –∫–æ—Ç–∞','–≤–º–µ—Å—Ç–æ —Å–ø–æ—Ä—Ç–∞','–≤ —Ö–æ—Ä–æ—à–µ–º —Å–º—ã—Å–ª–µ','–±–µ–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏','—Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ —É—Å–∏–ª–∏—è–º–∏','–≤ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–µ–∫—É–Ω–¥—É','—Å –≤–∏–¥–æ–º –Ω–∞ –∫—É—Ö–Ω—é','–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ä–∞–∑—É–º–Ω–æ–≥–æ','–Ω–∞ –ø–æ–ª–Ω–æ–º —Å–µ—Ä—å—ë–∑–µ','–¥–ª—è –≥–∞–ª–æ—á–∫–∏','—Å –æ–≥–æ–Ω—å–∫–æ–º','–ø–æ –≤—ã—Ö–æ–¥–Ω—ã–º','–¥–ª—è –¥—É—à–∏','–ø–æ–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ','–∫–∞–∫-–Ω–∏–±—É–¥—å –ø–æ—Ç–æ–º','–ø–æ –ø—Ä–∏–∫–æ–ª—É','–ø–æ —Å—Ç–∞—Ä–æ–π –ø–∞–º—è—Ç–∏','–±–µ–∑ –ø—Ä–∏—á–∏–Ω'];
    const seeds=['–ú–æ–π –¥–µ–Ω—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å ____.','–ù–∞ —Å–æ–≤–µ—â–∞–Ω–∏–∏ –ª—É—á—à–µ –Ω–µ –æ–±—Å—É–∂–¥–∞—Ç—å ____.','–°–µ–∫—Ä–µ—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî ____.','–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –ø–ª–∞–Ω: –∫–æ—Ñ–µ, –¥–µ–ª–∞ –∏ ____.','–°–∞–º—ã–π —Å—Ç—Ä–∞–Ω–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ ‚Äî ____.','–Ø –±—ã —Å —Ä–∞–¥–æ—Å—Ç—å—é –∑–∞–º–µ–Ω–∏–ª(–∞) –≥–∏–º–Ω –Ω–∞ ____.','–ö–æ–≥–¥–∞ –Ω–∏–∫—Ç–æ –Ω–µ –≤–∏–¥–∏—Ç, —è –ø—Ä–∞–∫—Ç–∏–∫—É—é ____.','–õ—É—á—à–µ–µ, —á—Ç–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ —Ä–µ–∑—é–º–µ ‚Äî ____.','–ò–¥–µ–∞–ª—å–Ω–æ–µ –∞–ª–∏–±–∏: ____.','–ì–ª–∞–≤–Ω—ã–π –∞–Ω—Ç–∏—Å—Ç—Ä–µ—Å—Å ‚Äî ____.','–°–ø–æ—Ä–∏–º, –≤ 2035 –º—ã –±—É–¥–µ–º –ø–ª–∞—Ç–∏—Ç—å –∑–∞ ____.','–í –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–º —á–∞—Ç–µ –∑–∞–±–∞–Ω–∏–ª–∏ —Ç–µ–º—É ____.','–ì–ª–∞–≤–Ω–∞—è —Ñ–∏—á–∞ –Ω–æ–≤–æ–≥–æ –∞–π—Ñ–æ–Ω–∞ ‚Äî ____.','–ï—Å–ª–∏ –±—ã —É –º–µ–Ω—è –±—ã–ª —Å–ª–æ–≥–∞–Ω, –æ–Ω –±—ã –±—ã–ª –ø—Ä–æ ____.','–ù–∞ TED —è –≤—ã—Å—Ç—É–ø–ª—é –ø—Ä–æ ____.','–ú–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫—Ä–∏—Ç–∏–∫ –æ–±–æ–∂–∞–µ—Ç ____.','–®–µ—Ñ –º–µ—á—Ç–∞–µ—Ç –≤–Ω–µ–¥—Ä–∏—Ç—å ____.','User story –Ω–∞ —Å–µ–≥–æ–¥–Ω—è ‚Äî ____.','–Ø –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –æ—Ç–∫–∞–∑—ã–≤–∞—é—Å—å –æ—Ç ____.','–°–µ–≥–æ–¥–Ω—è –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è –≤—Å—ë, –∫—Ä–æ–º–µ ____.'];
    const needW=Math.max(0,MIN_WHITE-(base.white?.length||0));
    for(let i=0;i<needW;i++){ base.white.push(`${adj[i%adj.length]} ${noun[(i*7)%noun.length]} ${tails[(i*13)%tails.length]}`); }
    const needB=Math.max(0,MIN_BLACK-(base.black?.length||0));
    for(let i=0;i<needB;i++){ base.black.push(seeds[i%seeds.length]); }
  }

  const game={
    state:{ status:STATUS.LOBBY, round:0, roundsTotal:ROUNDS_TOTAL, blackCard:'', lastWinnerName:'', lastAnswer:'', currentHostPid:null, currentHostName:'', timerEndsAt:null },
    players:{},
    playersOrder:[],
    submissions:{},
    submissionsOrder:[],
    deck:{ black:[], white:[], discardBlack:[], discardWhite:[] }
  };

  const local={
    playerId: localStorage.getItem('playerId') || uid(),
    roomId:null,
    name:'',
    isCreator:false,
    hasSubmitted:false,
    selectedIndex:null,
    selectedText:'',
    submittedText:'',
    timerInterval:null,
    autoPickFired:false,
    activeHand:[]
  };
  localStorage.setItem('playerId', local.playerId);

  const FIREBASE_CONFIG={
    apiKey:"AIzaSyDRtpegXwTsSf77–¥PIOGDIyBFvib_GgUcM",
    authDomain:"z-e86ee.firebaseapp.com",
    databaseURL:"https://z-e86ee-default-rtdb.europe-west1.firebasedatabase.app",
    projectId:"z-e86ee",
    storageBucket:"z-e86ee.appspot.com",
    messagingSenderId:"268263276853",
    appId:"1:268263276853:web:0195c839f5dd38e7214c7c",
    measurementId:"G-6ZBVR66GZE"
  };

  let db=null, firebaseInitError=null, connectivityOk=false, lastConnMsg='';
  try{ firebase.initializeApp(FIREBASE_CONFIG); db=firebase.database(); }catch(e){ firebaseInitError=e; console.error('Firebase init error',e); }

  // ===== Firebase helpers =====
  const roomRef=()=>db.ref(`rooms/${local.roomId}`);
  const stateRef=()=>roomRef().child('state');
  const playersRef=()=>roomRef().child('players');
  const orderRef=()=>roomRef().child('playersOrder');
  const submissionsRef=()=>roomRef().child('submissions');
  const perPlayerRef=(pid)=>roomRef().child(`perPlayer/${pid}`);
  const deckRef=()=>roomRef().child('deck');
  const eventsRef=()=>roomRef().child('events');

  const $focus = (el)=>{ try{ el?.focus({preventScroll:true}); }catch{} };

  const MIN_PLAYERS = 2;

  const uid = ()=>Math.random().toString(36).slice(2,10);
  const now = ()=>Date.now();
  const shuffle = arr=>{ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; };

  function orderedPlayerIds(players){
    return Object.keys(players||{}).sort((a,b)=>{
      const pa=players[a]||{}, pb=players[b]||{};
      const ja=pa.joinedAt||0, jb=pb.joinedAt||0;
      if(ja!==jb) return ja-jb;
      return a.localeCompare(b);
    });
  }
  function activeOrder(){
    const players=game.players||{};
    return (game.playersOrder||[]).filter(id=>players[id]?.active!==false);
  }
  function nextHostId(order,current){
    if(!Array.isArray(order) || !order.length) return null;
    if(!current) return order[0];
    const idx=order.indexOf(current);
    return idx===-1 ? order[0] : order[(idx+1)%order.length];
  }
  function expectedSubmissions(){ return Math.max(0, activeOrder().length - 1); }

  function unsubscribeAll(){ if(!local.roomId||!db) return; stateRef().off(); playersRef().off(); orderRef().off(); submissionsRef().off(); perPlayerRef(local.playerId).off(); eventsRef().off(); deckRef().off(); }

  async function testDbConnection(){
    if(!db){ lastConnMsg='Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'; updateConnStatus(false,lastConnMsg); return false; }
    try{
      const ping=db.ref('_ping').push();
      await ping.set({ t:now(), ua:navigator.userAgent.slice(0,80) });
      await ping.remove();
      lastConnMsg='OK: –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ Realtime DB';
      updateConnStatus(true,lastConnMsg);
      return true;
    }catch(e){
      lastConnMsg='–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: '+(e?.message||'');
      updateConnStatus(false,lastConnMsg);
      return false;
    }
  }
  function updateConnStatus(ok,msg){ const el=$('#connStatus'); if(!el) return; el.textContent='–°—Ç–∞—Ç—É—Å: '+(ok?'–ø–æ–¥–∫–ª—é—á–µ–Ω–æ':'–æ—à–∏–±–∫–∞'); el.title=msg||''; el.style.background=ok?'var(--accent-2)':'var(--chip)'; }

  // ===== Deck helpers =====
  const DEMO_DECK={ black:[
    '–õ—É—á—à–µ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ –æ—Ç –ø–ª–æ—Ö–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è ‚Äî ____.',
    '–í –æ—Ñ–∏—Å–µ –∑–∞–ø—Ä–µ—Ç–∏–ª–∏ ____ –ø–æ—Å–ª–µ –ø—Ä–æ—à–ª–æ–π –≤–µ—á–µ—Ä–∏–Ω–∫–∏.',
    '–ú–æ–π —Ç–∞–π–Ω—ã–π —Ç–∞–ª–∞–Ω—Ç ‚Äî ____.',
    '–ö–æ–º–±–æ –¥–Ω—è: ____ —Å —Å–æ—É—Å–æ–º –∏–∑ ____.',
    '–ù–∞ –ø–µ—Ä–≤–æ–º —Å–≤–∏–¥–∞–Ω–∏–∏ –Ω–µ —Å–æ–≤–µ—Ç—É—é –æ–±—Å—É–∂–¥–∞—Ç—å ____.',
    '–£—á—ë–Ω—ã–µ –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ –ø—Ä–∏–¥—É–º–∞–ª–∏ ____.',
    '–°–∞–º–æ–µ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ –≤ –ø–æ–¥–∞—Ä–æ–∫ ‚Äî ____.',
    '–ù–æ–≤–æ–µ —Ö–æ–±–±–∏, –æ –∫–æ—Ç–æ—Ä–æ–º —Å—Ç—ã–¥–Ω–æ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è–º: ____.',
    '–ó–∞–≤—Ç—Ä–∞–∫ —á–µ–º–ø–∏–æ–Ω–∞ ‚Äî ____.',
    '–ü—É—Ç—å –∫ —É—Å–ø–µ—Ö—É –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å ____.',
  ], white:[
    '–π–æ–≥–∞ –ø—Ä–∏ —Å–≤–µ—Ç–µ –ª–∞–º–ø—ã','–±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ –º–µ–º—ã','–∫–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å—É–¥–∏—Ç —Ç–µ–±—è','–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ 200 —Å–ª–∞–π–¥–æ–≤','–∑–≤—É–∫–∏ –ª–µ—Å–∞ –≤ 3 —á–∞—Å–∞ –Ω–æ—á–∏','–º–∏–∫—Ä–æ–¥–æ–∑—ã —ç–Ω—Ç—É–∑–∏–∞–∑–º–∞','–µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫ –Ω–∞ 2035 –≥–æ–¥','–∫–æ—Ñ–µ —É—Ä–æ–≤–Ω—è –±–æ—Å—Å','—Ç–∞–Ω–µ—Ü —Å –ø—ã–ª–µ—Å–æ—Å–æ–º','—Å—Ä–æ—á–Ω—ã–π —Å–æ–∑–≤–æ–Ω –Ω–∏ –æ —á—ë–º','–ø–µ—Ä–µ–ø–∏—Å–∫–∞ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π','–∑–∞—Ä—è–¥–∫–∞ –¥–ª—è –ª–∏—Ü–∞ –∏ —Å–æ–≤–µ—Å—Ç–∏','–ø–æ–¥–∫–∞—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–∏–∫—Ç–æ –Ω–µ —Å–ª—É—à–∞–µ—Ç','–∫–æ–ª–ª–µ–∫—Ü–∏—è –Ω–µ—Å–±—ã–≤—à–∏—Ö—Å—è —Ü–µ–ª–µ–π','–ø–ª–µ–¥ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏','—É–¥–∞–ª—ë–Ω–Ω–∞—è –ø—è—Ç–Ω–∏—Ü–∞','–∑–∞–≥–∞–¥–æ—á–Ω—ã–π –¥–µ–¥–ª–∞–π–Ω','–Ω–æ—á–Ω–æ–π –ø–æ—Ö–æ–¥ –≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫','—Ç–∏–∫-—Ç–æ–∫ –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö ‚Äî —á—Ç–µ–Ω–∏–µ','—Å–ª—É—á–∞–π–Ω—ã–π –∞–∫—Ç –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏'
  ], nsfwBlack:[], nsfwWhite:[] };

  function ensureMinimumDeck(base){
    const MIN_BLACK=120, MIN_WHITE=500;
    const adj=['–±–µ—Å–∫–æ–º–ø—Ä–æ–º–∏—Å—Å–Ω—ã–π','–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π','—Å–∫—Ä–æ–º–Ω—ã–π','—Ö—Ä—É–ø–∫–∏–π','—Å—Ç–∞–ª—å–Ω–æ–π','–º—è–≥–∫–∏–π','–Ω–µ—É–¥–æ–±–Ω—ã–π','—É–¥–∏–≤–∏—Ç–µ–ª—å–Ω—ã–π','–∫–æ—Å–º–∏—á–µ—Å–∫–∏–π','—Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–π','–Ω—É–ª–µ–≤–æ–π','—Å–ª—É—á–∞–π–Ω—ã–π','–¥–æ–º–∞—à–Ω–∏–π','—Ç—É—Ä–±–æ','–∞–Ω—Ç–∏—Å—Ç—Ä–µ—Å—Å','—á–∏—Å—Ç–æ—Å–µ—Ä–¥–µ—á–Ω—ã–π','–±–æ—Ç–∞–Ω—Å–∫–∏–π','–∫–∞—Ä–º–∞–Ω–Ω—ã–π','–ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π','–≥—Ä—É—Å—Ç–Ω—ã–π','–≥–µ—Ä–æ–∏—á–µ—Å–∫–∏–π','–≤–∏–Ω–æ–≤–∞—Ç—ã–π','—Å—Ç—Ä–∞–Ω–Ω—ã–π','–ø–∞–Ω–∏—á–µ—Å–∫–∏–π','–æ—Å–æ–∑–Ω–∞–Ω–Ω—ã–π','–≤–∞—Ñ–µ–ª—å–Ω—ã–π','—ç–∫–æ–ª–æ–≥–∏—á–Ω—ã–π','—É–º–Ω—ã–π','—Å–≤–µ—Ä—Ö–≤–∞–∂–Ω—ã–π','–Ω–µ–æ–±—ä—è—Å–Ω–∏–º—ã–π'];
    const noun=['–∫–∞–∫—Ç—É—Å','–µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫','–∫–µ–∫—Å','–ø–ª–µ–¥','—Ä–∏–º–µ–π–∫ –¥–µ—Ç—Å—Ç–≤–∞','–∫–æ—Ç –≤ –∫–æ—Ä–æ–±–∫–µ','—Ç–∞–Ω–µ—Ü –ø–æ–±–µ–¥–∏—Ç–µ–ª—è','—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–∏—Ç—É–∞–ª','–ø–ª–∞–Ω –ë','–∑—É–º-—Å–æ–∑–≤–æ–Ω','–º–∞—Ä–∞—Ñ–æ–Ω —Å–µ—Ä–∏–∞–ª–æ–≤','–ø–∞–∫–µ—Ç –±–∞–≥–æ–≤','–¥–∏–≤–∞–Ω–Ω—ã–π —Å—Ç–∞—Ä—Ç–∞–ø','–∞–ø–¥–µ–π—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è','—á–∞–π –±–µ–∑ —Å–∞—Ö–∞—Ä–∞','—Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã','–Ω–µ–ª–æ–≤–∫–∞—è –ø–∞—É–∑–∞','—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å','–ø–µ—Ä–µ—Ä—ã–≤ –Ω–∞ —Å–µ–±—è','–ø–æ—Ö–≤–∞–ª–∞ —Å–∞–º–æ–º—É —Å–µ–±–µ','–∫–∞—Ä—Ç–∞ –∂–µ–ª–∞–Ω–∏–π','—Ñ–∞–Ω—Ç–∞–∑–∏—è','—á–∏—Å—Ç—ã–π —Å—Ç–æ–ª','–Ω–æ–≤—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','—Ç–∞–π–º–µ—Ä –Ω–∞ 5 –º–∏–Ω—É—Ç','–ø–∏—â–∞ –¥–ª—è —É–º–∞','—Å–æ–Ω –¥–Ω—ë–º','—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–∞ —Ä–∞—Å—Ç—è–∂–∫—É','–≤–¥–æ—Ö —á–µ—Ä–µ–∑ –Ω–æ—Å','–º–æ–ª—á–∞–ª–∏–≤–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ'];
    const tails=['–≤ –ø–æ–¥–∞—Ä–æ–∫','–≤ 3 —á–∞—Å–∞ –Ω–æ—á–∏','–ø–æ –ø–æ–¥–ø–∏—Å–∫–µ','–Ω–∞ —Å–∫–æ—Ä—É—é —Ä—É–∫—É','–≤ —Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ','–±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π','—Å –¥–æ—Å—Ç–∞–≤–∫–æ–π –∑–∞–≤—Ç—Ä–∞','–ø–æ –ª—é–±–≤–∏','–Ω–∞ —É–¥–∞–ª—ë–Ω–∫–µ','—Å –∑–∞–∫—Ä—ã—Ç—ã–º–∏ –≥–ª–∞–∑–∞–º–∏','—Å –æ–¥–æ–±—Ä–µ–Ω–∏—è –∫–æ—Ç–∞','–≤–º–µ—Å—Ç–æ —Å–ø–æ—Ä—Ç–∞','–≤ —Ö–æ—Ä–æ—à–µ–º —Å–º—ã—Å–ª–µ','–±–µ–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏','—Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ —É—Å–∏–ª–∏—è–º–∏','–≤ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–µ–∫—É–Ω–¥—É','—Å –≤–∏–¥–æ–º –Ω–∞ –∫—É—Ö–Ω—é','–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ä–∞–∑—É–º–Ω–æ–≥–æ','–Ω–∞ –ø–æ–ª–Ω–æ–º —Å–µ—Ä—å—ë–∑–µ','–¥–ª—è –≥–∞–ª–æ—á–∫–∏','—Å –æ–≥–æ–Ω—å–∫–æ–º','–ø–æ –≤—ã—Ö–æ–¥–Ω—ã–º','–¥–ª—è –¥—É—à–∏','–ø–æ–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ','–∫–∞–∫-–Ω–∏–±—É–¥—å –ø–æ—Ç–æ–º','–ø–æ –ø—Ä–∏–∫–æ–ª—É','–ø–æ —Å—Ç–∞—Ä–æ–π –ø–∞–º—è—Ç–∏','–±–µ–∑ –ø—Ä–∏—á–∏–Ω'];
    const seeds=['–ú–æ–π –¥–µ–Ω—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å ____.','–ù–∞ —Å–æ–≤–µ—â–∞–Ω–∏–∏ –ª—É—á—à–µ –Ω–µ –æ–±—Å—É–∂–¥–∞—Ç—å ____.','–°–µ–∫—Ä–µ—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî ____.','–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –ø–ª–∞–Ω: –∫–æ—Ñ–µ, –¥–µ–ª–∞ –∏ ____.','–°–∞–º—ã–π —Å—Ç—Ä–∞–Ω–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ ‚Äî ____.','–Ø –±—ã —Å —Ä–∞–¥–æ—Å—Ç—å—é –∑–∞–º–µ–Ω–∏–ª(–∞) –≥–∏–º–Ω –Ω–∞ ____.','–ö–æ–≥–¥–∞ –Ω–∏–∫—Ç–æ –Ω–µ –≤–∏–¥–∏—Ç, —è –ø—Ä–∞–∫—Ç–∏–∫—É—é ____.','–õ—É—á—à–µ–µ, —á—Ç–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ —Ä–µ–∑—é–º–µ ‚Äî ____.','–ò–¥–µ–∞–ª—å–Ω–æ–µ –∞–ª–∏–±–∏: ____.','–ì–ª–∞–≤–Ω—ã–π –∞–Ω—Ç–∏—Å—Ç—Ä–µ—Å—Å ‚Äî ____.','–°–ø–æ—Ä–∏–º, –≤ 2035 –º—ã –±—É–¥–µ–º –ø–ª–∞—Ç–∏—Ç—å –∑–∞ ____.','–í –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–º —á–∞—Ç–µ –∑–∞–±–∞–Ω–∏–ª–∏ —Ç–µ–º—É ____.','–ì–ª–∞–≤–Ω–∞—è —Ñ–∏—á–∞ –Ω–æ–≤–æ–≥–æ –∞–π—Ñ–æ–Ω–∞ ‚Äî ____.','–ï—Å–ª–∏ –±—ã —É –º–µ–Ω—è –±—ã–ª —Å–ª–æ–≥–∞–Ω, –æ–Ω –±—ã –±—ã–ª –ø—Ä–æ ____.','–ù–∞ TED —è –≤—ã—Å—Ç—É–ø–ª—é –ø—Ä–æ ____.','–ú–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫—Ä–∏—Ç–∏–∫ –æ–±–æ–∂–∞–µ—Ç ____.','–®–µ—Ñ –º–µ—á—Ç–∞–µ—Ç –≤–Ω–µ–¥—Ä–∏—Ç—å ____.','User story –Ω–∞ —Å–µ–≥–æ–¥–Ω—è ‚Äî ____.','–Ø –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –æ—Ç–∫–∞–∑—ã–≤–∞—é—Å—å –æ—Ç ____.','–°–µ–≥–æ–¥–Ω—è –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è –≤—Å—ë, –∫—Ä–æ–º–µ ____.'];
    const needW=Math.max(0,MIN_WHITE-(base.white?.length||0));
    for(let i=0;i<needW;i++){ base.white.push(`${adj[i%adj.length]} ${noun[(i*7)%noun.length]} ${tails[(i*13)%tails.length]}`); }
    const needB=Math.max(0,MIN_BLACK-(base.black?.length||0));
    for(let i=0;i<needB;i++){ base.black.push(seeds[i%seeds.length]); }
  }

  function loadDeckLocal(){
    let base; const raw=localStorage.getItem(STORAGE_KEY);
    if(raw){ try{ base=JSON.parse(raw); }catch(e){ base=JSON.parse(JSON.stringify(DEMO_DECK)); } }
    else base=JSON.parse(JSON.stringify(DEMO_DECK));
    ensureMinimumDeck(base);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(base));
    game.deck.black=shuffle([...base.black]);
    game.deck.white=shuffle([...base.white]);
    game.deck.discardBlack=[];
    game.deck.discardWhite=[];
    if($('#deckJson')) $('#deckJson').value=JSON.stringify(base,null,2);
  }
  function drawBlack(){ if(!game.deck.black.length){ game.deck.black=shuffle([...game.deck.discardBlack]); game.deck.discardBlack=[]; } return game.deck.black.pop()||'‚Äî'; }
  function drawWhite(){ if(!game.deck.white.length){ game.deck.white=shuffle([...game.deck.discardWhite]); game.deck.discardWhite=[]; } return game.deck.white.pop()||'‚Äî'; }
  function topUpHand(hand,target=7){ const arr=[...(hand||[])]; while(arr.length<target){ arr.push(drawWhite()); } return arr; }

  // ===== Realtime listeners =====
  function unsubscribeAll(){ if(!local.roomId||!db) return; stateRef().off(); playersRef().off(); orderRef().off(); submissionsRef().off(); perPlayerRef(local.playerId).off(); eventsRef().off(); deckRef().off(); }

  function subscribeRoom(){
    if(!db || !local.roomId) return;
    unsubscribeAll();
    stateRef().on('value',snap=>{ const s=snap.val(); if(!s) return; game.state=s; renderState(); startTimerTick(); });
    playersRef().on('value',snap=>{ const players=snap.val()||{}; game.players=players; renderPlayers(); if(local.isCreator) syncPlayersOrder(); ensureHostValidity(); updateProgressChip(); if(AUTO_START) maybeAutoStart(); });
    orderRef().on('value',snap=>{ const arr=snap.val(); if(Array.isArray(arr)){ game.playersOrder=arr; ensureHostValidity(); updateProgressChip(); if(AUTO_START) maybeAutoStart(); } });
    submissionsRef().on('value',snap=>{ const map=snap.val()||{}; renderSubmissions(map); });
    perPlayerRef(local.playerId).on('value',snap=>{ const data=snap.val()||{hand:[],submitted:false,lastText:''}; local.activeHand=data.hand||[]; local.hasSubmitted=!!data.submitted; local.submittedText=data.lastText||''; renderHand(local.activeHand); updateHandState(); updateActionBar(); });
    if(local.isCreator){
      deckRef().on('value',snap=>{ const d=snap.val(); if(d){ game.deck.black=d.black||[]; game.deck.white=d.white||[]; game.deck.discardBlack=d.discardBlack||[]; game.deck.discardWhite=d.discardWhite||[]; } });
      eventsRef().on('child_added',handleHostEvent);
    }
  }

  // ===== Game flow =====
  function showScreen(id){ ['screenCreate','screenNameOnly','screenGame'].forEach(s=>$('#'+s).classList.remove('active')); $('#'+id).classList.add('active'); }
  function enterGameUI(){ showScreen('screenGame'); if(local.isCreator){ $('#shareRow').style.display='flex'; updateShareLink(); } else $('#shareRow').style.display='none'; }
  function updateShareLink(){ const url=new URL(location.href); url.searchParams.set('room', local.roomId); $('#shareLink').value=url.toString(); history.replaceState(null,'',url); }
  function validateNameValue(value){
    const trimmed=(value||'').trim();
    if(trimmed.length<2) throw new Error('–ò–º—è —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ.');
    if(/^[0-9]+$/.test(trimmed)) throw new Error('–ò–º—è –Ω–µ –º–æ–∂–µ—Ç —Å–æ—Å—Ç–æ—è—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ —Ü–∏—Ñ—Ä.');
    return trimmed.slice(0,24);
  }

  async function registerPlayer(name){
    const safe=name||localStorage.getItem('playerName')||`–ò–≥—Ä–æ–∫ ${local.playerId.slice(-4)}`;
    local.name=safe;
    localStorage.setItem('playerName', safe);
    const playerData={ name:safe, score:0, joinedAt:now(), active:true, isCreator:local.isCreator };
    const ref=playersRef().child(local.playerId);
    await ref.set(playerData);
    await ref.onDisconnect().update({ active:false, leftAt:now() });
    await perPlayerRef(local.playerId).set({ hand:[], submitted:false, lastText:'' });
    await perPlayerRef(local.playerId).onDisconnect().remove();
    if(!local.isCreator){
      await orderRef().transaction(order=>{ const list=Array.isArray(order)?order.filter(id=>id!==local.playerId):[]; if(!list.includes(local.playerId)) list.push(local.playerId); return list; });
      await eventsRef().push({ type:'needHand', playerId: local.playerId, t: now() });
    } else {
      await orderRef().set([local.playerId]);
    }
  }

  async function createRoom(){
    if(!db){ showError(firebaseInitError||'Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'); return; }
    if(!(connectivityOk || await testDbConnection())) return;
    try{
      const playerName=validateNameValue($('#createName').value);
      const roomId=($('#createRoomId').value||'').trim().toUpperCase();
      if(roomId.length<4) throw new Error('ID –∫–æ–º–Ω–∞—Ç—ã –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞.');
      local.roomId=roomId;
      local.isCreator=true;
      loadDeckLocal();
      await roomRef().set({ creatorId:local.playerId, createdAt:now() });
      await stateRef().set({ status:STATUS.LOBBY, round:0, roundsTotal:ROUNDS_TOTAL, blackCard:'', lastWinnerName:'', lastAnswer:'', currentHostPid:local.playerId, currentHostName:playerName, timerEndsAt:null });
      await deckRef().set({ black:game.deck.black, white:game.deck.white, discardBlack:game.deck.discardBlack, discardWhite:game.deck.discardWhite });
      await registerPlayer(playerName);
      subscribeRoom();
      enterGameUI();
      toast('–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞');
    }catch(e){ $('#createError').textContent=normalizeError(e); showError(e); }
  }

  async function joinRoomWithNameOnly(){
    if(!db){ showError(firebaseInitError||'Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'); return; }
    if(!(connectivityOk || await testDbConnection())) return;
    try{
      const playerName=validateNameValue($('#nameOnly').value);
      await registerPlayer(playerName);
      subscribeRoom();
      enterGameUI();
      toast('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ');
    }catch(e){ $('#nameOnlyError').textContent=normalizeError(e); showError(e); }
  }

  async function handleHostEvent(snap){
    const ev=snap.val(); const key=snap.key;
    if(!ev) return;
    try{
      if(ev.type==='needHand') await hostGiveHand(ev.playerId);
      if(ev.type==='pickWinner') await hostPickWinner(ev.submissionId);
      if(ev.type==='autoPick') await hostAutoPick(ev.submissionId||null);
      if(ev.type==='nextRound') await advanceRound();
    }catch(e){ showError(e); }
    finally{ eventsRef().child(key).remove(); }
  }

  async function hostGiveHand(pid){
    if(!pid) return;
    const player=(await playersRef().child(pid).get()).val();
    if(!player || player.active===false) return;
    const currentHost=game.state.currentHostPid;
    const snap=await perPlayerRef(pid).get();
    const data=snap.val()||{hand:[],submitted:false,lastText:''};
    const shouldHaveCards = pid!==currentHost && player.active!==false;
    const hand = shouldHaveCards ? topUpHand(data.hand||[]) : [];
    await perPlayerRef(pid).set({ hand, submitted:false, lastText:'' });
    await deckRef().set({ black:game.deck.black, white:game.deck.white, discardBlack:game.deck.discardBlack, discardWhite:game.deck.discardWhite });
  }

  async function hostPickWinner(submissionId){
    if(!submissionId) return;
    const state=(await stateRef().get()).val();
    if(!state || state.status!==STATUS.COLLECT) return;
    const submissions=(await submissionsRef().get()).val()||{};
    const entry=submissions[submissionId];
    if(!entry) return;
    await playersRef().child(entry.playerId).transaction(data=>{ if(!data) return data; return { ...data, score:(data.score||0)+1 }; });
    await collectWhiteToDiscard(submissions);
    const winnerName=game.players[entry.playerId]?.name || '‚Äî';
    await stateRef().update({ status:STATUS.RESULT, lastWinnerName:winnerName, lastAnswer:entry.text, timerEndsAt:null });
  }

  function randomSubmissionKey(submissions, rng=Math.random){
    const entries=Object.keys(submissions||{});
    if(!entries.length) return null;
    const rnd = Math.max(0, Math.min(0.999999, typeof rng==='function'?rng():Math.random()));
    const index = Math.floor(rnd * entries.length);
    return entries[index] || null;
  }

  async function hostAutoPick(submissionId){
    const state=(await stateRef().get()).val();
    if(!state || state.status!==STATUS.COLLECT) return;
    const submissions=(await submissionsRef().get()).val()||{};
    let pickId=submissionId;
    if(!pickId){
      pickId = randomSubmissionKey(submissions);
    }
    if(pickId && submissions[pickId]){
      await hostPickWinner(pickId);
    } else {
      await collectWhiteToDiscard(submissions);
      await stateRef().update({ status:STATUS.RESULT, lastWinnerName:'', lastAnswer:'', timerEndsAt:null });
    }
    updateSelectionUI?.();
    updateActionBar();
  }

  async function collectWhiteToDiscard(submissions){
    Object.values(submissions||{}).forEach(s=>{ if(s&&s.text) game.deck.discardWhite.push(s.text); });
    await deckRef().set({ black:game.deck.black, white:game.deck.white, discardBlack:game.deck.discardBlack, discardWhite:game.deck.discardWhite });
  }

  async function advanceRound(){
    if(!local.isCreator) return;
    const state=(await stateRef().get()).val()||{};
    const players=(await playersRef().get()).val()||{};
    const order=activeOrder();
    if(order.length<MIN_PLAYERS){ await stateRef().update({ status:STATUS.LOBBY, timerEndsAt:null }); toast('–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –∏–≥—Ä–æ–∫–∞'); return; }
    const baseCurrent = state.status===STATUS.LOBBY ? null : state.currentHostPid;
    const hostId = nextHostId(order, baseCurrent);
    const hostName = players[hostId]?.name || '‚Äî';
    if(state.blackCard){ game.deck.discardBlack.push(state.blackCard); }
    await submissionsRef().remove();
    const tasks=order.map(async pid=>{
      const snap=await perPlayerRef(pid).get();
      const data=snap.val()||{hand:[],submitted:false,lastText:''};
      const shouldHave = pid!==hostId;
      const hand = shouldHave ? topUpHand(data.hand||[]) : [];
      await perPlayerRef(pid).set({ hand, submitted:false, lastText:'' });
    });
    await Promise.all(tasks);
    const black=drawBlack();
    const round = state.status===STATUS.LOBBY ? 1 : (state.round||0)+1;
    const timerEndsAt = now() + ROUND_TIMER_SECONDS*1000;
    await stateRef().set({ status:STATUS.COLLECT, round, roundsTotal:ROUNDS_TOTAL, blackCard:black, lastWinnerName:'', lastAnswer:'', currentHostPid:hostId, currentHostName:hostName, timerEndsAt });
    await deckRef().set({ black:game.deck.black, white:game.deck.white, discardBlack:game.deck.discardBlack, discardWhite:game.deck.discardWhite });
    game.submissionsOrder=[];
  }

  function syncPlayersOrder(){
    const players=game.players||{};
    const activeIds=orderedPlayerIds(players).filter(id=>players[id].active!==false);
    const current=Array.isArray(game.playersOrder)?game.playersOrder:[];
    const merged=[...new Set([...current.filter(id=>activeIds.includes(id)), ...activeIds])];
    if(JSON.stringify(merged)!==JSON.stringify(current)) orderRef().set(merged);
  }

  function ensureHostValidity(){
    const order=activeOrder();
    const current=game.state.currentHostPid;
    if(!order.length) return;
    if(!current || !order.includes(current)){
      const next=order[0];
      const name=game.players[next]?.name||'‚Äî';
      if(local.isCreator) stateRef().update({ currentHostPid:next, currentHostName:name });
    }
  }

  function maybeAutoStart(){
    if(!local.isCreator) return;
    if(game.state.status!==STATUS.LOBBY) return;
    if(activeOrder().length>=MIN_PLAYERS){ advanceRound(); }
  }

  function buildHandHint(status){
    if(game.state.currentHostPid===local.playerId) return status===STATUS.COLLECT ? '–í—ã –≤–µ–¥—É—â–∏–π ‚Äî –æ–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç—ã –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è.' : '–í—ã —É–ø—Ä–∞–≤–ª—è–µ—Ç–µ —Ö–æ–¥–æ–º –∏–≥—Ä—ã.';
    if(status===STATUS.LOBBY) return '–û–∂–∏–¥–∞–µ–º —Å—Ç–∞—Ä—Ç —Ä–∞—É–Ω–¥–∞.';
    if(status===STATUS.RESULT) return '–†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à—ë–Ω, –∂–¥—ë–º –Ω–æ–≤—É—é —á—ë—Ä–Ω—É—é –∫–∞—Ä—Ç—É.';
    if(local.hasSubmitted) return '–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, –∂–¥—ë–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö.';
    if(local.selectedIndex==null) return '–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∫–∞—Ä—Ç—É –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ.';
    return '–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å¬ª, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç—É.';
  }

  function renderState(){
    const status=game.state.status||STATUS.LOBBY;
    if(local.roomId){ enterGameUI(); }
    $('#blackText').innerHTML=escapeHtml(game.state.blackCard||'‚Äî');
    $('#roleChip').hidden = status===STATUS.LOBBY;
    $('#roleChip').textContent = game.state.currentHostPid===local.playerId ? '–í—ã –≤–µ–¥—É—â–∏–π' : '–í—ã –∏–≥—Ä–æ–∫';
    $('#timerChip').hidden = status!==STATUS.COLLECT;
    $('#progressChip').hidden = status!==STATUS.COLLECT;
    $('#resultBlock').style.display = status===STATUS.RESULT ? 'block' : 'none';
    $('#winnerLine').innerHTML = game.state.lastWinnerName ? `${escapeHtml(game.state.lastWinnerName)} –ø–æ–ª—É—á–∞–µ—Ç –æ—á–∫–æ –∑–∞ ${fillBlack(game.state.blackCard||'', game.state.lastAnswer||'')}` : '–í —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ –Ω–µ –±—ã–ª–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è.';
    $('#resultHint').textContent = game.state.currentHostPid===local.playerId ? '–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥.' : '–ñ–¥—ë–º —Ç–µ–∫—É—â–µ–≥–æ –≤–µ–¥—É—â–µ–≥–æ.';
    const hostText = status===STATUS.LOBBY ? '–û–∂–∏–¥–∞–µ–º –∏–≥—Ä–æ–∫–æ–≤.' : status===STATUS.COLLECT ? `–í–µ–¥—É—â–∏–π: ${escapeHtml(game.state.currentHostName||'‚Äî')}` : '–†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à—ë–Ω.';
    $('#hostSummary').textContent = hostText;
    $('#handHint').textContent = buildHandHint(status);

    const canStart = local.isCreator && status===STATUS.LOBBY;
    const lobbyBlock = $('#lobbyActions');
    const lobbyHint = $('#lobbyHint');
    if (lobbyBlock){
      const count = activeOrder().length;
      lobbyBlock.style.display = canStart ? 'flex' : 'none';
      lobbyHint.textContent = count<MIN_PLAYERS ? `–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º ${MIN_PLAYERS} –∏–≥—Ä–æ–∫–∞(–æ–≤). –°–µ–π—á–∞—Å: ${count}.` : `–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å. –ò–≥—Ä–æ–∫–æ–≤: ${count}.`;
      $('#btnStartGame').disabled = !(count>=MIN_PLAYERS);
    }

    updateProgressChip();
  }

  function renderPlayers(){
    const list=$('#playersList'); if(!list) return;
    list.innerHTML='';
    const players=game.players||{};
    const ordered=orderedPlayerIds(players);
    ordered.forEach(id=>{
      const data=players[id];
      const row=document.createElement('div');
      row.style.display='flex';
      row.style.alignItems='center';
      row.style.justifyContent='space-between';
      row.style.padding='8px 0';
      const tags=[];
      if(data.isCreator) tags.push('–º–æ–¥–µ—Ä–∞—Ç–æ—Ä');
      if(id===game.state.currentHostPid) tags.push('–≤–µ–¥—É—â–∏–π');
      if(data.active===false) tags.push('offline');
      row.innerHTML=`<div>${escapeHtml(data.name||'–ë–µ–∑—ã–º—è–Ω–Ω—ã–π')}${tags.length?` <span class="small muted">(${tags.join(', ')})</span>`:''}</div><div class="chip">${data.score||0}</div>`;
      list.appendChild(row);
    });
    if(!ordered.length){ list.innerHTML='<div class="muted small">–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç.</div>'; }
  }

  function renderHand(hand){
    const container=$('#handCards'); if(!container) return;
    container.innerHTML='';
    const disabled = game.state.currentHostPid===local.playerId || game.state.status!==STATUS.COLLECT;
    hand.forEach((text,idx)=>{
      const btn=document.createElement('button');
      btn.type='button';
      btn.className='answer-card'+(disabled?' disabled':' selectable');
      btn.dataset.index=idx;
      btn.innerHTML=`<div style="font-size:18px;line-height:1.5;">${escapeHtml(text)}</div>`;
      if(!disabled){
        btn.onclick=()=>selectCard(idx,text,btn);
        if(idx===local.selectedIndex) btn.classList.add('selected');
      }
      container.appendChild(btn);
    });
    if (disabled){
      local.selectedIndex = null;
      local.selectedText = '';
    } else if (local.selectedIndex !== null && local.selectedIndex >= hand.length){
      local.selectedIndex = null;
      local.selectedText = '';
    }
    updateActionBar();
  }

  function renderSubmissions(map){
    game.submissions=map||{};
    const entries=Object.entries(game.submissions);
    const received=entries.length;
    const expected=expectedSubmissions();
    const timerExpired = game.state.timerEndsAt && now() >= game.state.timerEndsAt;
    const reveal = game.state.status===STATUS.RESULT || (game.state.status===STATUS.COLLECT && (timerExpired || (expected>0 && received>=expected)));
    const list=$('#submissionsList');
    list.innerHTML='';
    const hint=$('#submissionsHint');
    if(!entries.length){ hint.textContent = game.state.status===STATUS.COLLECT ? '–ö–∞—Ä—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–≥—Ä–æ–∫–∞–º–∏.' : '–ù–∞ —Å—Ç–æ–ª–µ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤.'; return; }
    if(!reveal){ hint.textContent='–û—Ç–≤–µ—Ç—ã —Å–∫—Ä—ã—Ç—ã –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–±–æ—Ä–∞.'; return; }
    hint.textContent = game.state.status===STATUS.COLLECT ? '–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è.' : '–í–µ–¥—É—â–∏–π –æ–±—ä—è–≤–∏–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç.';
    const prevOrder=Array.isArray(game.submissionsOrder)?game.submissionsOrder.filter(id=>game.submissions[id]):[];
    if(prevOrder.length!==entries.length){ game.submissionsOrder=shuffle(entries.map(([id])=>id)); }
    const order=game.submissionsOrder;
    order.forEach(id=>{
      const item=game.submissions[id]; if(!item) return;
      const btn=document.createElement('button');
      btn.type='button';
      btn.className='answer-card';
      btn.innerHTML=`<div class="muted small">–û—Ç–≤–µ—Ç</div><div style="margin-top:8px;font-size:18px;line-height:1.5;">${fillBlack(game.state.blackCard||'', item.text)}</div>`;
      if(game.state.status===STATUS.COLLECT && game.state.currentHostPid===local.playerId){
        btn.classList.add('selectable');
        btn.onclick=()=>eventsRef().push({ type:'pickWinner', submissionId:id, t:now() });
      } else {
        btn.disabled=true;
      }
      list.appendChild(btn);
    });
    updateProgressChip();
  }

  function updateProgressChip(){
    const chip=$('#progressChip'); if(!chip) return;
    if(game.state.status!==STATUS.COLLECT){ chip.hidden=true; return; }
    const expected=expectedSubmissions();
    const received=Object.keys(game.submissions||{}).length;
    chip.textContent=`${received}/${expected} –æ—Ç–ø—Ä–∞–≤–∏–ª–∏`;
    chip.hidden=false;
    chip.classList.toggle('danger', expected>0 && received<expected && game.state.timerEndsAt && game.state.timerEndsAt-now()<15000);
  }

  function updateActionBar(){
    const bar=$('#actionBar'); if(!bar) return;
    const isHost=game.state.currentHostPid===local.playerId;
    const collecting=game.state.status===STATUS.COLLECT;
    if(!collecting || isHost){ bar.classList.add('hidden'); return; }
    bar.classList.remove('hidden');
    if(local.hasSubmitted){ $('#actionHint').textContent='–ö–∞—Ä—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –ñ–¥—ë–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö.'; $('#btnConfirm').disabled=true; }
    else if(local.selectedIndex==null){ $('#actionHint').textContent='–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É –∏–∑ —Ä—É–∫–∏, —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å.'; $('#btnConfirm').disabled=true; }
    else { $('#actionHint').textContent='–ì–æ—Ç–æ–≤–æ! –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã.'; $('#btnConfirm').disabled=false; }
  }

  function startTimerTick(){
    clearInterval(local.timerInterval);
    if(game.state.status!==STATUS.COLLECT || !game.state.timerEndsAt){ $('#timerChip').hidden=true; return; }
    $('#timerChip').hidden=false;
    const update=()=>{
      const seconds=Math.max(0, Math.ceil((game.state.timerEndsAt - now())/1000));
      $('#timerChip').textContent=`‚è± ${seconds}s`;
      if(seconds<=0){ clearInterval(local.timerInterval); if(!local.autoPickFired){ local.autoPickFired=true; eventsRef().push({ type:'autoPick', submissionId:null, t:now() }); } }
    };
    update();
    local.timerInterval=setInterval(update,1000);
    local.autoPickFired=false;
  }

  async function submitCard(){
    if(game.state.status!==STATUS.COLLECT){ showError('–°–µ–π—á–∞—Å –Ω–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É.'); return; }
    if(game.state.currentHostPid===local.playerId){ showError('–í–µ–¥—É—â–∏–π –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–∞—Ä—Ç—ã.'); return; }
    if(local.hasSubmitted){ showError('–ö–∞—Ä—Ç–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.'); return; }
    if(local.selectedIndex==null){ showError('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É.'); return; }
    const hand=[...local.activeHand];
    const text=hand[local.selectedIndex];
    if(!text){ showError('–ö–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.'); return; }
    hand.splice(local.selectedIndex,1);
    await perPlayerRef(local.playerId).set({ hand, submitted:true, lastText:text });
    const id=uid();
    await submissionsRef().child(id).set({ playerId:local.playerId, text, createdAt:now() });
    local.hasSubmitted=true;
    local.selectedIndex=null;
    local.selectedText='';
    local.submittedText=text;
    updateHandState();
    updateActionBar();
    toast('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
  }

  async function nextRound(){
    if(game.state.currentHostPid!==local.playerId){ showError('–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥ –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤–µ–¥—É—â–∏–π.'); return; }
    await eventsRef().push({ type:'nextRound', t:now() });
  }

  async function startGame(){
    if(!local.isCreator){ showError('–°—Ç–∞—Ä—Ç—É–µ—Ç –≤–µ–¥—É—â–∏–π.'); return; }
    await advanceRound();
  }

  function toggleMenu(){ $('#menuSheet').classList.toggle('hidden'); }

  // ===== Setup & UI =====
  function setupUI(){
    const params=new URLSearchParams(location.search);
    const room=params.get('room');
    const savedName=localStorage.getItem('playerName');

    if(room){
      local.roomId=room.toUpperCase();
      local.isCreator=false;
      showScreen('screenNameOnly');
      $('#nameOnly').value=savedName||'';
      setTimeout(()=>{$focus($('#nameOnly'));},0);
    } else {
      $('#createRoomId').value=(Math.random().toString(36).slice(2,8)).toUpperCase();
      if(savedName){ $('#createName').value=savedName; }
      showScreen('screenCreate');
    }
  }

  function renderOnStateChange(){ renderState(); renderHand(local.activeHand); updateActionBar(); }

  function syncUIHandlers(){
    $('#btnCreateRoom').onclick=createRoom;
    $('#btnNameOnly').onclick=joinRoomWithNameOnly;
    $('#nameOnly').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); $('#btnNameOnly').click(); }});
    $('#btnCopyLink').onclick=()=>copyToClipboard($('#shareLink').value||'');
    $('#btnConfirm').onclick=submitCard;
    $('#btnNextRound').onclick=nextRound;
    $('#btnStartGame').onclick=startGame;
    $('#menuBtn').onclick=toggleMenu;
    document.addEventListener('click',e=>{ if(!$('#menuSheet').classList.contains('hidden')){ const sheet=$('#menuSheet'); if(e.target.id==='menuBtn' || sheet.contains(e.target)) return; sheet.classList.add('hidden'); } });
    $('#menuRules').onclick=()=>{ $('#menuSheet').classList.add('hidden'); $('#dlgRules').showModal(); };
    $('#menuDeck').onclick=()=>{ $('#menuSheet').classList.add('hidden'); $('#dlgDeck').showModal(); };
    $('#menuTests').onclick=()=>{ $('#menuSheet').classList.add('hidden'); runTests(); };
    $('#menuCheck').onclick=async()=>{ $('#menuSheet').classList.add('hidden'); await testDbConnection(); toast('–ü—Ä–æ–≤–µ—Ä–∫–∞: '+lastConnMsg); };
    $('#menuNew').onclick=()=>{ location.href=location.origin+location.pathname; };
    $('#btnSaveDeck').onclick=()=>{ try{ const json=JSON.parse($('#deckJson').value||'{}'); ensureMinimumDeck(json); localStorage.setItem(STORAGE_KEY, JSON.stringify(json)); if(local.isCreator) loadDeckLocal(); toast('–ö–æ–ª–æ–¥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞'); }catch(e){ showError('–û—à–∏–±–∫–∞ JSON: '+e.message); } };
    $('#btnResetDeck').onclick=()=>{ localStorage.removeItem(STORAGE_KEY); loadDeckLocal(); toast('–ö–æ–ª–æ–¥–∞ —Å–±—Ä–æ—à–µ–Ω–∞'); };
    $('#btnExportDeck').onclick=()=>{ const blob=new Blob([$('#deckJson').value||''],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='deck.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500); };
    $('#btnImportDeck').onclick=()=>{ const input=document.createElement('input'); input.type='file'; input.accept='application/json'; input.onchange=async()=>{ const file=input.files?.[0]; if(!file) return; const text=await file.text(); $('#deckJson').value=text; }; input.click(); };
  }

  async function handleHostEvent(snap){ /* —É–∂–µ –≤—ã—à–µ */ }
  function refreshHandSelectionStyles(){} function updateSelectionUI(){} function updateHostHint(){}

  // ===== Boot =====
  let connectivityOk=false;
  document.addEventListener('DOMContentLoaded', async ()=>{
    syncUIHandlers();
    setupUI();
    setTimeout(async()=>{ connectivityOk=await testDbConnection(); },400);
    renderOnStateChange();
  });

  // ===== Tests (UI modal) =====
  const tests=[]; const test=(n,f)=>tests.push({n,f}); const expect=(c,m)=>{ if(!c) throw new Error(m||'assert failed'); };
  test('topUpHand() –¥–æ–±–∏–≤–∞–µ—Ç –¥–æ 7',()=>{ const h=topUpHand(['a'],7); expect(h.length===7,'hand size'); });
  window.runTests=async()=>{
    const results=[];
    for(const t of tests){ try{ await t.f(); results.push('‚úÖ '+t.n); } catch(e){ results.push('‚ùå '+t.n+' ‚Äî '+e.message); } }
    $('#testsOutput').textContent=results.join('\n'); $('#dlgTests').showModal();
  };
  </script>
</body>
</html>
