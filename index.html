<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>500 –∑–ª–æ–±–Ω—ã—Ö –∫–∞—Ä—Ç ‚Äî –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</title>
  <style>
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,"Noto Sans","Helvetica Neue",Arial;background:#0c0f16;color:#f1f3fb;}
    .wrap{max-width:900px;margin:0 auto;padding:16px;}
    .card{background:#151823;border:1px solid #2a3248;border-radius:20px;padding:22px;margin-top:16px;}
    .muted{color:#8b93a7;}
    .primary{background:#7c5cff;color:#fff;padding:12px 18px;border-radius:14px;font-weight:600;border:none;cursor:pointer;}
    .chip{display:inline-block;background:#20263a;padding:6px 10px;border-radius:999px;font-size:13px;margin:2px;}
    input[type=text]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2a3248;background:#1b2030;color:#fff;font-size:16px;}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px;background:#111;}
    .logo{font-weight:800;font-size:20px;}
    #startBtn{margin-top:14px;display:none;}
    .hand-card{background:#1b2030;border:1px solid #2a3248;border-radius:12px;padding:10px;margin:4px;flex:1;min-width:120px;cursor:pointer;}
    .hand{display:flex;flex-wrap:wrap;gap:10px;}
  </style>
</head>
<body>
  <header>
    <div class="logo">üÉè 500 –∑–ª. –∫–∞—Ä—Ç</div>
  </header>
  <div class="wrap">
    <!-- —ç–∫—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω–∏—è -->
    <main id="screenCreate" class="card">
      <h1>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</h1>
      <label>–í–∞—à–µ –∏–º—è:<br><input type="text" id="createName" maxlength="24" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –°–µ—Ä–≥–µ–π"></label>
      <label style="margin-top:12px;">ID –∫–æ–º–Ω–∞—Ç—ã:<br><input type="text" id="createRoomId" maxlength="8"></label>
      <button class="primary" id="btnCreateRoom" style="margin-top:16px;">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
      <div class="muted" id="createError"></div>
    </main>

    <!-- —ç–∫—Ä–∞–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
    <main id="screenJoin" class="card" style="display:none;">
      <h1>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</h1>
      <p class="muted">–í–∞—Å –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç <b id="hostNameLabel">‚Äî</b></p>
      <label>–í–∞—à–µ –∏–º—è:<br><input type="text" id="joinName" maxlength="24" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è"></label>
      <button class="primary" id="btnJoinRoom" style="margin-top:16px;">–í–æ–π—Ç–∏ –≤ –∏–≥—Ä—É</button>
      <div class="muted" id="joinError"></div>
    </main>

    <!-- —ç–∫—Ä–∞–Ω –∏–≥—Ä—ã -->
    <main id="screenGame" class="card" style="display:none;">
      <h2>–ò–≥—Ä–æ–∫–∏</h2>
      <div id="playersList"></div>
      <button id="startBtn" class="primary">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
      <div id="gameArea" style="margin-top:20px;display:none;">
        <div class="black-card card">
          <div class="muted">–ß—ë—Ä–Ω–∞—è –∫–∞—Ä—Ç–∞</div>
          <div id="blackText" style="margin-top:10px;font-size:18px;">‚Äî</div>
        </div>
        <h3>–í–∞—à–∏ –∫–∞—Ä—Ç—ã</h3>
        <div id="handCards" class="hand"></div>
        <button id="nextRoundBtn" class="primary" style="margin-top:16px;display:none;">–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥</button>
      </div>
    </main>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig={apiKey:"AIzaSyDRtpegXwTsSf77dPIOGDIyBFvib_GgUcM",authDomain:"z-e86ee.firebaseapp.com",databaseURL:"https://z-e86ee-default-rtdb.europe-west1.firebasedatabase.app",projectId:"z-e86ee",storageBucket:"z-e86ee.appspot.com",messagingSenderId:"268263276853",appId:"1:268263276853:web:0195c839f5dd38e7214c7c"};
    firebase.initializeApp(firebaseConfig);
    const db=firebase.database();

    const STATUS={LOBBY:"lobby",PLAY:"play"};
    const MIN_PLAYERS=2;
    const MAX_HAND=7;

    const BLACK_CARDS=[
      "–õ—É—á—à–µ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ –æ—Ç –ø–ª–æ—Ö–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è ‚Äî ____.",
      "–ú–æ–π —Ç–∞–π–Ω—ã–π —Ç–∞–ª–∞–Ω—Ç ‚Äî ____.",
      "–í –æ—Ñ–∏—Å–µ –∑–∞–ø—Ä–µ—Ç–∏–ª–∏ ____ –ø–æ—Å–ª–µ –ø—Ä–æ—à–ª–æ–π –≤–µ—á–µ—Ä–∏–Ω–∫–∏."
    ];
    const WHITE_CARDS=[
      "–∫–æ—Ñ–µ –±–µ–∑ —Å–∞—Ö–∞—Ä–∞","—Ç–∞–Ω–µ—Ü —Å –ø—ã–ª–µ—Å–æ—Å–æ–º","–Ω–æ—á–Ω–æ–π –ø–æ—Ö–æ–¥ –≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫",
      "–µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫ –Ω–∞ 2035 –≥–æ–¥","–∫–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å—É–¥–∏—Ç —Ç–µ–±—è","–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π –∑—É–º",
      "—Å–æ—Å–µ–¥ —Å –¥—Ä–µ–ª—å—é","—Å—Ç–∞—Ä—ã–π –ø–ª–µ–¥","–ø—è—Ç–Ω–∏—á–Ω–∞—è –ø–∏—Ü—Ü–∞"
    ];

    let local={id:Math.random().toString(36).slice(2,8),roomId:null,isCreator:false,name:""};
    let gameState={};

    const $=s=>document.querySelector(s);

    function roomRef(){return db.ref("rooms/"+local.roomId)}
    function playersRef(){return roomRef().child("players")}
    function stateRef(){return roomRef().child("state")}
    function handsRef(){return roomRef().child("hands")}

    async function createRoom(){
      const name=$("#createName").value.trim();
      if(name.length<2){$("#createError").textContent="–í–≤–µ–¥–∏—Ç–µ –∏–º—è";return}
      const rid=($("#createRoomId").value||Math.random().toString(36).slice(2,6)).toUpperCase();
      local.name=name;local.roomId=rid;local.isCreator=true;
      await roomRef().set({createdAt:Date.now(),creatorId:local.id,creatorName:name});
      await playersRef().child(local.id).set({name,joinedAt:Date.now(),active:true});
      await stateRef().set({status:STATUS.LOBBY,black:"",hostId:local.id,round:0});
      showGame();
    }

    async function joinRoom(){
      const name=$("#joinName").value.trim();
      if(name.length<2){$("#joinError").textContent="–í–≤–µ–¥–∏—Ç–µ –∏–º—è";return}
      local.name=name;
      await playersRef().child(local.id).set({name,joinedAt:Date.now(),active:true});
      showGame();
    }

    function showGame(){
      $("#screenCreate").style.display="none";
      $("#screenJoin").style.display="none";
      $("#screenGame").style.display="block";
      subscribeRoom();
    }

    function renderPlayers(players){
      const list=$("#playersList");list.innerHTML="";
      Object.entries(players||{}).forEach(([id,p])=>{
        const d=document.createElement("div");
        d.className="chip";
        d.textContent=p.name+(id===gameState.hostId?" (–≤–µ–¥—É—â–∏–π)":"");
        list.appendChild(d);
      });
      if(local.isCreator){
        const count=Object.keys(players||{}).length;
        if(count>=MIN_PLAYERS) $("#startBtn").style.display="block"; else $("#startBtn").style.display="none";
      }
    }

    function subscribeRoom(){
      playersRef().on("value",s=>renderPlayers(s.val()||{}));
      stateRef().on("value",s=>{
        const st=s.val(); if(!st) return;
        gameState=st;
        if(st.status===STATUS.PLAY){
          $("#gameArea").style.display="block";
          $("#blackText").textContent=st.black||"‚Äî";
          if(local.id===st.hostId && local.isCreator){
            $("#nextRoundBtn").style.display="block";
          } else {
            $("#nextRoundBtn").style.display="none";
          }
        }
      });
      handsRef().child(local.id).on("value",s=>{
        const hand=s.val()||[];
        const cont=$("#handCards");cont.innerHTML="";
        hand.forEach(card=>{
          const d=document.createElement("div");d.className="hand-card";d.textContent=card;cont.appendChild(d);
        });
      });
    }

    function randomCard(){
      return WHITE_CARDS[Math.floor(Math.random()*WHITE_CARDS.length)];
    }

    async function dealHands(players,hostId){
      for(const pid of Object.keys(players)){
        if(pid===hostId){
          await handsRef().child(pid).set([]);
        } else {
          const hand=[];
          for(let i=0;i<MAX_HAND;i++) hand.push(randomCard());
          await handsRef().child(pid).set(hand);
        }
      }
    }

    async function topUpHands(players,hostId){
      for(const pid of Object.keys(players)){
        if(pid===hostId) continue;
        const snap=await handsRef().child(pid).get();
        let hand=snap.val()||[];
        while(hand.length<MAX_HAND){
          hand.push(randomCard());
        }
        await handsRef().child(pid).set(hand);
      }
    }

    async function startGame(){
      const snap=await playersRef().get();
      const players=snap.val()||{};
      const ids=Object.keys(players);
      const hostId=(await stateRef().child("hostId").get()).val()||local.id;
      const black=BLACK_CARDS[Math.floor(Math.random()*BLACK_CARDS.length)];
      await dealHands(players,hostId);
      await stateRef().update({status:STATUS.PLAY,black:black,hostId:hostId,round:1,order:ids});
    }

    async function nextRound(){
      const st=(await stateRef().get()).val()||{};
      const order=st.order||[];
      if(order.length===0) return;
      const idx=order.indexOf(st.hostId);
      const nextHost=order[(idx+1)%order.length];
      const black=BLACK_CARDS[Math.floor(Math.random()*BLACK_CARDS.length)];
      const snap=await playersRef().get();
      const players=snap.val()||{};
      await topUpHands(players,nextHost);
      await stateRef().update({status:STATUS.PLAY,black:black,hostId:nextHost,round:(st.round||0)+1,order:order});
    }

    $("#btnCreateRoom").onclick=createRoom;
    $("#btnJoinRoom").onclick=joinRoom;
    $("#startBtn").onclick=startGame;
    $("#nextRoundBtn").onclick=nextRound;

    const url=new URLSearchParams(location.search);
    const room=url.get("room");
    if(room){
      local.roomId=room.toUpperCase();
      local.isCreator=false;
      roomRef().child("creatorName").get().then(s=>{
        $("#hostNameLabel").textContent=s.val()||"‚Äî";
        $("#screenJoin").style.display="block";
      });
      $("#screenCreate").style.display="none";
    }
  </script>
</body>
</html>
