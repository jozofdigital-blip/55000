<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>500 –∑–ª–æ–±–Ω—ã—Ö –∫–∞—Ä—Ç ‚Äî –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä (–æ–¥–∏–Ω HTML)</title>
  <style>
    :root { --bg:#0f1115; --panel:#151823; --muted:#8b93a7; --text:#e6e9f2; --accent:#7c5cff; --accent-2:#25d0a2; --danger:#ff5c7c; --card:#1b2030; --chip:#20263a; --border:#2a3248; --shadow:0 10px 30px rgba(0,0,0,.35);} 
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial;background:linear-gradient(180deg,#0d1016,#0f1219 60%,#0b0e14);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:10px 0 8px;flex-wrap:wrap}
    .logo{font-weight:800;letter-spacing:.3px;font-size:20px;display:flex;align-items:center;gap:10px}
    .logo b{display:inline-block;background:linear-gradient(135deg,var(--accent),#b28dff);-webkit-background-clip:text;background-clip:text;color:transparent}
    .bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    button,.btn{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;box-shadow:var(--shadow);transition:.15s ease}
    button.ghost,.btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text);box-shadow:none}
    button.texty{background:transparent;border:none;color:var(--muted);padding:8px 10px}
    button:hover{transform:translateY(-1px);filter:saturate(1.1)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .panel{grid-column:span 12;background:var(--panel);border:1px solid var(--border);border-radius:20px;padding:16px;box-shadow:var(--shadow)}
    @media(min-width:900px){.panel.split{grid-column:span 8}.panel.side{grid-column:span 4;position:sticky;top:12px;align-self:start}}
    h2{margin:8px 0 10px;font-size:18px}
    h3{margin:8px 0;font-size:16px;color:var(--muted);font-weight:700}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type="text"],input[type="number"],textarea{width:100%;background:var(--chip);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;outline:none}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--border);padding:8px 10px;border-radius:999px;color:#cfd5e6;font-weight:700}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px}
    .card.black-card{background:#050608;border-color:#1f2536;color:#fff}
    .card.black-card .muted{color:rgba(255,255,255,.65)}
    .card.selectable{cursor:pointer;transition:.15s ease}
    .card.selectable:hover{transform:translateY(-2px);}
    .card.selected{outline:2px solid var(--accent);box-shadow:0 0 0 3px rgba(124,92,255,.35);transform:translateY(-3px);}
    .card.disabled{opacity:.55;pointer-events:none}
    .card.readonly{pointer-events:none}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
    .kicker{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .small{font-size:12px;opacity:.8}
    .big{font-size:20px;line-height:1.35}
    .winner{background:linear-gradient(135deg,rgba(37,208,162,.15),rgba(124,92,255,.15));border-color:#39456b}
    .scroll{max-height:260px;overflow:auto;padding-right:6px}
    .hr{height:1px;background:var(--border);margin:12px 0}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .hidden{display:none!important}
    .link{color:#b7c1ff;text-decoration:underline;cursor:pointer}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:#1c2233;border:1px solid var(--border);padding:10px 12px;border-radius:12px;box-shadow:var(--shadow)}
    @media (max-width: 600px){
      .wrap{max-width:600px;padding:12px}
      header{gap:8px}
      .logo{font-size:18px}
      .bar{gap:6px;width:100%;justify-content:flex-start}
      button,.btn{padding:12px 14px;border-radius:14px;font-size:16px}
      .panel{padding:12px;border-radius:16px}
      .cards{grid-template-columns: 1fr}
      .card{padding:16px;font-size:18px}
      .big{font-size:18px}
      #playersList .kicker{padding:10px 0}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">üÉè <b>500 –∑–ª. –∫–∞—Ä—Ç</b> ‚Äî –æ–Ω–ª–∞–π–Ω</div>
      <div class="bar">
        <span id="connStatus" class="chip" title="–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è">–°—Ç–∞—Ç—É—Å: –Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ</span>
        <button class="ghost" id="btnCheck">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
        <button class="ghost" id="btnDeck">–ö–æ–ª–æ–¥–∞</button>
        <button class="ghost" id="btnHow">–ü—Ä–∞–≤–∏–ª–∞</button>
        <button class="ghost" id="btnTests">üß™ –¢–µ—Å—Ç—ã</button>
        <button id="btnNew">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
      </div>
    </header>

    <!-- –≠–ö–†–ê–ù –õ–û–ë–ë–ò / –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï -->
    <div class="grid" id="screenLobby">
      <section class="panel">
        <h2>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–≥—Ä–µ</h2>
        <p class="muted">1) –í–µ–¥—É—â–∏–π —Å–æ–∑–¥–∞—ë—Ç –∫–æ–º–Ω–∞—Ç—É ‚Üí –∫–∏–¥–∞–µ—Ç —Å—Å—ã–ª–∫—É –¥—Ä—É–∑—å—è–º. 2) –í—Å–µ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç —Å—Å—ã–ª–∫—É –∏ –≤–≤–æ–¥—è—Ç –∏–º—è. 3) –ò–≥—Ä–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏.</p>
        <div class="row">
          <button id="btnCreate">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
          <input type="text" id="roomInput" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, ABC123)" style="max-width:220px">
          <button class="ghost" id="btnJoin">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </div>
        <div class="hr"></div>
        <div class="row">
          <input type="text" id="playerName" placeholder="–í–∞—à–µ –∏–º—è" style="max-width:240px">
          <label><input type="checkbox" id="sfwOnly" checked> –¢–æ–ª—å–∫–æ SFW</label>
        </div>
        <p class="small muted">–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–º–Ω–∞—Ç—É –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è. –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ.</p>
        <div class="row" id="shareRow" style="margin-top:8px; display:none;">
          <input type="text" id="shareLink" readonly>
          <button class="ghost" id="btnCopy">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
        </div>
        <div id="lobbyInfo" class="muted" style="margin-top:8px;"></div>
      </section>
    </div>

    <!-- –≠–ö–†–ê–ù –ò–ì–†–´ -->
    <div class="grid hidden" id="screenGame">
      <section class="panel split">
        <div class="kicker">
          <div>
            <div class="muted small">–ö–æ–º–Ω–∞—Ç–∞: <span id="roomIdLabel">‚Äî</span></div>
            <div class="muted small">–†–∞—É–Ω–¥ <span id="roundN">1</span>/<span id="roundTotal">10</span></div>
            <div style="margin-top:2px;">–í–µ–¥—É—â–∏–π: <b id="hostName">‚Äî</b></div>
          </div>
          <div class="chips"><span class="chip" id="statusHint">–°—Ç–∞—Ç—É—Å: ‚Äî</span></div>
        </div>

        <div class="card black-card" style="margin-top:12px;">
          <div class="muted small">–ß—ë—Ä–Ω–∞—è –∫–∞—Ä—Ç–∞</div>
          <div id="blackText" class="big" style="margin-top:6px;">‚Äî</div>
        </div>

        <div id="handSection" style="margin-top:14px;">
          <h3>–í–∞—à–∏ –∫–∞—Ä—Ç—ã</h3>
          <div class="muted small" id="selectionHint">–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –±–µ–ª—É—é –∫–∞—Ä—Ç—É (–≤–∞—à–∞ —Ä—É–∫–∞ –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–∞–º)</div>
          <div class="cards" id="handCards" style="margin-top:10px;"></div>
          <div class="row" id="handActions" style="margin-top:10px;">
            <button class="ghost" id="btnConfirm" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä</button>
          </div>
          <div class="card hidden" id="submittedCard" style="margin-top:12px;">
            <div class="muted small">–í—ã –ø–æ–ª–æ–∂–∏–ª–∏ –Ω–∞ —Å—Ç–æ–ª</div>
            <div class="big" id="submittedCardText" style="margin-top:6px;">‚Äî</div>
          </div>
        </div>

        <div id="hostPanel" style="margin-top:14px;">
          <h3>–û—Ç–≤–µ—Ç—ã –Ω–∞ —Å—Ç–æ–ª–µ</h3>
          <div class="muted small" id="hostHint">–ñ–¥—ë–º, –ø–æ–∫–∞ –∏–≥—Ä–æ–∫–∏ –≤—ã–±–µ—Ä—É—Ç –∫–∞—Ä—Ç—ã</div>
          <div class="cards" id="submissions" style="margin-top:10px;"></div>
        </div>

        <div id="resultPanel" class="hidden" style="margin-top:14px;">
          <div class="card winner">
            <div class="muted small">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å —Ä–∞—É–Ω–¥–∞</div>
            <div class="big" id="winnerLine" style="margin-top:6px;">‚Äî</div>
            <div class="row" style="margin-top:10px;">
              <button id="nextRound">–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥ (–≤–µ–¥—É—â–∏–π)</button>
            </div>
          </div>
        </div>
      </section>

      <aside class="panel side">
        <h2>–ò–≥—Ä–æ–∫–∏</h2>
        <div id="playersList" class="scroll"></div>
        <div class="hr"></div>
        <div class="row">
          <span class="small muted">–í–µ–¥—É—â–∏–π —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–∞—É–Ω–¥–∞–º–∏</span>
        </div>
      </aside>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ò -->
    <dialog id="dlgRules">
      <form method="dialog" class="card" style="min-width:min(680px,90vw);">
        <h2>–ü—Ä–∞–≤–∏–ª–∞ (–∫–æ—Ä–æ—Ç–∫–æ)</h2>
        <ol class="muted" style="line-height:1.6;">
          <li>–û–¥–∏–Ω —Å–æ–∑–¥–∞—ë—Ç –∫–æ–º–Ω–∞—Ç—É –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤–µ–¥—É—â–∏–º (host).</li>
          <li>–í—Å–µ –≤–≤–æ–¥—è—Ç –∏–º—è –∏ –∑–∞—Ö–æ–¥—è—Ç –ø–æ —Å—Å—ã–ª–∫–µ –∫–æ–º–Ω–∞—Ç—ã.</li>
          <li>–í–µ–¥—É—â–∏–π –≤—ã–±–∏—Ä–∞–µ—Ç –ª—É—á—à—É—é –∫–∞—Ä—Ç—É –≤ –∫–∞–∂–¥–æ–º —Ä–∞—É–Ω–¥–µ.</li>
          <li>–ò–≥—Ä–æ–∫–∏ –≤—ã–±–∏—Ä–∞—é—Ç –æ—Ç–≤–µ—Ç—ã –∏–∑ —Å–≤–æ–µ–π —Ä—É–∫–∏.</li>
          <li>–ü–æ–±–µ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç 1 –æ—á–∫–æ.</li>
        </ol>
        <menu class="row" style="justify-content:flex-end; margin-top:8px;">
          <button class="ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
        </menu>
      </form>
    </dialog>

    <dialog id="dlgDeck">
      <form method="dialog" class="card" style="min-width:min(880px,96vw);">
        <h2>–ö–æ–ª–æ–¥–∞</h2>
        <p class="muted">–†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ JSON. –§–æ—Ä–º–∞—Ç: <span class="mono">{"black":[],"white":[],"nsfwBlack":[],"nsfwWhite":[]}</span></p>
        <div class="row"><textarea id="deckJson" rows="12" style="width:100%"></textarea></div>
        <div class="row" style="justify-content:space-between;margin-top:8px;">
          <div class="row">
            <button type="button" class="ghost" id="btnImport">–ò–º–ø–æ—Ä—Ç JSON‚Ä¶</button>
            <button type="button" class="ghost" id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
            <button type="button" class="ghost" id="btnResetDeck">–°–±—Ä–æ—Å–∏—Ç—å –∫ –¥–µ–º–æ</button>
          </div>
          <menu class="row">
            <button class="ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
            <button type="button" id="btnSaveDeck">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </menu>
        </div>
      </form>
    </dialog>

    <dialog id="dlgTests">
      <form method="dialog" class="card" style="min-width:min(780px,96vw);">
        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</h2>
        <div id="testsOutput" class="mono small" style="white-space:pre-wrap"></div>
        <menu class="row" style="justify-content:flex-end; margin-top:8px;">
          <button class="ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
        </menu>
      </form>
    </dialog>
  </div>

  <div id="toast" class="toast hidden"></div>

  <!-- Firebase (compat –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
  // ===== –£–¢–ò–õ–ò–¢–´ =====
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const uid = () => Math.random().toString(36).slice(2, 10);
  const shuffle = arr => { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; };
  const toast = (msg)=>{ const t=$('#toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2000); };

  // ===== –ö–û–õ–û–î–ê SFW + –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è =====
  const DEMO_DECK = { black:[
    "–õ—É—á—à–µ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ –æ—Ç –ø–ª–æ—Ö–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è ‚Äî ____.",
    "–í –æ—Ñ–∏—Å–µ –∑–∞–ø—Ä–µ—Ç–∏–ª–∏ ____ –ø–æ—Å–ª–µ –ø—Ä–æ—à–ª–æ–π –≤–µ—á–µ—Ä–∏–Ω–∫–∏.",
    "–ú–æ–π —Ç–∞–π–Ω—ã–π —Ç–∞–ª–∞–Ω—Ç ‚Äî ____.",
    "–ö–æ–º–±–æ –¥–Ω—è: ____ —Å —Å–æ—É—Å–æ–º –∏–∑ ____.",
    "–ù–∞ –ø–µ—Ä–≤–æ–º —Å–≤–∏–¥–∞–Ω–∏–∏ –Ω–µ —Å–æ–≤–µ—Ç—É—é –æ–±—Å—É–∂–¥–∞—Ç—å ____.",
    "–£—á–µ–Ω—ã–µ –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ –ø—Ä–∏–¥—É–º–∞–ª–∏ ____.",
    "–°–∞–º–æ–µ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ –≤ –ø–æ–¥–∞—Ä–æ–∫ ‚Äî ____.",
    "–ù–æ–≤–æ–µ —Ö–æ–±–±–∏, –æ –∫–æ—Ç–æ—Ä–æ–º —Å—Ç—ã–¥–Ω–æ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è–º: ____.",
    "–ó–∞–≤—Ç—Ä–∞–∫ —á–µ–º–ø–∏–æ–Ω–∞ ‚Äî ____.",
    "–ü—É—Ç—å –∫ —É—Å–ø–µ—Ö—É –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å ____.",
  ], white:[
    "–π–æ–≥–∞ –ø—Ä–∏ —Å–≤–µ—Ç–µ –ª–∞–º–ø—ã","–±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ –º–µ–º—ã","–∫–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å—É–¥–∏—Ç —Ç–µ–±—è","–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ 200 —Å–ª–∞–π–¥–æ–≤","–∑–≤—É–∫–∏ –ª–µ—Å–∞ –≤ 3 —á–∞—Å–∞ –Ω–æ—á–∏","–º–∏–∫—Ä–æ–¥–æ–∑—ã —ç–Ω—Ç—É–∑–∏–∞–∑–º–∞","–µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫ –Ω–∞ 2035 –≥–æ–¥","–∫–æ—Ñ–µ —É—Ä–æ–≤–Ω—è –±–æ—Å—Å","—Ç–∞–Ω–µ—Ü —Å –ø—ã–ª–µ—Å–æ—Å–æ–º","—Å—Ä–æ—á–Ω—ã–π —Å–æ–∑–≤–æ–Ω –Ω–∏ –æ —á–µ–º","–ø–µ—Ä–µ–ø–∏—Å–∫–∞ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π","–∑–∞—Ä—è–¥–∫–∞ –¥–ª—è –ª–∏—Ü–∞ –∏ —Å–æ–≤–µ—Å—Ç–∏","–ø–æ–¥–∫–∞—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–∏–∫—Ç–æ –Ω–µ —Å–ª—É—à–∞–µ—Ç","–∫–æ–ª–ª–µ–∫—Ü–∏—è –Ω–µ—Å–±—ã–≤—à–∏—Ö—Å—è —Ü–µ–ª–µ–π","–ø–ª–µ–¥ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏","—É–¥–∞–ª–µ–Ω–Ω–∞—è –ø—è—Ç–Ω–∏—Ü–∞","–∑–∞–≥–∞–¥–æ—á–Ω—ã–π –¥–µ–¥–ª–∞–π–Ω","–Ω–æ—á–Ω–æ–π –ø–æ—Ö–æ–¥ –≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫","—Ç–∏–∫-—Ç–æ–∫ –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö ‚Äî —á—Ç–µ–Ω–∏–µ","—Å–ª—É—á–∞–π–Ω—ã–π –∞–∫—Ç –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"
  ], nsfwBlack:[], nsfwWhite:[] };

  function ensureMinimumDeck(base){
    const MIN_BLACK=120, MIN_WHITE=500;
    const adj=["–±–µ—Å–∫–æ–º–ø—Ä–æ–º–∏—Å—Å–Ω—ã–π","–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π","—Å–∫—Ä–æ–º–Ω—ã–π","—Ö—Ä—É–ø–∫–∏–π","—Å—Ç–∞–ª—å–Ω–æ–π","–º—è–≥–∫–∏–π","–Ω–µ—É–¥–æ–±–Ω—ã–π","—É–¥–∏–≤–∏—Ç–µ–ª—å–Ω—ã–π","–∫–æ—Å–º–∏—á–µ—Å–∫–∏–π","—Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–π","–Ω—É–ª–µ–≤–æ–π","—Å–ª—É—á–∞–π–Ω—ã–π","–¥–æ–º–∞—à–Ω–∏–π","—Ç—É—Ä–±–æ","–∞–Ω—Ç–∏—Å—Ç—Ä–µ—Å—Å","—á–∏—Å—Ç–æ—Å–µ—Ä–¥–µ—á–Ω—ã–π","–±–æ—Ç–∞–Ω—Å–∫–∏–π","–∫–∞—Ä–º–∞–Ω–Ω—ã–π","–ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π","–≥—Ä—É—Å—Ç–Ω—ã–π","–≥–µ—Ä–æ–∏—á–µ—Å–∫–∏–π","–≤–∏–Ω–æ–≤–∞—Ç—ã–π","—Å—Ç—Ä–∞–Ω–Ω—ã–π","–ø–∞–Ω–∏—á–µ—Å–∫–∏–π","–æ—Å–æ–∑–Ω–∞–Ω–Ω—ã–π","–≤–∞—Ñ–µ–ª—å–Ω—ã–π","—ç–∫–æ–ª–æ–≥–∏—á–Ω—ã–π","—É–º–Ω—ã–π","—Å–≤–µ—Ä—Ö–≤–∞–∂–Ω—ã–π","–Ω–µ–æ–±—ä—è—Å–Ω–∏–º—ã–π"];
    const noun=["–∫–∞–∫—Ç—É—Å","–µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫","–∫–µ–∫—Å","–ø–ª–µ–¥","—Ä–∏–º–µ–π–∫ –¥–µ—Ç—Å—Ç–≤–∞","–∫–æ—Ç –≤ –∫–æ—Ä–æ–±–∫–µ","—Ç–∞–Ω–µ—Ü –ø–æ–±–µ–¥–∏—Ç–µ–ª—è","—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–∏—Ç—É–∞–ª","–ø–ª–∞–Ω –ë","–∑—É–º-—Å–æ–∑–≤–æ–Ω","–º–∞—Ä–∞—Ñ–æ–Ω —Å–µ—Ä–∏–∞–ª–æ–≤","–ø–∞–∫–µ—Ç –±–∞–≥–æ–≤","–¥–∏–≤–∞–Ω–Ω—ã–π —Å—Ç–∞—Ä—Ç–∞–ø","–∞–ø–¥–µ–π—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è","—á–∞–π –±–µ–∑ —Å–∞—Ö–∞—Ä–∞","—Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã","–Ω–µ–ª–æ–≤–∫–∞—è –ø–∞—É–∑–∞","—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å","–ø–µ—Ä–µ—Ä—ã–≤ –Ω–∞ —Å–µ–±—è","–ø–æ—Ö–≤–∞–ª–∞ —Å–∞–º–æ–º—É —Å–µ–±–µ","–∫–∞—Ä—Ç–∞ –∂–µ–ª–∞–Ω–∏–π","—Ñ–∞–Ω—Ç–∞–∑–∏—è","—á–∏—Å—Ç—ã–π —Å—Ç–æ–ª","–Ω–æ–≤—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫","—Ç–∞–π–º–µ—Ä –Ω–∞ 5 –º–∏–Ω—É—Ç","–ø–∏—â–∞ –¥–ª—è —É–º–∞","—Å–æ–Ω –¥–Ω—ë–º","—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–∞ —Ä–∞—Å—Ç—è–∂–∫—É","–≤–¥–æ—Ö —á–µ—Ä–µ–∑ –Ω–æ—Å","–º–æ–ª—á–∞–ª–∏–≤–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ"];
    const tails=["–≤ –ø–æ–¥–∞—Ä–æ–∫","–≤ 3 —á–∞—Å–∞ –Ω–æ—á–∏","–ø–æ –ø–æ–¥–ø–∏—Å–∫–µ","–Ω–∞ —Å–∫–æ—Ä—É—é —Ä—É–∫—É","–≤ —Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ","–±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π","—Å –¥–æ—Å—Ç–∞–≤–∫–æ–π –∑–∞–≤—Ç—Ä–∞","–ø–æ –ª—é–±–≤–∏","–Ω–∞ —É–¥–∞–ª—ë–Ω–∫–µ","—Å –∑–∞–∫—Ä—ã—Ç—ã–º–∏ –≥–ª–∞–∑–∞–º–∏","—Å –æ–¥–æ–±—Ä–µ–Ω–∏—è –∫–æ—Ç–∞","–≤–º–µ—Å—Ç–æ —Å–ø–æ—Ä—Ç–∞","–≤ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ–π —Ñ–æ—Ä–º–µ","–±–µ–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏","—Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ —É—Å–∏–ª–∏—è–º–∏","–≤ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–µ–∫—É–Ω–¥—É","—Å –≤–∏–¥–æ–º –Ω–∞ –∫—É—Ö–Ω—é","–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ä–∞–∑—É–º–Ω–æ–≥–æ","–Ω–∞ –ø–æ–ª–Ω–æ–º —Å–µ—Ä—å—ë–∑–µ","–¥–ª—è –≥–∞–ª–æ—á–∫–∏","—Å –æ–≥–æ–Ω—å–∫–æ–º","–ø–æ –≤—ã—Ö–æ–¥–Ω—ã–º","–¥–ª—è –¥—É—à–∏","–ø–æ–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ","–∫–∞–∫-–Ω–∏–±—É–¥—å –ø–æ—Ç–æ–º","–≤ —Ö–æ—Ä–æ—à–µ–º —Å–º—ã—Å–ª–µ","–Ω–µ –¥–ª—è –æ—Ç—á—ë—Ç–∞","–ø–æ –ø—Ä–∏–∫–æ–ª—É","–ø–æ —Å—Ç–∞—Ä–æ–π –ø–∞–º—è—Ç–∏","–±–µ–∑ –ø—Ä–∏—á–∏–Ω"];
    function genWhite(i){ return `${adj[i%adj.length]} ${noun[(i*7)%noun.length]} ${tails[(i*13)%tails.length]}`; }
    const blackStarts=["–ú–æ–π –¥–µ–Ω—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å ____.","–ù–∞ —Å–æ–≤–µ—â–∞–Ω–∏–∏ –ª—É—á—à–µ –Ω–µ –æ–±—Å—É–∂–¥–∞—Ç—å ____.","–°–µ–∫—Ä–µ—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî ____.","–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –ø–ª–∞–Ω: –∫–æ—Ñ–µ, –¥–µ–ª–∞ –∏ ____.","–°–∞–º—ã–π —Å—Ç—Ä–∞–Ω–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ ‚Äî ____.","–Ø –±—ã —Å —Ä–∞–¥–æ—Å—Ç—å—é –∑–∞–º–µ–Ω–∏–ª(–∞) –≥–∏–º–Ω –Ω–∞ ____.","–ö–æ–≥–¥–∞ –Ω–∏–∫—Ç–æ –Ω–µ –≤–∏–¥–∏—Ç, —è –ø—Ä–∞–∫—Ç–∏–∫—É—é ____.","–õ—É—á—à–µ–µ, —á—Ç–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ —Ä–µ–∑—é–º–µ ‚Äî ____.","–ò–¥–µ–∞–ª—å–Ω–æ–µ –∞–ª–∏–±–∏: ____.","–ì–ª–∞–≤–Ω—ã–π –∞–Ω—Ç–∏—Å—Ç—Ä–µ—Å—Å ‚Äî ____.","–°–ø–æ—Ä–∏–º, –≤ 2035 –º—ã –±—É–¥–µ–º –ø–ª–∞—Ç–∏—Ç—å –∑–∞ ____.","–í –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–º —á–∞—Ç–µ –∑–∞–±–∞–Ω–∏–ª–∏ —Ç–µ–º—É ____.","–ì–ª–∞–≤–Ω–∞—è —Ñ–∏—á–∞ –Ω–æ–≤–æ–≥–æ –∞–π—Ñ–æ–Ω–∞ ‚Äî ____.","–ï—Å–ª–∏ –±—ã —É –º–µ–Ω—è –±—ã–ª —Å–ª–æ–≥–∞–Ω, –æ–Ω –±—ã –±—ã–ª –ø—Ä–æ ____.","–ù–∞ TED —è –≤—ã—Å—Ç—É–ø–ª—é –ø—Ä–æ ____.","–ú–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫—Ä–∏—Ç–∏–∫ –æ–±–æ–∂–∞–µ—Ç ____.","–®–µ—Ñ –º–µ—á—Ç–∞–µ—Ç –≤–Ω–µ–¥—Ä–∏—Ç—å ____.","User story –Ω–∞ —Å–µ–≥–æ–¥–Ω—è ‚Äî ____.","–Ø –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –æ—Ç–∫–∞–∑—ã–≤–∞—é—Å—å –æ—Ç ____.","–°–µ–≥–æ–¥–Ω—è –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è –≤—Å—ë, –∫—Ä–æ–º–µ ____."];
    const needW=Math.max(0, MIN_WHITE-(base.white?.length||0)); for(let i=0;i<needW;i++) base.white.push(genWhite(i));
    const needB=Math.max(0, MIN_BLACK-(base.black?.length||0)); for(let i=0;i<needB;i++) base.black.push(blackStarts[i%blackStarts.length]);
  }

  // ===== Firebase init (–∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥) =====
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyDRtpegXwTsSf77dPIOGDIyBFvib_GgUcM",
    authDomain: "z-e86ee.firebaseapp.com",
    databaseURL: "https://z-e86ee-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "z-e86ee",
    storageBucket: "z-e86ee.appspot.com",
    messagingSenderId: "268263276853",
    appId: "1:268263276853:web:0195c839f5dd38e7214c7c",
    measurementId: "G-6ZBVR66GZE"
  };

  function isConfigFilled(cfg){
    return Object.values(cfg).every(v=> typeof v==='string' && v && !v.startsWith('PASTE_')) && /https:\/\/.+/.test(cfg.databaseURL||'');
  }

  let db = null; let firebaseInitError = null; let connectivityOk = false; let lastConnMsg = '';
  try {
    if (!isConfigFilled(FIREBASE_CONFIG)) throw new Error('–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω FIREBASE_CONFIG');
    firebase.initializeApp(FIREBASE_CONFIG);
    db = firebase.database();
  } catch (e){
    firebaseInitError = e;
    console.error('Firebase init error:', e);
  }

  async function testDbConnection(){
    if (!db){ lastConnMsg='Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'; updateConnStatus(false,lastConnMsg); return false; }
    try {
      const pingRef = db.ref('_ping').push();
      await pingRef.set({ t: Date.now(), ua: navigator.userAgent.substring(0,80) });
      await pingRef.remove();
      lastConnMsg='OK: –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ Realtime DB';
      updateConnStatus(true,lastConnMsg);
      return true;
    } catch(e){
      console.error('DB write test failed', e);
      lastConnMsg = (e && (e.code||e.message)) || '–æ—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –ë–î';
      updateConnStatus(false,lastConnMsg);
      return false;
    }
  }

  // ===== –õ–û–ì–ò–ö–ê –ö–û–ú–ù–ê–¢–´ / –°–û–°–¢–û–Ø–ù–ò–ï =====
  const STORAGE_KEY = 'zlobnye_karty_deck_v1';
  const local = { playerId: localStorage.getItem('playerId') || uid(), name:'', roomId:null, isHost:false, hostId:null, currentRound:0, hasSubmitted:false, selectedCardIndex:null, selectedCardText:'', submittedCardText:'' };
  localStorage.setItem('playerId', local.playerId);

  const game = { state: { round:0, roundsTotal:10, status:'lobby', blackCard:'', sfwOnly:true, hostName:'', hostId:null },
                 deck: { black:[], white:[], discardBlack:[], discardWhite:[] },
                 submissions: {}, submissionsOrder: [] };

  function fillBlack(black, white){
    return black.includes('____') ? black.replace('____', `<b>${escapeHtml(white)}</b>`) : `${black} ‚Äî <b>${escapeHtml(white)}</b>`;
  }
  function escapeHtml(str){
    const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' };
    return String(str).replace(/[&<>"']/g, ch => map[ch]);
  }

  // ===== –†–∞–±–æ—Ç–∞ —Å –∫–æ–ª–æ–¥–æ–π (–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –≤–µ–¥—É—â–µ–≥–æ) =====
  function loadDeckLocal(){
    const raw = localStorage.getItem(STORAGE_KEY);
    let base;
    if (raw){
      try{ base = JSON.parse(raw); }
      catch(e){ console.warn('Bad deck JSON, fallback to demo'); base = JSON.parse(JSON.stringify(DEMO_DECK)); }
    } else {
      base = JSON.parse(JSON.stringify(DEMO_DECK));
    }
    ensureMinimumDeck(base);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(base));
    const black=[...base.black], white=[...base.white];
    game.deck.black = shuffle(black);
    game.deck.white = shuffle(white);
    game.deck.discardBlack = [];
    game.deck.discardWhite = [];
    const textarea = $('#deckJson');
    if (textarea){ textarea.value = JSON.stringify(base, null, 2); }
  }
  function drawBlack(){ if(!game.deck.black.length){ game.deck.black = shuffle(game.deck.discardBlack); game.deck.discardBlack = []; } const card = game.deck.black.pop() || '‚Äî –ø—É—Å—Ç–æ ‚Äî'; return card; }
  function drawWhite(){ if(!game.deck.white.length){ game.deck.white = shuffle(game.deck.discardWhite); game.deck.discardWhite = []; } const card = game.deck.white.pop() || '‚Äî –ø—É—Å—Ç–æ ‚Äî'; return card; }

  // ===== Firebase helpers =====
  const roomRef = ()=> db.ref(`rooms/${local.roomId}`);
  const playersRef = ()=> roomRef().child('players');
  const stateRef = ()=> roomRef().child('state');
  const perPlayerRef = (pid)=> roomRef().child(`perPlayer/${pid}`); // —Ä—É–∫–∏
  const submissionsRef = ()=> roomRef().child('submissions');

  // –•–µ–ª–ø–µ—Ä: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Ä–æ–ª—å —Ö–æ—Å—Ç–∞ –ø—Ä–∏ –ª—é–±—ã—Ö –ø–µ—Ä–µ–∑–∞—Ö–æ–¥–∞—Ö
  function watchHost(){
    roomRef().child('hostId').on('value', snap => {
      const hostId = snap.val();
      local.hostId = hostId;
      const was = local.isHost;
      local.isHost = (hostId === local.playerId);
      if (local.isHost !== was) renderState();
    });
  }

  async function createRoom(){
    if (!db){ toast('–û—à–∏–±–∫–∞: Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥.'); console.error(firebaseInitError); return; }
    if (!connectivityOk){ const ok = await testDbConnection(); if(!ok){ toast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥/–ø—Ä–∞–≤–∏–ª–∞.'); return; } connectivityOk=true; }
    const id = (Math.random().toString(36).slice(2,8)).toUpperCase();
    local.roomId = id; local.isHost = true;
    loadDeckLocal();
    try{
      await roomRef().set({ hostId: local.playerId, createdAt: Date.now() });
      await stateRef().set({ ...game.state, status:'lobby', sfwOnly: $('#sfwOnly').checked });
      await db.ref(`rooms/${local.roomId}/deck`).set({ black: game.deck.black, white: game.deck.white });
      updateShareLink();
      subscribeRoom();
      watchHost();
      subscribeHostEvents();
      await registerPlayer();
      renderState();
      toast('–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞');
    } catch(e){ console.error('createRoom error', e); toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É: ' + (e.code||e.message)); }
  }

  async function joinRoom(id){
    if (!db){ toast('–û—à–∏–±–∫–∞: Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'); console.error(firebaseInitError); return; }
    const ok = connectivityOk || await testDbConnection(); if(!ok){ toast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥/–ø—Ä–∞–≤–∏–ª–∞.'); return; } connectivityOk=true;
    local.roomId = id.toUpperCase();
    local.isHost = false;
    subscribeRoom();
    watchHost();
    try{ await registerPlayer(); toast('–ü–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ'); } catch(e){ console.error('joinRoom/register error', e); toast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è: ' + (e.code||e.message)); }
  }

  let playersCount = 0;
  function subscribeRoom(){
    if (!db || !local.roomId) return;
    stateRef().off(); playersRef().off(); submissionsRef().off(); perPlayerRef(local.playerId).off();
    stateRef().on('value', snap=>{ const s=snap.val(); if(!s) return; game.state = s; renderState(); });
    playersRef().on('value', snap=>{ const players = snap.val()||{}; playersCount = Object.keys(players).length; renderPlayers(players); maybeAutoStart(players); });
    submissionsRef().on('value', snap=>{ renderSubmissions(snap.val()||{}); });
    perPlayerRef(local.playerId).on('value', snap=>{ renderHand((snap.val()&&snap.val().hand)||[]); });
  }

  async function registerPlayer(){
    if (!local.roomId) return;
    local.name = ($('#playerName').value || localStorage.getItem('playerName') || '').trim();
    if (!local.name) { local.name = '–ò–≥—Ä–æ–∫ ' + local.playerId.slice(-4); }
    localStorage.setItem('playerName', local.name);
    const pRef = playersRef().child(local.playerId);
    await pRef.set({ name: local.name, score:0, joinedAt: Date.now() });
    await pRef.onDisconnect().remove();
    // –≤—ã–¥–∞—Ç—å —Ä—É–∫—É (–≤–µ–¥—É—â–∏–π)
    if (local.isHost){
      const hand = []; for(let i=0;i<7;i++) hand.push(drawWhite());
      await perPlayerRef(local.playerId).set({ hand });
    } else {
      // –ø–æ–ø—Ä–æ—Å–∏—Ç—å –≤–µ–¥—É—â–µ–≥–æ –≤—ã–¥–∞—Ç—å –∫–∞—Ä—Ç—ã
      await roomRef().child('events').push({ type:'needHand', playerId: local.playerId, t:Date.now() });
    }
  }

  // –í–µ–¥—É—â–∏–π —Å–ª—É—à–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è
  function subscribeHostEvents(){
    if (!local.isHost) return;
    roomRef().child('events').on('child_added', async snap=>{
      const ev = snap.val() || {}; const k = snap.key;
      if (ev.type==='needHand'){
        const hand = []; for(let i=0;i<7;i++) hand.push(drawWhite());
        await perPlayerRef(ev.playerId).set({ hand });
        await roomRef().child('events').child(k).remove();
      }
    });
  }

  // ===== –õ–û–ë–ë–ò/–ò–ì–†–ê –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï =====
  function resetPlayerRoundState(round){
    local.currentRound = round || 0;
    local.hasSubmitted = false;
    local.selectedCardIndex = null;
    local.selectedCardText = '';
    local.submittedCardText = '';
  }

  function renderState(){
    const s = game.state || {};
    const status = s.status || 'lobby';
    if (status==='lobby'){ $('#screenLobby').classList.remove('hidden'); $('#screenGame').classList.add('hidden'); }
    else { $('#screenLobby').classList.add('hidden'); $('#screenGame').classList.remove('hidden'); }
    if (status==='lobby'){ resetPlayerRoundState(0); }
    if (status==='collect' && (s.round||0) !== local.currentRound){
      resetPlayerRoundState(s.round||0);
    }
    $('#roomIdLabel').textContent = local.roomId || '‚Äî';
    $('#roundN').textContent = s.round || 0; $('#roundTotal').textContent = s.roundsTotal || 10;
    $('#hostName').textContent = s.hostName || '‚Äî';
    $('#blackText').innerHTML = escapeHtml(s.blackCard || '‚Äî');
    const statusMap = { lobby:'–æ–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤', collect:'—Å–±–æ—Ä –æ—Ç–≤–µ—Ç–æ–≤', result:'—Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—É–Ω–¥–∞' };
    $('#statusHint').textContent = '–°—Ç–∞—Ç—É—Å: ' + (statusMap[status] || '‚Äî');
    $('#handSection').classList.toggle('hidden', status==='lobby');
    $('#hostPanel').classList.toggle('hidden', status==='lobby');
    const isResult = status==='result';
    $('#resultPanel').classList.toggle('hidden', !isResult);
    if (isResult){
      const winnerName = s.lastWinnerName || '‚Äî';
      const answer = s.lastAnswer || '';
      $('#winnerLine').innerHTML = `${escapeHtml(winnerName)} –ø–æ–ª—É—á–∞–µ—Ç –æ—á–∫–æ –∑–∞: ${fillBlack(s.blackCard||'', answer)}`;
    }
    updateSelectionUI();
    updateHostHint();
    renderSubmissions(game.submissions);
    $('#nextRound').classList.toggle('hidden', !local.isHost);
  }

  function renderPlayers(players){
    const box=$('#playersList'); box.innerHTML='';
    const arr=Object.entries(players).map(([id,p])=>({id,...p})).sort((a,b)=> (b.score||0)-(a.score||0));
    arr.forEach(p=>{
      const row=document.createElement('div'); row.className='kicker'; row.style.padding='6px 0';
      const isHost = p.id === (local.hostId || game.state.hostId);
      row.innerHTML=`<div>${escapeHtml(p.name)} ${isHost?'<span class="small muted">(–≤–µ–¥—É—â–∏–π)</span>':''}</div><div class="chip">${p.score||0}</div>`;
      box.appendChild(row);
    });
  }

  function orderedPlayerIds(players){
    return Object.keys(players||{}).sort((a,b)=>{
      const ja = players[a]?.joinedAt || 0;
      const jb = players[b]?.joinedAt || 0;
      if (ja !== jb) return ja - jb;
      return a.localeCompare(b);
    });
  }

  function renderHand(hand){
    const box=$('#handCards'); box.innerHTML='';
    const disabled = local.hasSubmitted || (game.state.status!=='collect');
    hand.forEach((txt,i)=>{
      const btn=document.createElement('button'); btn.className='card'; btn.dataset.index=i; btn.style.textAlign='left';
      btn.innerHTML = `<div class="big">${escapeHtml(txt)}</div>`;
      if (disabled){
        btn.disabled = true;
        btn.classList.add('disabled');
      } else {
        btn.disabled = false;
        btn.classList.add('selectable');
        btn.onclick=()=> selectCard(i, txt);
      }
      box.appendChild(btn);
    });
    if (disabled){
      local.selectedCardIndex = null;
      local.selectedCardText = '';
    } else if (local.selectedCardIndex !== null && local.selectedCardIndex >= hand.length){
      local.selectedCardIndex = null;
      local.selectedCardText = '';
    }
    refreshHandSelectionStyles();
    updateSelectionUI();
  }

  function selectCard(idx, text){
    if (local.hasSubmitted) return;
    if ((game.state.status||'')!=='collect') return;
    local.selectedCardIndex = idx;
    local.selectedCardText = text;
    refreshHandSelectionStyles();
    updateSelectionUI();
  }

  function refreshHandSelectionStyles(){
    const status = game.state.status || 'lobby';
    const canPick = status==='collect' && !local.hasSubmitted;
    $$('#handCards .card').forEach(el=>{
      const idx = Number(el.dataset.index);
      const isSelected = idx === local.selectedCardIndex && canPick;
      el.classList.toggle('selected', isSelected);
      el.classList.toggle('disabled', !canPick);
      if (canPick){
        el.classList.add('selectable');
        if (el instanceof HTMLButtonElement) el.disabled = false;
      } else {
        el.classList.remove('selectable');
        if (el instanceof HTMLButtonElement) el.disabled = true;
      }
    });
  }

  function updateSelectionUI(){
    const hint = $('#selectionHint');
    const btn = $('#btnConfirm');
    const submittedBox = $('#submittedCard');
    const status = game.state.status || 'lobby';
    if (hint){
      if (status==='collect'){
        if (local.hasSubmitted){
          hint.textContent = '–í—ã–±–æ—Ä —Å–¥–µ–ª–∞–Ω, –∂–¥—ë–º –≤–µ–¥—É—â–µ–≥–æ.';
        } else if (local.selectedCardIndex === null){
          hint.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –±–µ–ª—É—é –∫–∞—Ä—Ç—É (–≤–∞—à–∞ —Ä—É–∫–∞ –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–∞–º).';
        } else {
          hint.textContent = '–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä¬ª, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É.';
        }
      } else if (status==='result'){
        hint.textContent = '–†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à—ë–Ω, –æ–∂–∏–¥–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é —Ä–∞–∑–¥–∞—á—É.';
      } else {
        hint.textContent = '–û–∂–∏–¥–∞–µ–º –Ω–∞—á–∞–ª–æ —Ä–∞—É–Ω–¥–∞.';
      }
    }
    if (btn){
      const canConfirm = !local.hasSubmitted && status==='collect' && local.selectedCardIndex !== null;
      btn.disabled = !canConfirm;
      btn.classList.toggle('hidden', status!=='collect' || local.hasSubmitted);
    }
    if (submittedBox){
      submittedBox.classList.toggle('hidden', !local.hasSubmitted);
      if (local.hasSubmitted){
        $('#submittedCardText').textContent = local.submittedCardText || '‚Äî';
      }
    }
  }

  async function submitCard(text){
    const status = (game.state && game.state.status) || 'lobby';
    if (status!=='collect'){ toast('–°–µ–π—á–∞—Å –Ω–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É'); return; }
    const handSnap = await perPlayerRef(local.playerId).get();
    let hand=(handSnap.val()&&handSnap.val().hand)||[];
    let idx = local.selectedCardIndex;
    if (idx==null || hand[idx] !== text){ idx = hand.indexOf(text); }
    if (idx<0){ toast('–ö–∞—Ä—Ç–∞ —É–∂–µ —Ä–∞–∑—ã–≥—Ä–∞–Ω–∞'); return; }
    hand.splice(idx,1);
    await perPlayerRef(local.playerId).set({ hand });
    const id = uid(); await submissionsRef().child(id).set({ playerId: local.playerId, text, t:Date.now() });
    local.hasSubmitted = true;
    local.submittedCardText = text;
    local.selectedCardIndex = null;
    local.selectedCardText = '';
    refreshHandSelectionStyles();
    updateSelectionUI();
    updateHostHint();
    toast('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
  }

  function updateHostHint(){
    const hostHint = $('#hostHint');
    if (!hostHint) return;
    const status = game.state.status || 'lobby';
    const submissionsCount = Object.keys(game.submissions||{}).length;
    if (status==='lobby'){
      hostHint.textContent = '–ñ–¥—ë–º –∏–≥—Ä–æ–∫–æ–≤.';
      return;
    }
    if (status==='collect'){
      if (local.isHost){
        hostHint.textContent = submissionsCount ? '–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –ª—É—á—à–∏–π –æ—Ç–≤–µ—Ç.' : '–ñ–¥—ë–º, –ø–æ–∫–∞ –∏–≥—Ä–æ–∫–∏ –≤—ã–±–µ—Ä—É—Ç –∫–∞—Ä—Ç—ã.';
      } else {
        hostHint.textContent = local.hasSubmitted ? '–ñ–¥—ë–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏ —Ä–µ—à–µ–Ω–∏–µ –≤–µ–¥—É—â–µ–≥–æ.' : '–°–¥–µ–ª–∞–π—Ç–µ –≤—ã–±–æ—Ä –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∫–∞—Ä—Ç—É.';
      }
    } else if (status==='result'){
      hostHint.textContent = local.isHost ? '–ù–∞–∂–º–∏—Ç–µ ¬´–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥¬ª, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.' : '–í–µ–¥—É—â–∏–π —Ä–µ—à–∞–µ—Ç, –∫–æ–≥–¥–∞ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ä–∞—É–Ω–¥—É.';
    } else {
      hostHint.textContent = '–ñ–¥—ë–º –≤–µ–¥—É—â–µ–≥–æ.';
    }
  }

  function renderSubmissions(map){
    game.submissions = map || {};
    const box=$('#submissions'); box.innerHTML='';
    const entries = Object.entries(game.submissions);
    if (!entries.length){
      game.submissionsOrder = [];
      const empty=document.createElement('div'); empty.className='muted small'; empty.textContent='–ü–æ–∫–∞ –Ω–µ—Ç —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç.';
      box.appendChild(empty);
      updateHostHint();
      return;
    }
    const keys = entries.map(([id])=>id);
    const orderCurrent = Array.isArray(game.submissionsOrder) ? game.submissionsOrder.filter(id=>game.submissions[id]) : [];
    let order = orderCurrent;
    const sameSize = order.length === keys.length;
    const sameSet = sameSize && order.every(id=> game.submissions[id]);
    if (!sameSet){
      order = shuffle([...keys]);
      game.submissionsOrder = order.slice();
    }
    const items = order.map(id=>({ id, ...(game.submissions[id]||{}) })).filter(s=> typeof s.text === 'string');
    if (!items.length){
      const empty=document.createElement('div'); empty.className='muted small'; empty.textContent='–ü–æ–∫–∞ –Ω–µ—Ç —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç.';
      box.appendChild(empty);
      updateHostHint();
      return;
    }
    const reveal = local.isHost || (game.state.status==='result');
    if (!reveal){
      const wait=document.createElement('div'); wait.className='muted small'; wait.textContent='–û—Ç–≤–µ—Ç—ã —Å–∫—Ä—ã—Ç—ã –¥–æ –≤—ã–±–æ—Ä–∞ –≤–µ–¥—É—â–µ–≥–æ.';
      box.appendChild(wait);
      updateHostHint();
      return;
    }
    items.forEach(s=>{
      const b=document.createElement('button'); b.className='card'; b.style.textAlign='left';
      b.innerHTML=`<div class="muted small">–û—Ç–≤–µ—Ç</div><div class="big">${fillBlack(game.state.blackCard||'', s.text)}</div>`;
      if (local.isHost && game.state.status==='collect'){
        b.onclick=()=> pickWinner(s.playerId, s.text);
      } else {
        b.classList.add('readonly');
        b.setAttribute('tabindex','-1');
      }
      box.appendChild(b);
    });
    updateHostHint();
  }

  // ===== –í–µ–¥—É—â–∏–π: —Å—Ç–∞—Ä—Ç/—Ä–∞—É–Ω–¥—ã/–ø–æ–±–µ–¥–∏—Ç–µ–ª—å =====
  function maybeAutoStart(players){
    try{
      if (!local.isHost) return;
      if ((game.state && game.state.status)!=='lobby') return;
      const count = Object.keys(players||{}).length;
      if (count >= 2) { startGameHost(); }
    } catch(e){ console.warn('autoStart skipped', e); }
  }

  async function startGameHost(){
    if (!local.isHost) return toast('–¢–æ–ª—å–∫–æ –≤–µ–¥—É—â–∏–π –º–æ–∂–µ—Ç —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å');
    if (playersCount < 2) return toast('–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –∏–≥—Ä–æ–∫–∞');
    game.state.round=1; game.state.status='collect'; game.state.roundsTotal=10;
    const playersSnap = await playersRef().get(); const players = playersSnap.val()||{}; const ids = orderedPlayerIds(players);
    for(const pid of ids){ const handSnap = await perPlayerRef(pid).get(); let hand=(handSnap.val()&&handSnap.val().hand)||[]; while(hand.length<7) hand.push(drawWhite()); await perPlayerRef(pid).set({ hand }); }
    const hostId = local.playerId;
    const hostName = players[hostId]?.name || local.name || '‚Äî';
    const black = drawBlack();
    await stateRef().set({ round:1, roundsTotal:game.state.roundsTotal, status:'collect', hostId, hostName, blackCard:black, lastWinnerName:'', lastAnswer:'', sfwOnly: $('#sfwOnly').checked });
    await submissionsRef().remove();
    game.submissions = {};
    game.submissionsOrder = [];
    renderSubmissions(game.submissions);
    await db.ref(`rooms/${local.roomId}/deck`).set({ black: game.deck.black, white: game.deck.white, discardBlack: game.deck.discardBlack, discardWhite: game.deck.discardWhite });
    resetPlayerRoundState(1);
    updateSelectionUI();
  }

  async function pickWinner(playerId, answer){
    if (!local.isHost) return;
    const pRef = playersRef().child(playerId); const pSnap = await pRef.get(); const p=pSnap.val()||{}; await pRef.update({ score:(p.score||0)+1 });
    Object.values(game.submissions).forEach(s=>{ if (s && typeof s.text==='string') game.deck.discardWhite.push(s.text); });
    await db.ref(`rooms/${local.roomId}/deck`).update({ discardWhite: game.deck.discardWhite });
    await stateRef().update({ status:'result', lastWinnerName: p.name, lastAnswer: answer });
    toast(`–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${p.name||'‚Äî'}`);
  }

  async function nextRoundHost(){
    if (!local.isHost) return; const sSnap = await stateRef().get(); const s = sSnap.val(); if (!s) return;
    if (s.round >= s.roundsTotal) { toast('–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞'); return; }
    const players = (await playersRef().get()).val()||{}; const ids = orderedPlayerIds(players);
    for(const pid of ids){ const handSnap = await perPlayerRef(pid).get(); let hand=(handSnap.val()&&handSnap.val().hand)||[]; while(hand.length<7) hand.push(drawWhite()); await perPlayerRef(pid).set({ hand }); }
    await submissionsRef().remove();
    game.submissions = {};
    game.submissionsOrder = [];
    renderSubmissions(game.submissions);
    if (s.blackCard) game.deck.discardBlack.push(s.blackCard);
    const black = drawBlack();
    await stateRef().set({ ...s, round: s.round+1, status:'collect', blackCard:black, lastWinnerName:'', lastAnswer:'' });
    await db.ref(`rooms/${local.roomId}/deck`).set({ black: game.deck.black, white: game.deck.white, discardBlack: game.deck.discardBlack, discardWhite: game.deck.discardWhite });
    resetPlayerRoundState((s.round||0)+1);
    updateSelectionUI();
  }

  // ===== –¢–µ—Å—Ç—ã (–ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–ª—è —á–∏—Å—Ç—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π) =====
  const tests=[]; function test(name,fn){tests.push({name,fn});} function expect(cond,msg){ if(!cond) throw new Error(msg||'assert failed'); }
  async function runTests(){
    const out=[]; for(const t of tests){ try{ await t.fn(); out.push({name:t.name,ok:true}); }catch(e){ out.push({name:t.name,ok:false,err:e.message}); } }
    const lines = out.map(r=> `${r.ok?'‚úÖ':'‚ùå'} ${r.name}${r.ok?'':` ‚Äî ${r.err}`}`).join('\n'); $('#testsOutput').textContent=lines||'–ù–µ—Ç —Ç–µ—Å—Ç–æ–≤'; $('#dlgTests').showModal(); console.table(out);
  }
  // —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã (–Ω–µ –º–µ–Ω—è–µ–º)
  test('ensureMinimumDeck(): >=120/500',()=>{ const base={black:[],white:[]}; ensureMinimumDeck(base); expect(base.black.length>=120,'black<120'); expect(base.white.length>=500,'white<500'); });
  test('fillBlack() placeholder',()=>{ const s=fillBlack('A ____ B','X'); expect(/<b>X<\/b>/.test(s),'no replace'); });
  // –Ω–æ–≤—ã–µ —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã
  test('fillBlack() no placeholder path',()=>{ const s=fillBlack('–ü—Ä–∏–≤–µ—Ç','–º–∏—Ä'); expect(/–ü—Ä–∏–≤–µ—Ç\s‚Äî\s<b>–º–∏—Ä<\/b>/.test(s),'no dash concat'); });
  test('escapeHtml() double quote',()=>{ const s=escapeHtml('"'); expect(s==='&quot;','not &quot;'); });
  test('escapeHtml() complex',()=>{ const s=escapeHtml('<tag> & "\'"'); expect(s.includes('&lt;tag&gt;') && s.includes('&amp;') && s.includes('&quot;') && s.includes('&#39;'),'escape failed'); });
  test('ensureMinimumDeck() idempotent-ish',()=>{ const base={black:["Q"],white:["W"]}; ensureMinimumDeck(base); const b1=base.black.length,w1=base.white.length; ensureMinimumDeck(base); expect(base.black.length>=b1 && base.white.length>=w1,'not growing to min'); });

  // ===== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ =====
  $('#btnHow').onclick=()=> $('#dlgRules').showModal();
  $('#btnDeck').onclick=()=> $('#dlgDeck').showModal();
  $('#btnSaveDeck').onclick=()=>{ try{ const j=JSON.parse($('#deckJson').value); localStorage.setItem(STORAGE_KEY, JSON.stringify(j)); toast('–ö–æ–ª–æ–¥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞'); if(local.isHost) loadDeckLocal(); }catch(e){ alert('–û—à–∏–±–∫–∞ JSON: '+e.message);} };
  $('#btnResetDeck').onclick=()=>{ localStorage.removeItem(STORAGE_KEY); if(local.isHost) loadDeckLocal(); $('#deckJson').value=JSON.stringify(DEMO_DECK,null,2); toast('–°–±—Ä–æ—Å–∏–ª–∏ –∫ –¥–µ–º–æ'); };
  $('#btnExport').onclick=()=>{ const blob=new Blob([$('#deckJson').value],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='deck.json'; a.click(); };
  $('#btnImport').onclick=async()=>{ const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange=async()=>{ const f=inp.files[0]; if(!f) return; $('#deckJson').value=await f.text(); }; inp.click(); };
  $('#btnTests').onclick=runTests;
  $('#btnNew').onclick=()=> location.href = location.origin + location.pathname;
  $('#btnCreate').onclick=async()=>{ await createRoom(); };
  $('#btnJoin').onclick=async()=>{ const id=($('#roomInput').value||'').trim(); if(!id) return toast('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã'); await joinRoom(id); };
  $('#btnCopy').onclick=()=>{ navigator.clipboard.writeText($('#shareLink').value); toast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'); };
  $('#btnConfirm').onclick=()=>{ if (local.hasSubmitted) return; if (!local.selectedCardText){ toast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É'); return; } submitCard(local.selectedCardText); };
  $('#nextRound').onclick=nextRoundHost;

  function updateShareLink(){
    const url = new URL(location.href); url.searchParams.set('room', local.roomId); $('#shareLink').value=url.toString(); $('#shareRow').style.display='flex'; history.replaceState(null,'',url);
  }

  // ===== –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ ?room= =====
  async function autoJoinFromURL(){
    const url = new URL(location.href); const room=url.searchParams.get('room');
    if(room){ $('#roomInput').value=room; await joinRoom(room); }
  }

  // ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è =====
  function init(){
    $('#playerName').value = localStorage.getItem('playerName') || '';
    $('#deckJson').value = JSON.stringify(DEMO_DECK, null, 2);
    const room = new URL(location.href).searchParams.get('room'); if (room){ $('#roomInput').value=room; $('#shareRow').style.display='flex'; $('#shareLink').value=location.href; }
    if (firebaseInitError){ updateConnStatus(false, '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: '+firebaseInitError.message); }
  }
  function updateConnStatus(ok,msg){ const el=$('#connStatus'); if(!el) return; el.textContent='–°—Ç–∞—Ç—É—Å: ' + (ok?'–ø–æ–¥–∫–ª—é—á–µ–Ω–æ':'–æ—à–∏–±–∫–∞'); el.title=msg||''; el.style.background= ok ? 'var(--accent-2)' : 'var(--chip)'; }
  $('#btnCheck').onclick = async ()=>{ await testDbConnection(); toast('–ü—Ä–æ–≤–µ—Ä–∫–∞: '+ lastConnMsg); };
  init(); autoJoinFromURL(); setTimeout(()=>testDbConnection(), 300);
  </script>
</body>
</html>
