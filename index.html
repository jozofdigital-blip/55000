<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>500 –∑–ª–æ–±–Ω—ã—Ö –∫–∞—Ä—Ç ‚Äî –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</title>
  <style>
    :root{
      --bg:#0d1016;--panel:#171b27;--panel-soft:rgba(23,27,39,.86);
      --muted:#8b93a7;--text:#f1f3fb;--accent:#7c5cff;--accent-2:#25d0a2;
      --danger:#ff5c7c;--chip:#20263a;--border:#2a3248;--card:#1b2030;
      --shadow:0 16px 44px rgba(0,0,0,.45);--focus-ring:0 0 0 3px rgba(124,92,255,.35);
      --safe-bottom:env(safe-area-inset-bottom,0px)
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,"Noto Sans","Helvetica Neue",Arial;
      min-height:100vh;
      background:radial-gradient(circle at 20% -10%,rgba(124,92,255,.25),transparent 55%),
                 radial-gradient(circle at 80% -10%,rgba(37,208,162,.18),transparent 60%),var(--bg);
      color:var(--text)
    }
    .wrap{max-width:900px;margin:0 auto;padding:0 16px 140px}
    header{display:flex;align-items:center;justify-content:space-between;padding:18px 20px 12px;position:sticky;top:0;z-index:30;background:linear-gradient(180deg,rgba(13,16,22,.95),rgba(13,16,22,.65) 60%,transparent);backdrop-filter:blur(12px)}
    .logo{display:flex;gap:12px;font-weight:800;font-size:20px}
    .logo b{background:linear-gradient(135deg,var(--accent),#b28dff);-webkit-background-clip:text;background-clip:text;color:transparent}

    main{display:none;margin-top:24px}.active{display:block}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:22px;padding:22px;box-shadow:var(--shadow);backdrop-filter:blur(10px)}
    .muted{color:var(--muted)} .small{font-size:13px;opacity:.85}

    /* –ö–ù–û–ü–ö–ò */
    button{border:none;font:inherit;cursor:pointer;transition:transform .16s,filter .18s,box-shadow .2s}
    button:disabled{opacity:.55;cursor:not-allowed;box-shadow:none;transform:none;filter:none}
    button:focus-visible{outline:none;box-shadow:var(--focus-ring)}
    .primary{background:var(--accent);color:#fff;padding:13px 18px;border-radius:16px;font-weight:700;box-shadow:var(--shadow)}
    .ghost-rounded{padding:12px 16px;border-radius:16px;font-weight:600}

    /* –ò–ù–ü–£–¢–´ ‚Äî —Ñ–∏–∫—Å ¬´–∫—Ä–∏–≤–æ—Å—Ç–∏¬ª */
    label{display:flex;flex-direction:column;gap:8px;font-weight:600}
    input[type="text"], textarea{
      width:100%;
      appearance:none;-webkit-appearance:none;
      padding:14px 16px;
      border-radius:16px;
      border:1px solid var(--border);
      background:rgba(32,38,58,.75);
      color:var(--text);
      font-size:17px; line-height:1.4;
      outline:none;
      transition:border .15s ease, box-shadow .15s ease, background .15s ease;
    }
    input[type="text"]::placeholder{color:#9aa3bb}
    input[type="text"]:hover{background:rgba(32,38,58,.85)}
    input[type="text"]:focus{border-color:var(--accent);box-shadow:var(--focus-ring);background:rgba(32,38,58,.95)}
    .field-gap{display:flex;flex-direction:column;gap:16px;margin-bottom:18px}
    .actions-row{display:flex;flex-direction:column;gap:12px;margin-top:10px}

    .status-board{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:18px}
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--border);color:#d2d9ef;padding:8px 12px;border-radius:999px;font-size:13px;font-weight:600}
    .black-card{background:#050608;border:1px solid #1f2536;color:#fff;border-radius:22px;padding:22px;margin-bottom:20px;box-shadow:0 18px 48px rgba(0,0,0,.45)}
    .cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:14px}
    .answer-card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:18px;text-align:left;line-height:1.5;transition:transform .2s,box-shadow .2s}
    .answer-card.selectable{cursor:pointer}
    .answer-card.selectable:hover{transform:translateY(-2px);box-shadow:0 18px 40px rgba(0,0,0,.4)}
    .answer-card.selected{outline:2px solid var(--accent);box-shadow:0 0 0 3px rgba(124,92,255,.35),0 18px 40px rgba(0,0,0,.45);transform:translateY(-3px)}
    .answer-card.disabled{opacity:.55;pointer-events:none}

    .toast{position:fixed;left:50%;bottom:calc(20px + var(--safe-bottom));transform:translate(-50%,60px);padding:14px 18px;background:var(--panel-soft);border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:var(--shadow);font-weight:600;opacity:0;pointer-events:none;transition:transform .25s,opacity .22s;z-index:120}
    .toast.show{opacity:1;pointer-events:auto;transform:translate(-50%,-4px)}

    #actionBar{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(16px + var(--safe-bottom));width:min(560px,calc(100vw - 28px));display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px 18px;background:rgba(20,23,34,.96);border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:var(--shadow);backdrop-filter:blur(14px);z-index:50;transition:opacity .2s,transform .24s}
    #actionBar.hidden{opacity:0;pointer-events:none;transform:translate(-50%,40px)}
    @media (max-width:640px){.wrap{padding:0 14px 160px}.card,.black-card{padding:20px}}
  </style>
</head>
<body>
  <header><div class="logo">üÉè <b>500 –∑–ª. –∫–∞—Ä—Ç</b></div></header>

  <div class="wrap">
    <!-- –í–µ–¥—É—â–∏–π: —Å–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É -->
    <main id="screenCreate" class="active">
      <section class="card">
        <h1>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</h1>
        <p class="muted">–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π. –ö–æ–≥–¥–∞ –∏–≥—Ä–æ–∫–∏ –ø–æ–¥–∫–ª—é—á–∞—Ç—Å—è, –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–∞—á–∞—Ç—å –∏–≥—Ä—É¬ª.</p>
        <div class="field-gap">
          <label>–í–∞—à–µ –∏–º—è
            <input type="text" id="createName" maxlength="24" autocomplete="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –°–µ—Ä–≥–µ–π" />
          </label>
          <label>ID –∫–æ–º–Ω–∞—Ç—ã
            <input type="text" id="createRoomId" maxlength="8" autocomplete="off" />
          </label>
        </div>
        <div class="actions-row">
          <button id="btnCreateRoom" class="primary">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
          <span id="createError" class="muted" style="color:#ffb1c5;min-height:20px;"></span>
        </div>
      </section>
    </main>

    <!-- –ò–≥—Ä–æ–∫ –ø–æ —Å—Å—ã–ª–∫–µ: —Ç–æ–ª—å–∫–æ –∏–º—è + ¬´–í–æ–π—Ç–∏ –≤ –∏–≥—Ä—É¬ª, —Å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ–º -->
    <main id="screenNameOnly">
      <section class="card">
        <h1>–í–≤–µ–¥–∏—Ç–µ –∏–º—è</h1>
        <p class="muted" id="inviteLine" style="margin-top:-6px">–í–∞—Å –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç <b id="inviterName">‚Ä¶</b></p>
        <div class="field-gap" style="margin-top:8px">
          <label>–í–∞—à–µ –∏–º—è
            <input type="text" id="nameOnly" maxlength="24" autocomplete="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –õ—ë—à–∞" />
          </label>
        </div>
        <div class="actions-row">
          <button id="btnNameOnly" class="primary">–í–æ–π—Ç–∏ –≤ –∏–≥—Ä—É</button>
          <span id="nameOnlyError" class="muted" style="color:#ffb1c5;min-height:20px;"></span>
        </div>
      </section>
    </main>

    <!-- –≠–∫—Ä–∞–Ω –∏–≥—Ä—ã -->
    <main id="screenGame">
      <section class="card" id="shareSection">
        <div id="shareRow" style="display:none;align-items:center;gap:12px;margin-bottom:18px;">
          <input type="text" id="shareLink" readonly aria-label="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–º–Ω–∞—Ç—É" />
          <button id="btnCopyLink" class="ghost-rounded">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
        </div>

        <div class="status-board">
          <span class="chip" id="connStatus">–°—Ç–∞—Ç—É—Å: –Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ</span>
          <span class="chip" id="timerChip" hidden>‚è± 60s</span>
          <span class="chip" id="progressChip" hidden>0/0</span>
          <span class="chip" id="roleChip" hidden>‚Äî</span>
        </div>

        <div id="lobbyActions" class="actions-row" style="display:none;margin-top:8px;">
          <button id="btnStartGame" class="primary">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
          <span id="lobbyHint" class="muted small"></span>
        </div>

        <div class="black-card">
          <div class="muted">–ß—ë—Ä–Ω–∞—è –∫–∞—Ä—Ç–∞</div>
          <div id="blackText" style="margin-top:10px;font-size:20px;line-height:1.5;">‚Äî</div>
        </div>
        <div class="muted small" id="hostSummary">–°—Ç–∞—Ç—É—Å: –æ–∂–∏–¥–∞–Ω–∏–µ.</div>

        <div class="section-title" style="display:flex;justify-content:space-between;align-items:center;margin:28px 0 14px;">
          <h2>–í–∞—à–∏ –∫–∞—Ä—Ç—ã</h2>
        </div>
        <div class="muted small" id="handHint">–û–∂–∏–¥–∞–µ–º —Ä–∞–∑–¥–∞—á—É.</div>
        <div class="cards-grid" id="handCards" style="margin-top:14px;"></div>

        <div id="submittedCard" class="winner-card" style="margin-top:16px;display:none;">
          <div class="muted small">–í—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏</div>
          <div id="submittedText" style="margin-top:8px;font-size:18px;line-height:1.45;">‚Äî</div>
        </div>

        <div class="section-title" style="margin-top:28px;">
          <h2>–û—Ç–≤–µ—Ç—ã –Ω–∞ —Å—Ç–æ–ª–µ</h2>
        </div>
        <div id="submissionsHint" class="muted small">–ñ–¥—ë–º –∏–≥—Ä–æ–∫–æ–≤.</div>
        <div id="submissionsList" class="cards-grid" style="margin-top:14px;"></div>

        <div id="resultBlock" class="winner-card" style="margin-top:28px;display:none;">
          <div class="muted small">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å —Ä–∞—É–Ω–¥–∞</div>
          <div id="winnerLine" style="margin-top:10px;font-size:18px;line-height:1.5;">‚Äî</div>
          <div class="actions-row" style="margin-top:16px;">
            <button id="btnNextRound" class="primary">–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥</button>
            <span id="resultHint" class="muted small"></span>
          </div>
        </div>
      </section>

      <section class="card" style="margin-top:18px;">
        <div class="section-title" style="margin:0 0 14px;">
          <h2>–ò–≥—Ä–æ–∫–∏</h2>
        </div>
        <div class="scroll" id="playersList" aria-live="polite" style="max-height:320px;overflow:auto;"></div>
      </section>
    </main>
  </div>

  <div id="actionBar" class="hidden" role="status" aria-live="polite">
    <div id="actionHint">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ.</div>
    <button id="btnConfirm" class="primary" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
  // ===== constants
  const STATUS={LOBBY:'lobby',COLLECT:'collect',RESULT:'result'};
  const MIN_PLAYERS=2, ROUNDS_TOTAL=10, ROUND_TIMER_SECONDS=60;
  const STORAGE_KEY='zlobnye_karty_deck_v2', EVENTS_PATH='events';
  const AUTO_START=false;

  // ===== helpers
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const uid=()=>Math.random().toString(36).slice(2,10), now=()=>Date.now();
  const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};
  const escapeHtml=s=>String(s||'').replace(/[&<>"']/g,ch=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[ch]);
  const fillBlack=(b,w)=>{const safe=escapeHtml(w||'‚Äî');return (b||'').includes('____')?(b||'‚Äî').replace('____',`<b>${safe}</b>`):`${escapeHtml(b||'‚Äî')} ‚Äî <b>${safe}</b>`};
  function toast(msg){const el=$('#toast');el.textContent=msg;el.classList.add('show');clearTimeout(toast._t);toast._t=setTimeout(()=>el.classList.remove('show'),2400)}
  const $focus=el=>{try{el?.focus({preventScroll:true})}catch{}};
  function normalizeError(err){if(!err)return'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';if(typeof err==='string')return err;const c=err.code||'';if(c.includes('network'))return'–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Firebase.';if(c.includes('permission'))return'–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ Firebase.';if(c.includes('timeout'))return'–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ.';return err.message||'–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫.'}
  function showError(e){console.error(e);toast('–û—à–∏–±–∫–∞: '+normalizeError(e))}

  // ===== deck
  const DEMO_DECK={black:['–õ—É—á—à–µ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ –æ—Ç –ø–ª–æ—Ö–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è ‚Äî ____.',
    '–í –æ—Ñ–∏—Å–µ –∑–∞–ø—Ä–µ—Ç–∏–ª–∏ ____ –ø–æ—Å–ª–µ –ø—Ä–æ—à–ª–æ–π –≤–µ—á–µ—Ä–∏–Ω–∫–∏.','–ú–æ–π —Ç–∞–π–Ω—ã–π —Ç–∞–ª–∞–Ω—Ç ‚Äî ____.',
    '–ö–æ–º–±–æ –¥–Ω—è: ____ —Å —Å–æ—É—Å–æ–º –∏–∑ ____.','–ù–∞ –ø–µ—Ä–≤–æ–º —Å–≤–∏–¥–∞–Ω–∏–∏ –Ω–µ —Å–æ–≤–µ—Ç—É—é –æ–±—Å—É–∂–¥–∞—Ç—å ____.',
    '–£—á—ë–Ω—ã–µ –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ –ø—Ä–∏–¥—É–º–∞–ª–∏ ____.','–°–∞–º–æ–µ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ –≤ –ø–æ–¥–∞—Ä–æ–∫ ‚Äî ____.',
    '–ù–æ–≤–æ–µ —Ö–æ–±–±–∏, –æ –∫–æ—Ç–æ—Ä–æ–º —Å—Ç—ã–¥–Ω–æ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è–º: ____.','–ó–∞–≤—Ç—Ä–∞–∫ —á–µ–º–ø–∏–æ–Ω–∞ ‚Äî ____.',
    '–ü—É—Ç—å –∫ —É—Å–ø–µ—Ö—É –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å ____.',],
    white:['–π–æ–≥–∞ –ø—Ä–∏ —Å–≤–µ—Ç–µ –ª–∞–º–ø—ã','–±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ –º–µ–º—ã','–∫–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å—É–¥–∏—Ç —Ç–µ–±—è','–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ 200 —Å–ª–∞–π–¥–æ–≤','–∑–≤—É–∫–∏ –ª–µ—Å–∞ –≤ 3 —á–∞—Å–∞ –Ω–æ—á–∏','–º–∏–∫—Ä–æ–¥–æ–∑—ã —ç–Ω—Ç—É–∑–∏–∞–∑–º–∞','–µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫ –Ω–∞ 2035 –≥–æ–¥','–∫–æ—Ñ–µ —É—Ä–æ–≤–Ω—è –±–æ—Å—Å','—Ç–∞–Ω–µ—Ü —Å –ø—ã–ª–µ—Å–æ—Å–æ–º','—Å—Ä–æ—á–Ω—ã–π —Å–æ–∑–≤–æ–Ω –Ω–∏ –æ —á—ë–º','–ø–µ—Ä–µ–ø–∏—Å–∫–∞ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π','–∑–∞—Ä—è–¥–∫–∞ –¥–ª—è –ª–∏—Ü–∞ –∏ —Å–æ–≤–µ—Å—Ç–∏','–ø–æ–¥–∫–∞—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–∏–∫—Ç–æ –Ω–µ —Å–ª—É—à–∞–µ—Ç','–∫–æ–ª–ª–µ–∫—Ü–∏—è –Ω–µ—Å–±—ã–≤—à–∏—Ö—Å—è —Ü–µ–ª–µ–π','–ø–ª–µ–¥ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏','—É–¥–∞–ª—ë–Ω–Ω–∞—è –ø—è—Ç–Ω–∏—Ü–∞','–∑–∞–≥–∞–¥–æ—á–Ω—ã–π –¥–µ–¥–ª–∞–π–Ω','–Ω–æ—á–Ω–æ–π –ø–æ—Ö–æ–¥ –≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫','—Ç–∏–∫-—Ç–æ–∫ –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö ‚Äî —á—Ç–µ–Ω–∏–µ','—Å–ª—É—á–∞–π–Ω—ã–π –∞–∫—Ç –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏'],nsfwBlack:[],nsfwWhite:[]};
  function ensureMinimumDeck(base){
    const MIN_BLACK=120,MIN_WHITE=500,
      adj=['–±–µ—Å–∫–æ–º–ø—Ä–æ–º–∏—Å—Å–Ω—ã–π','–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π','—Å–∫—Ä–æ–º–Ω—ã–π','—Ö—Ä—É–ø–∫–∏–π','—Å—Ç–∞–ª—å–Ω–æ–π','–º—è–≥–∫–∏–π','–Ω–µ—É–¥–æ–±–Ω—ã–π','—É–¥–∏–≤–∏—Ç–µ–ª—å–Ω—ã–π','–∫–æ—Å–º–∏—á–µ—Å–∫–∏–π','—Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–π','–Ω—É–ª–µ–≤–æ–π','—Å–ª—É—á–∞–π–Ω—ã–π','–¥–æ–º–∞—à–Ω–∏–π','—Ç—É—Ä–±–æ','–∞–Ω—Ç–∏—Å—Ç—Ä–µ—Å—Å','—á–∏—Å—Ç–æ—Å–µ—Ä–¥–µ—á–Ω—ã–π','–±–æ—Ç–∞–Ω—Å–∫–∏–π','–∫–∞—Ä–º–∞–Ω–Ω—ã–π','–ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π','–≥—Ä—É—Å—Ç–Ω—ã–π','–≥–µ—Ä–æ–∏—á–µ—Å–∫–∏–π','–≤–∏–Ω–æ–≤–∞—Ç—ã–π','—Å—Ç—Ä–∞–Ω–Ω—ã–π','–ø–∞–Ω–∏—á–µ—Å–∫–∏–π','–æ—Å–æ–∑–Ω–∞–Ω–Ω—ã–π','–≤–∞—Ñ–µ–ª—å–Ω—ã–π','—ç–∫–æ–ª–æ–≥–∏—á–Ω—ã–π','—É–º–Ω—ã–π','—Å–≤–µ—Ä—Ö–≤–∞–∂–Ω—ã–π','–Ω–µ–æ–±—ä—è—Å–Ω–∏–º—ã–π'],
      noun=['–∫–∞–∫—Ç—É—Å','–µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫','–∫–µ–∫—Å','–ø–ª–µ–¥','—Ä–∏–º–µ–π–∫ –¥–µ—Ç—Å—Ç–≤–∞','–∫–æ—Ç –≤ –∫–æ—Ä–æ–±–∫–µ','—Ç–∞–Ω–µ—Ü –ø–æ–±–µ–¥–∏—Ç–µ–ª—è','—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–∏—Ç—É–∞–ª','–ø–ª–∞–Ω –ë','–∑—É–º-—Å–æ–∑–≤–æ–Ω','–º–∞—Ä–∞—Ñ–æ–Ω —Å–µ—Ä–∏–∞–ª–æ–≤','–ø–∞–∫–µ—Ç –±–∞–≥–æ–≤','–¥–∏–≤–∞–Ω–Ω—ã–π —Å—Ç–∞—Ä—Ç–∞–ø','–∞–ø–¥–µ–π—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è','—á–∞–π –±–µ–∑ —Å–∞—Ö–∞—Ä–∞','—Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã','–Ω–µ–ª–æ–≤–∫–∞—è –ø–∞—É–∑–∞','—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å','–ø–µ—Ä–µ—Ä—ã–≤ –Ω–∞ —Å–µ–±—è','–ø–æ—Ö–≤–∞–ª–∞ —Å–∞–º–æ–º—É —Å–µ–±–µ','–∫–∞—Ä—Ç–∞ –∂–µ–ª–∞–Ω–∏–π','—Ñ–∞–Ω—Ç–∞–∑–∏—è','—á–∏—Å—Ç—ã–π —Å—Ç–æ–ª','–Ω–æ–≤—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','—Ç–∞–π–º–µ—Ä –Ω–∞ 5 –º–∏–Ω—É—Ç','–ø–∏—â–∞ –¥–ª—è —É–º–∞','—Å–æ–Ω –¥–Ω—ë–º','—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–∞ —Ä–∞—Å—Ç—è–∂–∫—É','–≤–¥–æ—Ö —á–µ—Ä–µ–∑ –Ω–æ—Å','–º–æ–ª—á–∞–ª–∏–≤–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ'],
      tails=['–≤ –ø–æ–¥–∞—Ä–æ–∫','–≤ 3 —á–∞—Å–∞ –Ω–æ—á–∏','–ø–æ –ø–æ–¥–ø–∏—Å–∫–µ','–Ω–∞ —Å–∫–æ—Ä—É—é —Ä—É–∫—É','–≤ —Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ','–±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π','—Å –¥–æ—Å—Ç–∞–≤–∫–æ–π –∑–∞–≤—Ç—Ä–∞','–ø–æ –ª—é–±–≤–∏','–Ω–∞ —É–¥–∞–ª—ë–Ω–∫–µ','—Å –∑–∞–∫—Ä—ã—Ç—ã–º–∏ –≥–ª–∞–∑–∞–º–∏','—Å –æ–¥–æ–±—Ä–µ–Ω–∏—è –∫–æ—Ç–∞','–≤–º–µ—Å—Ç–æ —Å–ø–æ—Ä—Ç–∞','–≤ —Ö–æ—Ä–æ—à–µ–º —Å–º—ã—Å–ª–µ','–±–µ–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏','—Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ —É—Å–∏–ª–∏—è–º–∏','–≤ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–µ–∫—É–Ω–¥—É','—Å –≤–∏–¥–æ–º –Ω–∞ –∫—É—Ö–Ω—é','–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ä–∞–∑—É–º–Ω–æ–≥–æ','–Ω–∞ –ø–æ–ª–Ω–æ–º —Å–µ—Ä—å—ë–∑–µ','–¥–ª—è –≥–∞–ª–æ—á–∫–∏','—Å –æ–≥–æ–Ω—å–∫–æ–º','–ø–æ –≤—ã—Ö–æ–¥–Ω—ã–º','–¥–ª—è –¥—É—à–∏','–ø–æ–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ','–∫–∞–∫-–Ω–∏–±—É–¥—å –ø–æ—Ç–æ–º','–ø–æ –ø—Ä–∏–∫–æ–ª—É','–ø–æ —Å—Ç–∞—Ä–æ–π –ø–∞–º—è—Ç–∏','–±–µ–∑ –ø—Ä–∏—á–∏–Ω'],
      seeds=['–ú–æ–π –¥–µ–Ω—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å ____.','–ù–∞ —Å–æ–≤–µ—â–∞–Ω–∏–∏ –ª—É—á—à–µ –Ω–µ –æ–±—Å—É–∂–¥–∞—Ç—å ____.','–°–µ–∫—Ä–µ—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî ____.','–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –ø–ª–∞–Ω: –∫–æ—Ñ–µ, –¥–µ–ª–∞ –∏ ____.','–°–∞–º—ã–π —Å—Ç—Ä–∞–Ω–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ ‚Äî ____.','–Ø –±—ã —Å —Ä–∞–¥–æ—Å—Ç—å—é –∑–∞–º–µ–Ω–∏–ª(–∞) –≥–∏–º–Ω –Ω–∞ ____.','–ö–æ–≥–¥–∞ –Ω–∏–∫—Ç–æ –Ω–µ –≤–∏–¥–∏—Ç, —è –ø—Ä–∞–∫—Ç–∏–∫—É—é ____.','–õ—É—á—à–µ–µ, —á—Ç–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ —Ä–µ–∑—é–º–µ ‚Äî ____.','–ò–¥–µ–∞–ª—å–Ω–æ–µ –∞–ª–∏–±–∏: ____.','–ì–ª–∞–≤–Ω—ã–π –∞–Ω—Ç–∏—Å—Ç—Ä–µ—Å—Å ‚Äî ____.','–°–ø–æ—Ä–∏–º, –≤ 2035 –º—ã –±—É–¥–µ–º –ø–ª–∞—Ç–∏—Ç—å –∑–∞ ____.','–í –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–º —á–∞—Ç–µ –∑–∞–±–∞–Ω–∏–ª–∏ —Ç–µ–º—É ____.','–ì–ª–∞–≤–Ω–∞—è —Ñ–∏—á–∞ –Ω–æ–≤–æ–≥–æ –∞–π—Ñ–æ–Ω–∞ ‚Äî ____.','–ï—Å–ª–∏ –±—ã —É –º–µ–Ω—è –±—ã–ª —Å–ª–æ–≥–∞–Ω, –æ–Ω –±—ã –±—ã–ª –ø—Ä–æ ____.','–ù–∞ TED —è –≤—ã—Å—Ç—É–ø–ª—é –ø—Ä–æ ____.','–ú–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫—Ä–∏—Ç–∏–∫ –æ–±–æ–∂–∞–µ—Ç ____.','–®–µ—Ñ –º–µ—á—Ç–∞–µ—Ç –≤–Ω–µ–¥—Ä–∏—Ç—å ____.','User story –Ω–∞ —Å–µ–≥–æ–¥–Ω—è ‚Äî ____.','–Ø –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –æ—Ç–∫–∞–∑—ã–≤–∞—é—Å—å –æ—Ç ____.','–°–µ–≥–æ–¥–Ω—è –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è –≤—Å—ë, –∫—Ä–æ–º–µ ____.'];
    const needW=Math.max(0,MIN_WHITE-(base.white?.length||0));for(let i=0;i<needW;i++){base.white.push(`${adj[i%adj.length]} ${noun[(i*7)%noun.length]} ${tails[(i*13)%tails.length]}`)}
    const needB=Math.max(0,MIN_BLACK-(base.black?.length||0));for(let i=0;i<needB;i++){base.black.push(seeds[i%seeds.length])}
  }
  function loadDeckLocal(){
    let base,raw=localStorage.getItem(STORAGE_KEY);
    base=raw?(()=>{try{return JSON.parse(raw)}catch{return JSON.parse(JSON.stringify(DEMO_DECK))}})():JSON.parse(JSON.stringify(DEMO_DECK));
    ensureMinimumDeck(base); localStorage.setItem(STORAGE_KEY,JSON.stringify(base));
    game.deck.black=shuffle([...base.black]); game.deck.white=shuffle([...base.white]);
    game.deck.discardBlack=[]; game.deck.discardWhite=[];
  }
  const drawBlack=()=>{if(!game.deck.black.length){game.deck.black=shuffle([...game.deck.discardBlack]);game.deck.discardBlack=[]}return game.deck.black.pop()||'‚Äî'};
  const drawWhite=()=>{if(!game.deck.white.length){game.deck.white=shuffle([...game.deck.discardWhite]);game.deck.discardWhite=[]}return game.deck.white.pop()||'‚Äî'};
  const topUpHand=(hand,t=7)=>{const arr=[...(hand||[])];while(arr.length<t)arr.push(drawWhite());return arr};

  // ===== state
  const game={state:{status:STATUS.LOBBY,round:0,roundsTotal:ROUNDS_TOTAL,blackCard:'',lastWinnerName:'',lastAnswer:'',currentHostPid:null,currentHostName:'',timerEndsAt:null},players:{},playersOrder:[],submissions:{},submissionsOrder:[],deck:{black:[],white:[],discardBlack:[],discardWhite:[]}};
  const local={playerId:localStorage.getItem('playerId')||uid(),roomId:null,name:'',isCreator:false,hasSubmitted:false,selectedIndex:null,selectedText:'',submittedText:'',timerInterval:null,autoPickFired:false,activeHand:[]};
  localStorage.setItem('playerId',local.playerId);

  // ===== firebase
  const FIREBASE_CONFIG={apiKey:"AIzaSyDRtpegXwTsSf77–¥PIOGDIyBFvib_GgUcM".replace('–¥','D'),authDomain:"z-e86ee.firebaseapp.com",databaseURL:"https://z-e86ee-default-rtdb.europe-west1.firebasedatabase.app",projectId:"z-e86ee",storageBucket:"z-e86ee.appspot.com",messagingSenderId:"268263276853",appId:"1:268263276853:web:0195c839f5dd38e7214c7c",measurementId:"G-6ZBVR66GZE"};
  let db=null, firebaseInitError=null, connectivityOk=false, lastConnMsg='';
  try{firebase.initializeApp(FIREBASE_CONFIG);db=firebase.database()}catch(e){firebaseInitError=e;console.error('Firebase init error',e)}

  const roomRef=()=>db.ref(`rooms/${local.roomId}`), stateRef=()=>roomRef().child('state'), playersRef=()=>roomRef().child('players'),
        orderRef=()=>roomRef().child('playersOrder'), submissionsRef=()=>roomRef().child('submissions'),
        perPlayerRef=(pid)=>roomRef().child(`perPlayer/${pid}`), deckRef=()=>roomRef().child('deck'), eventsRef=()=>roomRef().child(EVENTS_PATH);

  async function testDbConnection(){if(!db){lastConnMsg='Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω';updateConnStatus(false,lastConnMsg);return false}
    try{const ping=db.ref('_ping').push();await ping.set({t:now(),ua:navigator.userAgent.slice(0,80)});await ping.remove();lastConnMsg='OK: –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ Realtime DB';updateConnStatus(true,lastConnMsg);return true}
    catch(e){lastConnMsg=normalizeError(e);updateConnStatus(false,lastConnMsg);return false}}
  function updateConnStatus(ok,msg){const el=$('#connStatus');el.textContent='–°—Ç–∞—Ç—É—Å: '+(ok?'–ø–æ–¥–∫–ª—é—á–µ–Ω–æ':'–æ—à–∏–±–∫–∞');el.title=msg||'';el.style.background=ok?'var(--accent-2)':'var(--chip)'}
  function unsubscribeAll(){if(!local.roomId||!db)return;stateRef().off();playersRef().off();orderRef().off();submissionsRef().off();perPlayerRef(local.playerId).off();eventsRef().off();deckRef().off()}

  function orderedPlayerIds(ps){return Object.keys(ps||{}).sort((a,b)=>{const pa=ps[a]||{},pb=ps[b]||{},ja=pa.joinedAt||0,jb=pb.joinedAt||0;return ja!==jb?ja-jb:a.localeCompare(b)})}
  function activeOrder(){const ps=game.players||{};return (game.playersOrder||[]).filter(id=>ps[id]?.active!==false)}
  function activePlayersCount(){return Object.values(game.players||{}).filter(p=>p&&p.active!==false).length}
  function nextHostId(order,current){if(!Array.isArray(order)||!order.length)return null;if(!current)return order[0];const i=order.indexOf(current);return i===-1?order[0]:order[(i+1)%order.length]}
  function expectedSubmissions(){return Math.max(0,activeOrder().length-1)}

  function subscribeRoom(){if(!db||!local.roomId)return;
    unsubscribeAll();
    stateRef().on('value',s=>{const v=s.val();if(!v)return;game.state=v;renderState();startTimerTick()});
    playersRef().on('value',s=>{const v=s.val()||{};game.players=v;renderPlayers();if(local.isCreator)syncPlayersOrder();ensureHostValidity();updateProgressChip();if(AUTO_START)maybeAutoStart()});
    orderRef().on('value',s=>{const v=s.val();if(Array.isArray(v)){game.playersOrder=v;ensureHostValidity();updateProgressChip();if(AUTO_START)maybeAutoStart()}});
    submissionsRef().on('value',s=>{renderSubmissions(s.val()||{})});
    perPlayerRef(local.playerId).on('value',s=>{const d=s.val()||{hand:[],submitted:false,lastText:''};local.activeHand=d.hand||[];local.hasSubmitted=!!d.submitted;local.submittedText=d.lastText||'';renderHand(local.activeHand);updateHandState();updateActionBar()});
    if(local.isCreator){deckRef().on('value',s=>{const d=s.val();if(d){game.deck.black=d.black||[];game.deck.white=d.white||[];game.deck.discardBlack=d.discardBlack||[];game.deck.discardWhite=d.discardWhite||[]}});eventsRef().on('child_added',handleHostEvent)}
  }

  // ===== create / join
  function showScreen(id){['screenCreate','screenNameOnly','screenGame'].forEach(s=>$('#'+s).classList.remove('active'));$('#'+id).classList.add('active')}
  function enterGameUI(){showScreen('screenGame');if(local.isCreator){$('#shareRow').style.display='flex';updateShareLink()}else $('#shareRow').style.display='none'}
  function updateShareLink(){const url=new URL(location.href);url.searchParams.set('room',local.roomId);$('#shareLink').value=url.toString();history.replaceState(null,'',url)}
  function validateName(v){const t=(v||'').trim();if(t.length<2)throw new Error('–ò–º—è —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ.');if(/^[0-9]+$/.test(t))throw new Error('–ò–º—è –Ω–µ –º–æ–∂–µ—Ç —Å–æ—Å—Ç–æ—è—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ —Ü–∏—Ñ—Ä.');return t.slice(0,24)}

  async function registerPlayer(name){
    const safe=name||localStorage.getItem('playerName')||`–ò–≥—Ä–æ–∫ ${local.playerId.slice(-4)}`;
    local.name=safe; localStorage.setItem('playerName',safe);
    const ref=playersRef().child(local.playerId);
    await ref.set({name:safe,score:0,joinedAt:now(),active:true,isCreator:local.isCreator});
    await ref.onDisconnect().update({active:false,leftAt:now()});
    await perPlayerRef(local.playerId).set({hand:[],submitted:false,lastText:''});
    await perPlayerRef(local.playerId).onDisconnect().remove();
    if(!local.isCreator){
      // ‚úÖ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π merge –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –≤–µ–¥—É—â–µ–≥–æ/–¥—Ä—É–≥–∏—Ö
      await orderRef().transaction(order=>{
        const base = Array.isArray(order) ? order.slice() : [];
        if(!base.includes(local.playerId)) base.push(local.playerId);
        return base;
      });
      await eventsRef().push({type:'needHand',playerId:local.playerId,t:now()});
    }else{
      await orderRef().set([local.playerId]);
    }
  }

  async function createRoom(){
    if(!db){showError(firebaseInitError||'Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');return}
    if(!(connectivityOk||await testDbConnection()))return;
    try{
      const playerName=validateName($('#createName').value);
      const roomId=($('#createRoomId').value||'').trim().toUpperCase();
      if(roomId.length<4) throw new Error('ID –∫–æ–º–Ω–∞—Ç—ã –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞.');
      local.roomId=roomId; local.isCreator=true;
      loadDeckLocal();
      await roomRef().set({creatorId:local.playerId,createdAt:now()});
      await stateRef().set({status:STATUS.LOBBY,round:0,roundsTotal:ROUNDS_TOTAL,blackCard:'',lastWinnerName:'',lastAnswer:'',currentHostPid:local.playerId,currentHostName:playerName,timerEndsAt:null});
      await deckRef().set({black:game.deck.black,white:game.deck.white,discardBlack:game.deck.discardBlack,discardWhite:game.deck.discardWhite});
      await registerPlayer(playerName);
      subscribeRoom();
      enterGameUI();
      toast('–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞');
    }catch(e){$('#createError').textContent=normalizeError(e);showError(e)}
  }

  async function joinRoomWithNameOnly(){
    if(!db){showError(firebaseInitError||'Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');return}
    if(!(connectivityOk||await testDbConnection()))return;
    try{
      const playerName=validateName($('#nameOnly').value);
      await registerPlayer(playerName);
      subscribeRoom();
      enterGameUI();
      toast('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ');
    }catch(e){$('#nameOnlyError').textContent=normalizeError(e);showError(e)}
  }

  // ===== host events & flow
  async function handleHostEvent(snap){const ev=snap.val(),key=snap.key;if(!ev)return;try{
    if(ev.type==='needHand')await hostGiveHand(ev.playerId);
    if(ev.type==='pickWinner')await hostPickWinner(ev.submissionId);
    if(ev.type==='autoPick')await hostAutoPick(ev.submissionId||null);
    if(ev.type==='nextRound')await advanceRound();
  }catch(e){showError(e)}finally{eventsRef().child(key).remove()}}
  async function hostGiveHand(pid){if(!pid)return;const player=(await playersRef().child(pid).get()).val();if(!player||player.active===false)return;const currentHost=game.state.currentHostPid;
    const snap=await perPlayerRef(pid).get();const data=snap.val()||{hand:[],submitted:false,lastText:''};
    const shouldHave=pid!==currentHost&&player.active!==false;const hand=shouldHave?topUpHand(data.hand||[]):[];
    await perPlayerRef(pid).set({hand,submitted:false,lastText:''});await deckRef().set({black:game.deck.black,white:game.deck.white,discardBlack:game.deck.discardBlack,discardWhite:game.deck.discardWhite})
  }
  async function hostPickWinner(id){if(!id)return;const s=(await stateRef().get()).val();if(!s||s.status!==STATUS.COLLECT)return;const subs=(await submissionsRef().get()).val()||{};const e=subs[id];if(!e)return;
    await playersRef().child(e.playerId).transaction(d=>{if(!d)return d;return {...d,score:(d.score||0)+1}});
    await collectWhiteToDiscard(subs);const name=game.players[e.playerId]?.name||'‚Äî';
    await stateRef().update({status:STATUS.RESULT,lastWinnerName:name,lastAnswer:e.text,timerEndsAt:null})
  }
  function randomSubmissionKey(subs,rng=Math.random){const keys=Object.keys(subs||{});if(!keys.length)return null;const r=Math.max(0,Math.min(0.999999,typeof rng==='function'?rng():Math.random()));return keys[Math.floor(r*keys.length)]}
  async function hostAutoPick(id){const s=(await stateRef().get()).val();if(!s||s.status!==STATUS.COLLECT)return;const subs=(await submissionsRef().get()).val()||{};const pick=id||randomSubmissionKey(subs);
    if(pick&&subs[pick]){await hostPickWinner(pick)}else{await collectWhiteToDiscard(subs);await stateRef().update({status:STATUS.RESULT,lastWinnerName:'',lastAnswer:'',timerEndsAt:null})}
    updateActionBar()
  }
  async function collectWhiteToDiscard(subs){Object.values(subs||{}).forEach(x=>{if(x&&x.text)game.deck.discardWhite.push(x.text)});await deckRef().set({black:game.deck.black,white:game.deck.white,discardBlack:game.deck.discardBlack,discardWhite:game.deck.discardWhite})}
  async function advanceRound(){
    if(!local.isCreator)return;
    const s=(await stateRef().get()).val()||{}, players=(await playersRef().get()).val()||{}, order=activeOrder();
    if(order.length<MIN_PLAYERS){await stateRef().update({status:STATUS.LOBBY,timerEndsAt:null});toast('–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –∏–≥—Ä–æ–∫–∞');return}
    const baseCurrent=s.status===STATUS.LOBBY?null:s.currentHostPid, hostId=nextHostId(order,baseCurrent), hostName=players[hostId]?.name||'‚Äî';
    if(s.blackCard)game.deck.discardBlack.push(s.blackCard);
    await submissionsRef().remove();
    await Promise.all(order.map(async pid=>{const snap=await perPlayerRef(pid).get();const data=snap.val()||{hand:[],submitted:false,lastText:''};const shouldHave=pid!==hostId;const hand=shouldHave?topUpHand(data.hand||[]):[];await perPlayerRef(pid).set({hand,submitted:false,lastText:''})}));
    const black=drawBlack(), round=s.status===STATUS.LOBBY?1:(s.round||0)+1, timerEndsAt=now()+ROUND_TIMER_SECONDS*1000;
    await stateRef().set({status:STATUS.COLLECT,round,roundsTotal:ROUNDS_TOTAL,blackCard:black,lastWinnerName:'',lastAnswer:'',currentHostPid:hostId,currentHostName:hostName,timerEndsAt});
    await deckRef().set({black:game.deck.black,white:game.deck.white,discardBlack:game.deck.discardBlack,discardWhite:game.deck.discardWhite});
    game.submissionsOrder=[];
  }

  // ===== render
  function buildHandHint(st){if(game.state.currentHostPid===local.playerId)return st===STATUS.COLLECT?'–í—ã –≤–µ–¥—É—â–∏–π ‚Äî –æ–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç—ã –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è.':'–í—ã —É–ø—Ä–∞–≤–ª—è–µ—Ç–µ —Ö–æ–¥–æ–º –∏–≥—Ä—ã.';if(st===STATUS.LOBBY)return'–û–∂–∏–¥–∞–µ–º —Å—Ç–∞—Ä—Ç —Ä–∞—É–Ω–¥–∞.';if(st===STATUS.RESULT)return'–†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à—ë–Ω, –∂–¥—ë–º –Ω–æ–≤—É—é —á—ë—Ä–Ω—É—é –∫–∞—Ä—Ç—É.';if(local.hasSubmitted)return'–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, –∂–¥—ë–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö.';if(local.selectedIndex==null)return'–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∫–∞—Ä—Ç—É –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ.';return'–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å¬ª, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç—É.'}
  function renderState(){
    const st=game.state.status||STATUS.LOBBY;
    $('#blackText').innerHTML=escapeHtml(game.state.blackCard||'‚Äî');
    $('#roleChip').hidden=st===STATUS.LOBBY; $('#roleChip').textContent=game.state.currentHostPid===local.playerId?'–í—ã –≤–µ–¥—É—â–∏–π':'–í—ã –∏–≥—Ä–æ–∫';
    $('#timerChip').hidden=st!==STATUS.COLLECT; $('#progressChip').hidden=st!==STATUS.COLLECT;
    $('#resultBlock').style.display=st===STATUS.RESULT?'block':'none';
    $('#winnerLine').innerHTML=game.state.lastWinnerName?`${escapeHtml(game.state.lastWinnerName)} –ø–æ–ª—É—á–∞–µ—Ç –æ—á–∫–æ –∑–∞ ${fillBlack(game.state.blackCard||'',game.state.lastAnswer||'')}`:'–í —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ –Ω–µ –±—ã–ª–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è.';
    $('#resultHint').textContent=game.state.currentHostPid===local.playerId?'–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥.':'–ñ–¥—ë–º —Ç–µ–∫—É—â–µ–≥–æ –≤–µ–¥—É—â–µ–≥–æ.';
    $('#hostSummary').textContent=st===STATUS.LOBBY?'–û–∂–∏–¥–∞–µ–º –∏–≥—Ä–æ–∫–æ–≤.':st===STATUS.COLLECT?`–í–µ–¥—É—â–∏–π: ${escapeHtml(game.state.currentHostName||'‚Äî')}`:'–†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à—ë–Ω.';
    $('#handHint').textContent=buildHandHint(st);

    // ‚úÖ —Å—á–∏—Ç–∞–µ–º –∏–º–µ–Ω–Ω–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –ø–æ game.players (UI –≤—Å–µ–≥–¥–∞ –≤–µ—Ä–µ–Ω)
    const count = activePlayersCount();
    const canStart = local.isCreator && st===STATUS.LOBBY;
    const lobby=$('#lobbyActions'), hint=$('#lobbyHint');
    if(lobby){
      lobby.style.display=canStart?'flex':'none';
      hint.textContent = count<MIN_PLAYERS
        ? `–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º ${MIN_PLAYERS} –∏–≥—Ä–æ–∫–∞(–æ–≤). –°–µ–π—á–∞—Å: ${count}.`
        : `–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å. –ò–≥—Ä–æ–∫–æ–≤: ${count}.`;
      $('#btnStartGame').disabled = !(count>=MIN_PLAYERS);
    }

    updateProgressChip();
  }
  function renderPlayers(){
    const list=$('#playersList');list.innerHTML='';const players=game.players||{}, ordered=orderedPlayerIds(players);
    ordered.forEach(id=>{const d=players[id];const row=document.createElement('div');row.style.cssText='display:flex;align-items:center;justify-content:space-between;padding:8px 0';const tags=[];if(d.isCreator)tags.push('–º–æ–¥–µ—Ä–∞—Ç–æ—Ä');if(id===game.state.currentHostPid)tags.push('–≤–µ–¥—É—â–∏–π');if(d.active===false)tags.push('offline');row.innerHTML=`<div>${escapeHtml(d.name||'–ë–µ–∑—ã–º—è–Ω–Ω—ã–π')}${tags.length?` <span class="small muted">(${tags.join(', ')})</span>`:''}</div><div class="chip">${d.score||0}</div>`;list.appendChild(row)}); if(!ordered.length)list.innerHTML='<div class="muted small">–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç.</div>';
  }
  function renderHand(hand){
    const c=$('#handCards');c.innerHTML='';const disabled=game.state.currentHostPid===local.playerId||game.state.status!==STATUS.COLLECT;
    hand.forEach((text,idx)=>{const b=document.createElement('button');b.type='button';b.className='answer-card'+(disabled?' disabled':' selectable');b.dataset.index=idx;b.innerHTML=`<div style="font-size:18px;line-height:1.5;">${escapeHtml(text)}</div>`;if(!disabled){b.onclick=()=>selectCard(idx,text,b);if(idx===local.selectedIndex)b.classList.add('selected')}c.appendChild(b)});
    if(disabled){local.selectedIndex=null;local.selectedText=''} else if(local.selectedIndex!=null&&local.selectedIndex>=hand.length){local.selectedIndex=null;local.selectedText=''}
    updateActionBar();
  }
  function renderSubmissions(map){
    game.submissions=map||{};const entries=Object.entries(game.submissions),received=entries.length,expected=expectedSubmissions();
    const timerExpired=game.state.timerEndsAt&&now()>=game.state.timerEndsAt;
    const reveal=game.state.status===STATUS.RESULT||(game.state.status===STATUS.COLLECT&&(timerExpired||(expected>0&&received>=expected)));
    const list=$('#submissionsList');list.innerHTML='';const hint=$('#submissionsHint');
    if(!entries.length){hint.textContent=game.state.status===STATUS.COLLECT?'–ö–∞—Ä—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–≥—Ä–æ–∫–∞–º–∏.':'–ù–∞ —Å—Ç–æ–ª–µ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤.';return}
    if(!reveal){hint.textContent='–û—Ç–≤–µ—Ç—ã —Å–∫—Ä—ã—Ç—ã –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–±–æ—Ä–∞.';return}
    hint.textContent=game.state.status===STATUS.COLLECT?'–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è.':'–í–µ–¥—É—â–∏–π –æ–±—ä—è–≤–∏–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç.';
    const prev=Array.isArray(game.submissionsOrder)?game.submissionsOrder.filter(id=>game.submissions[id]):[]; if(prev.length!==entries.length){game.submissionsOrder=shuffle(entries.map(([id])=>id))}
    game.submissionsOrder.forEach(id=>{const it=game.submissions[id];if(!it)return;const b=document.createElement('button');b.type='button';b.className='answer-card';b.innerHTML=`<div class="muted small">–û—Ç–≤–µ—Ç</div><div style="margin-top:8px;font-size:18px;line-height:1.5;">${fillBlack(game.state.blackCard||'',it.text)}</div>`;if(game.state.status===STATUS.COLLECT&&game.state.currentHostPid===local.playerId){b.classList.add('selectable');b.onclick=()=>eventsRef().push({type:'pickWinner',submissionId:id,t:now()})}else b.disabled=true;list.appendChild(b)});
    updateProgressChip();
  }

  // ===== ui actions
  function selectCard(idx,text,btn){if(game.state.status!==STATUS.COLLECT||local.hasSubmitted)return;local.selectedIndex=idx;local.selectedText=text;$$('#handCards .answer-card').forEach(el=>el.classList.remove('selected'));btn?.classList.add('selected');updateHandState();updateActionBar()}
  function updateHandState(){const b=$('#submittedCard');b.style.display=local.hasSubmitted&&local.submittedText?'block':'none';if(local.hasSubmitted&&local.submittedText)$('#submittedText').textContent=local.submittedText}
  function updateProgressChip(){const chip=$('#progressChip');if(game.state.status!==STATUS.COLLECT){chip.hidden=true;return}const expected=expectedSubmissions(),received=Object.keys(game.submissions||{}).length;chip.textContent=`${received}/${expected} –æ—Ç–ø—Ä–∞–≤–∏–ª–∏`;chip.hidden=false}
  function updateActionBar(){const bar=$('#actionBar'),isHost=game.state.currentHostPid===local.playerId,collecting=game.state.status===STATUS.COLLECT;if(!collecting||isHost){bar.classList.add('hidden');return}bar.classList.remove('hidden');if(local.hasSubmitted){$('#actionHint').textContent='–ö–∞—Ä—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –ñ–¥—ë–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö.';$('#btnConfirm').disabled=true}else if(local.selectedIndex==null){$('#actionHint').textContent='–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É –∏–∑ —Ä—É–∫–∏, —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å.';$('#btnConfirm').disabled=true}else{$('#actionHint').textContent='–ì–æ—Ç–æ–≤–æ! –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã.';$('#btnConfirm').disabled=false}}
  function startTimerTick(){clearInterval(local.timerInterval);if(game.state.status!==STATUS.COLLECT||!game.state.timerEndsAt){$('#timerChip').hidden=true;return}$('#timerChip').hidden=false;const up=()=>{const s=Math.max(0,Math.ceil((game.state.timerEndsAt-now())/1000));$('#timerChip').textContent=`‚è± ${s}s`;if(s<=0){clearInterval(local.timerInterval);if(!local.autoPickFired){local.autoPickFired=true;eventsRef().push({type:'autoPick',submissionId:null,t:now()})}}};up();local.timerInterval=setInterval(up,1000);local.autoPickFired=false}
  async function submitCard(){if(game.state.status!==STATUS.COLLECT)return showError('–°–µ–π—á–∞—Å –Ω–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É.');if(game.state.currentHostPid===local.playerId)return showError('–í–µ–¥—É—â–∏–π –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–∞—Ä—Ç—ã.');if(local.hasSubmitted)return showError('–ö–∞—Ä—Ç–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.');if(local.selectedIndex==null)return showError('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É.');const hand=[...local.activeHand],text=hand[local.selectedIndex];if(!text)return showError('–ö–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');hand.splice(local.selectedIndex,1);await perPlayerRef(local.playerId).set({hand,submitted:true,lastText:text});const id=uid();await submissionsRef().child(id).set({playerId:local.playerId,text,createdAt:now()});local.hasSubmitted=true;local.selectedIndex=null;local.selectedText='';local.submittedText=text;updateHandState();updateActionBar();toast('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω')}
  async function nextRound(){if(game.state.currentHostPid!==local.playerId)return showError('–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥ –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤–µ–¥—É—â–∏–π.');await eventsRef().push({type:'nextRound',t:now()})}
  async function startGame(){if(!local.isCreator)return showError('–°—Ç–∞—Ä—Ç—É–µ—Ç –≤–µ–¥—É—â–∏–π.');await advanceRound()}
  function copyToClipboard(text){navigator.clipboard.writeText(text).then(()=>toast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞')).catch(showError)}

  // ===== UI wiring
  function syncUI(){
    $('#btnCreateRoom').onclick=createRoom;
    $('#btnStartGame').onclick=startGame;
    $('#btnNextRound').onclick=nextRound;
    $('#btnConfirm').onclick=submitCard;
    $('#btnCopyLink').onclick=()=>copyToClipboard($('#shareLink').value||'');
    $('#btnNameOnly').onclick=joinRoomWithNameOnly;
    $('#nameOnly').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();$('#btnNameOnly').click()}})
  }

  function setupUI(){
    const params=new URLSearchParams(location.search), room=params.get('room'), savedName=localStorage.getItem('playerName')||'';
    if(room){
      local.roomId=room.toUpperCase(); local.isCreator=false;
      showScreen('screenNameOnly');
      $('#nameOnly').value=savedName;
      stateRef().get().then(snap=>{
        const st=snap.val()||{};
        $('#inviterName').textContent = st.currentHostName ? st.currentHostName : '–≤–µ–¥—É—â–∏–π';
      }).catch(()=>{ $('#inviterName').textContent='–≤–µ–¥—É—â–∏–π' });
      setTimeout(()=>{$focus($('#nameOnly'))},0);
    }else{
      $('#createRoomId').value=(Math.random().toString(36).slice(2,8)).toUpperCase();
      if(savedName) $('#createName').value=savedName;
      showScreen('screenCreate');
      setTimeout(()=>{$focus($('#createName'))},0);
    }
  }

  function renderOnStateChange(){renderState();renderHand(local.activeHand);updateActionBar()}

  function syncPlayersOrder(){
    const players=game.players||{};
    const activeIds=orderedPlayerIds(players).filter(id=>players[id].active!==false);
    const cur=Array.isArray(game.playersOrder)?game.playersOrder:[];
    const merged=[...new Set([...cur.filter(id=>activeIds.includes(id)),...activeIds])];
    if(JSON.stringify(merged)!==JSON.stringify(cur)) orderRef().set(merged);
  }
  function ensureHostValidity(){const order=activeOrder(),cur=game.state.currentHostPid;if(!order.length)return;if(!cur||!order.includes(cur)){const next=order[0],name=game.players[next]?.name||'‚Äî';if(local.isCreator)stateRef().update({currentHostPid:next,currentHostName:name})}}
  function maybeAutoStart(){if(!local.isCreator)return;if(game.state.status!==STATUS.LOBBY)return;if(activePlayersCount()>=MIN_PLAYERS)advanceRound()}

  // ===== boot
  document.addEventListener('DOMContentLoaded',async()=>{
    syncUI(); setupUI();
    setTimeout(async()=>{connectivityOk=await testDbConnection()},400);
    renderOnStateChange();
  });
  </script>
</body>
</html>
